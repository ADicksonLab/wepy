
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>wepy.runners.openmm &#8212; Wepy Documentation</title>
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/custom.css" />
    <script id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <link rel="canonical" href="https://adicksonlab.github.io/wepy/_modules/wepy/runners/openmm.html" />
    <link rel="shortcut icon" href="../../../_static/wepy-icon.ico"/>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
              <div class="related top">
                &nbsp;
  <nav id="rellinks">
    <ul>
    </ul>
  </nav>
              </div>
          

          <div class="body" role="main">
            
  <h1>Source code for wepy.runners.openmm</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;OpenMM molecular dynamics runner with accessory classes.</span>

<span class="sd">OpenMM is a library with support for running molecular dynamics</span>
<span class="sd">simulations with specific support for fast GPU calculations. The</span>
<span class="sd">component based architecture of OpenMM makes it a perfect fit with</span>
<span class="sd">wepy.</span>

<span class="sd">In addition to the principle OpenMMRunner class there are a few</span>
<span class="sd">classes here that make using OpenMM runner more efficient.</span>

<span class="sd">First is a WalkerState class (OpenMMState) that wraps the openmm state</span>
<span class="sd">object directly, itself is a wrapper around the C++</span>
<span class="sd">datastructures. This gives better performance by not performing copies</span>
<span class="sd">to a WalkerState dictionary.</span>

<span class="sd">Second, is the OpenMMWalker which is identical to the Walker class</span>
<span class="sd">except that it enforces the state is an actual instantiation of</span>
<span class="sd">OpenMMState. Use of this is optional.</span>

<span class="sd">Finally, is the OpenMMGPUWorker class. This is to be used as the</span>
<span class="sd">worker type for the WorkerMapper work mapper. This is necessary to</span>
<span class="sd">allow passing of the device index to OpenMM for which GPU device to</span>
<span class="sd">use.</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">copy</span>
<span class="kn">import</span> <span class="nn">random</span> <span class="k">as</span> <span class="nn">rand</span>
<span class="kn">from</span> <span class="nn">warnings</span> <span class="kn">import</span> <span class="n">warn</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="kn">from</span> <span class="nn">eliot</span> <span class="kn">import</span> <span class="n">log_call</span><span class="p">,</span> <span class="n">start_action</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">simtk.openmm.app</span> <span class="k">as</span> <span class="nn">omma</span>
    <span class="kn">import</span> <span class="nn">simtk.openmm</span> <span class="k">as</span> <span class="nn">omm</span>
    <span class="kn">import</span> <span class="nn">simtk.unit</span> <span class="k">as</span> <span class="nn">unit</span>
<span class="k">except</span> <span class="ne">ModuleNotFoundError</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">ModuleNotFoundError</span><span class="p">(</span><span class="s2">&quot;OpenMM has not been installed, which this runner requires.&quot;</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">wepy.walker</span> <span class="kn">import</span> <span class="n">Walker</span><span class="p">,</span> <span class="n">WalkerState</span>
<span class="kn">from</span> <span class="nn">wepy.runners.runner</span> <span class="kn">import</span> <span class="n">Runner</span>
<span class="kn">from</span> <span class="nn">wepy.work_mapper.worker</span> <span class="kn">import</span> <span class="n">Worker</span>
<span class="kn">from</span> <span class="nn">wepy.work_mapper.task_mapper</span> <span class="kn">import</span> <span class="n">WalkerTaskProcess</span>
<span class="kn">from</span> <span class="nn">wepy.reporter.reporter</span> <span class="kn">import</span> <span class="n">Reporter</span>
<span class="kn">from</span> <span class="nn">wepy.util.util</span> <span class="kn">import</span> <span class="n">box_vectors_to_lengths_angles</span>

<span class="c1">## Constants</span>

<span class="n">KEYS</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;positions&#39;</span><span class="p">,</span> <span class="s1">&#39;velocities&#39;</span><span class="p">,</span> <span class="s1">&#39;forces&#39;</span><span class="p">,</span> <span class="s1">&#39;kinetic_energy&#39;</span><span class="p">,</span>
        <span class="s1">&#39;potential_energy&#39;</span><span class="p">,</span> <span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="s1">&#39;box_vectors&#39;</span><span class="p">,</span> <span class="s1">&#39;box_volume&#39;</span><span class="p">,</span>
        <span class="s1">&#39;parameters&#39;</span><span class="p">,</span> <span class="s1">&#39;parameter_derivatives&#39;</span><span class="p">)</span>
<span class="sd">&quot;&quot;&quot;Names of the fields of the OpenMMState.&quot;&quot;&quot;</span>

<span class="c1"># when we use the get_state function from the simulation context we</span>
<span class="c1"># can pass options for what kind of data to get, this is the default</span>
<span class="c1"># to get all the data. TODO not really sure what the &#39;groups&#39; keyword</span>
<span class="c1"># is for though</span>
<span class="n">GET_STATE_KWARG_DEFAULTS</span> <span class="o">=</span> <span class="p">((</span><span class="s1">&#39;getPositions&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span>
                            <span class="p">(</span><span class="s1">&#39;getVelocities&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span>
                            <span class="p">(</span><span class="s1">&#39;getForces&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span>
                            <span class="p">(</span><span class="s1">&#39;getEnergy&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span>
                            <span class="p">(</span><span class="s1">&#39;getParameters&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span>
                            <span class="p">(</span><span class="s1">&#39;getParameterDerivatives&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span>
                            <span class="p">(</span><span class="s1">&#39;enforcePeriodicBox&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">),)</span>
<span class="sd">&quot;&quot;&quot;Mapping of key word arguments to the simulation.context.getState</span>
<span class="sd">method for retrieving data for a simulation state. By default we set</span>
<span class="sd">each as True to retrieve all information. The presence or absence of</span>
<span class="sd">them is handled by the OpenMMState.</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="c1"># the Units objects that OpenMM uses internally and are returned from</span>
<span class="c1"># simulation data</span>

<span class="c1"># TODO: this is never used and we only need the unit names. Its okay</span>
<span class="c1"># to use simtk.units here but other runners should use a units sytem</span>
<span class="c1"># like pint which is easier to install. So we should remove this since</span>
<span class="c1"># its not used.</span>

<span class="c1"># UNITS = ((&#39;positions_unit&#39;, unit.nanometer),</span>
<span class="c1">#          (&#39;time_unit&#39;, unit.picosecond),</span>
<span class="c1">#          (&#39;box_vectors_unit&#39;, unit.nanometer),</span>
<span class="c1">#          (&#39;velocities_unit&#39;, unit.nanometer/unit.picosecond),</span>
<span class="c1">#          (&#39;forces_unit&#39;, unit.kilojoule / (unit.nanometer * unit.mole)),</span>
<span class="c1">#          (&#39;box_volume_unit&#39;, unit.nanometer),</span>
<span class="c1">#          (&#39;kinetic_energy_unit&#39;, unit.kilojoule / unit.mole),</span>
<span class="c1">#          (&#39;potential_energy_unit&#39;, unit.kilojoule / unit.mole),</span>
<span class="c1">#         )</span>
<span class="c1"># &quot;&quot;&quot;Mapping of units identifiers to the corresponding simtk.units Unit objects.&quot;&quot;&quot;</span>

<span class="c1"># the names of the units from the units objects above. This is used</span>
<span class="c1"># for saving them to files</span>
<span class="n">UNIT_NAMES</span> <span class="o">=</span> <span class="p">((</span><span class="s1">&#39;positions_unit&#39;</span><span class="p">,</span> <span class="n">unit</span><span class="o">.</span><span class="n">nanometer</span><span class="o">.</span><span class="n">get_name</span><span class="p">()),</span>
         <span class="p">(</span><span class="s1">&#39;time_unit&#39;</span><span class="p">,</span> <span class="n">unit</span><span class="o">.</span><span class="n">picosecond</span><span class="o">.</span><span class="n">get_name</span><span class="p">()),</span>
         <span class="p">(</span><span class="s1">&#39;box_vectors_unit&#39;</span><span class="p">,</span> <span class="n">unit</span><span class="o">.</span><span class="n">nanometer</span><span class="o">.</span><span class="n">get_name</span><span class="p">()),</span>
         <span class="p">(</span><span class="s1">&#39;velocities_unit&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">unit</span><span class="o">.</span><span class="n">nanometer</span><span class="o">/</span><span class="n">unit</span><span class="o">.</span><span class="n">picosecond</span><span class="p">)</span><span class="o">.</span><span class="n">get_name</span><span class="p">()),</span>
         <span class="p">(</span><span class="s1">&#39;forces_unit&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">unit</span><span class="o">.</span><span class="n">kilojoule</span> <span class="o">/</span> <span class="p">(</span><span class="n">unit</span><span class="o">.</span><span class="n">nanometer</span> <span class="o">*</span> <span class="n">unit</span><span class="o">.</span><span class="n">mole</span><span class="p">))</span><span class="o">.</span><span class="n">get_name</span><span class="p">()),</span>
         <span class="p">(</span><span class="s1">&#39;box_volume_unit&#39;</span><span class="p">,</span> <span class="n">unit</span><span class="o">.</span><span class="n">nanometer</span><span class="o">.</span><span class="n">get_name</span><span class="p">()),</span>
         <span class="p">(</span><span class="s1">&#39;kinetic_energy_unit&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">unit</span><span class="o">.</span><span class="n">kilojoule</span> <span class="o">/</span> <span class="n">unit</span><span class="o">.</span><span class="n">mole</span><span class="p">)</span><span class="o">.</span><span class="n">get_name</span><span class="p">()),</span>
         <span class="p">(</span><span class="s1">&#39;potential_energy_unit&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">unit</span><span class="o">.</span><span class="n">kilojoule</span> <span class="o">/</span> <span class="n">unit</span><span class="o">.</span><span class="n">mole</span><span class="p">)</span><span class="o">.</span><span class="n">get_name</span><span class="p">()),</span>
        <span class="p">)</span>
<span class="sd">&quot;&quot;&quot;Mapping of unit identifier strings to the serialized string spec of the unit.&quot;&quot;&quot;</span>

<span class="c1"># a random seed will be chosen from 1 to RAND_SEED_RANGE_MAX when the</span>
<span class="c1"># Langevin integrator is created. 0 is the default and special value</span>
<span class="c1"># which will then choose a random value when the integrator is created</span>

<span class="c1"># TODO: test this isn&#39;t needed</span>
<span class="c1"># RAND_SEED_RANGE_MAX = 1000000</span>

<span class="c1"># the runner for the simulation which runs the actual dynamics</span>
<div class="viewcode-block" id="OpenMMRunner"><a class="viewcode-back" href="../../../_api/wepy.runners.openmm.html#wepy.runners.openmm.OpenMMRunner">[docs]</a><span class="k">class</span> <span class="nc">OpenMMRunner</span><span class="p">(</span><span class="n">Runner</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Runner for OpenMM simulations.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">system</span><span class="p">,</span> <span class="n">topology</span><span class="p">,</span> <span class="n">integrator</span><span class="p">,</span>
                 <span class="n">platform</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">platform_kwargs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">enforce_box</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Constructor for OpenMMRunner.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        system : simtk.openmm.System object</span>
<span class="sd">            The system (forcefields) for the simulation.</span>

<span class="sd">        topology : simtk.openmm.app.Topology object</span>
<span class="sd">            The topology for you system.</span>

<span class="sd">        integrator : subclass simtk.openmm.Integrator object</span>
<span class="sd">            Integrator for propagating dynamics.</span>

<span class="sd">        platform : str</span>
<span class="sd">            The specification for the default computational platform</span>
<span class="sd">            to use. Platform can also be set when run_segment is</span>
<span class="sd">            called. If None uses OpenMM default platform, see OpenMM</span>
<span class="sd">            documentation for all value but typical ones are:</span>
<span class="sd">            Reference, CUDA, OpenCL. If value is None the automatic</span>
<span class="sd">            platform determining mechanism in OpenMM will be used.</span>

<span class="sd">        platform_kwargs : dict of str : bool, optional</span>
<span class="sd">            key-values to set for a platform with</span>
<span class="sd">            platform.setPropertyDefaultValue as the default for this</span>
<span class="sd">            runner.</span>

<span class="sd">        enforce_box : bool</span>
<span class="sd">            Calls &#39;context.getState&#39; with &#39;enforcePeriodicBox&#39; if True.</span>
<span class="sd">             (Default value = False)</span>

<span class="sd">        Warnings</span>
<span class="sd">        --------</span>

<span class="sd">        Regarding the &#39;enforce_box&#39; option.</span>

<span class="sd">        When retrieving states from an OpenMM simulation Context, you</span>
<span class="sd">        have the option to enforce periodic boundary conditions in the</span>
<span class="sd">        resulting atomic positions in a topology aware way that</span>
<span class="sd">        doesn&#39;t break bonds through boundaries. This is convenient for</span>
<span class="sd">        post-processing as this can be a complex task and is not</span>
<span class="sd">        readily exposed in the OpenMM API as a standalone function.</span>

<span class="sd">        However, in some types of simulations the periodic box vectors</span>
<span class="sd">        are ignored (such as implicit solvent ones) despite there</span>
<span class="sd">        being no option to not have periodic boundaries in the context</span>
<span class="sd">        itself. Likely if you are running one of these kinds of</span>
<span class="sd">        simulations you will not pay attention to the box vectors at</span>
<span class="sd">        all and the random defaults that exist will be very wrong but</span>
<span class="sd">        this incorrectness will not show in a non-wepy simulation with</span>
<span class="sd">        openmm unless you are handling the context states</span>
<span class="sd">        yourself. Then when you run in wepy the default of True to</span>
<span class="sd">        enforce the boxes will be applied and confusingly wrong</span>
<span class="sd">        answers will result that are difficult to find root cause of.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">platform</span><span class="p">,</span> <span class="nb">str</span><span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;platform should be a string, not </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">platform</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="c1"># we save the different components. However, if we are to make</span>
        <span class="c1"># this runner picklable we have to convert the SWIG objects to</span>
        <span class="c1"># a picklable form</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">system</span> <span class="o">=</span> <span class="n">system</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">integrator</span> <span class="o">=</span> <span class="n">integrator</span>

        <span class="c1"># these are not SWIG objects</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">topology</span> <span class="o">=</span> <span class="n">topology</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">platform_name</span> <span class="o">=</span> <span class="n">platform</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">platform_kwargs</span> <span class="o">=</span> <span class="n">platform_kwargs</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">enforce_box</span> <span class="o">=</span> <span class="n">enforce_box</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">getState_kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">GET_STATE_KWARG_DEFAULTS</span><span class="p">)</span>
        <span class="c1"># update with the user based enforce_box</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">getState_kwargs</span><span class="p">[</span><span class="s1">&#39;enforcePeriodicBox&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">enforce_box</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_cycle_platform</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cycle_platform_kwargs</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># for special monitoring purposes to get split times to debug</span>
        <span class="c1"># performance</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_last_cycle_segments_split_times</span> <span class="o">=</span> <span class="p">[]</span>

<div class="viewcode-block" id="OpenMMRunner.pre_cycle"><a class="viewcode-back" href="../../../_api/wepy.runners.openmm.html#wepy.runners.openmm.OpenMMRunner.pre_cycle">[docs]</a>    <span class="nd">@log_call</span><span class="p">(</span><span class="n">include_args</span><span class="o">=</span><span class="p">[</span>
        <span class="s1">&#39;platform&#39;</span><span class="p">,</span>
        <span class="s1">&#39;platform_kwargs&#39;</span><span class="p">,</span>
    <span class="p">],</span>
              <span class="n">include_result</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">pre_cycle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                  <span class="n">platform</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                  <span class="n">platform_kwargs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                  <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">):</span>

        <span class="c1"># choose to use the platform spec in this function call or to</span>
        <span class="c1"># use the default one saved in the runner</span>

        <span class="c1"># if the platform is given locally use this one</span>
        <span class="k">if</span> <span class="n">platform</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Setting the platform (</span><span class="si">{</span><span class="n">platform</span><span class="si">}</span><span class="s2">) in the &#39;pre_cycle&#39; OpenMM Runner call&quot;</span>
                         <span class="sa">f</span><span class="s2">&quot;with platform kwargs: </span><span class="si">{</span><span class="n">platform_kwargs</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="c1"># set the platform and kwargs for this cycle</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cycle_platform</span> <span class="o">=</span> <span class="n">platform</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cycle_platform_kwargs</span> <span class="o">=</span> <span class="n">platform_kwargs</span>

        <span class="c1"># otherwise we just don&#39;t set this and let resolution of</span>
        <span class="c1"># platform happen at run segment.</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">pre_cycle</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>


        <span class="c1"># each segment split times will get appended to this</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_last_cycle_segments_split_times</span> <span class="o">=</span> <span class="p">[]</span></div>


<div class="viewcode-block" id="OpenMMRunner.post_cycle"><a class="viewcode-back" href="../../../_api/wepy.runners.openmm.html#wepy.runners.openmm.OpenMMRunner.post_cycle">[docs]</a>    <span class="nd">@log_call</span><span class="p">(</span><span class="n">include_args</span><span class="o">=</span><span class="p">[],</span>
              <span class="n">include_result</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">post_cycle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">post_cycle</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># remove the platform and kwargs for this cycle</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cycle_platform</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cycle_platform_kwargs</span> <span class="o">=</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="OpenMMRunner._resolve_platform"><a class="viewcode-back" href="../../../_api/wepy.runners.openmm.html#wepy.runners.openmm.OpenMMRunner._resolve_platform">[docs]</a>    <span class="k">def</span> <span class="nf">_resolve_platform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                          <span class="n">platform</span><span class="p">,</span>
                          <span class="n">platform_kwargs</span><span class="p">,</span>
        <span class="p">):</span>
        <span class="c1"># resolve which platform to use</span>

        <span class="c1"># force usage of environmental one</span>
        <span class="k">if</span> <span class="n">platform</span> <span class="ow">is</span> <span class="bp">Ellipsis</span><span class="p">:</span>
            <span class="n">platform_name</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">platform_kwargs</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># use the runtime given one</span>
        <span class="k">elif</span> <span class="n">platform</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">platform_name</span> <span class="o">=</span> <span class="n">platform</span>
            <span class="n">platform_kwargs</span> <span class="o">=</span> <span class="n">platform_kwargs</span>

        <span class="c1"># if the pre_cycle configured platform is set use this over</span>
        <span class="c1"># the default</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cycle_platform</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">platform_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cycle_platform</span>
            <span class="n">platform_kwargs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cycle_platform_kwargs</span>

        <span class="c1"># use the default one</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">platform_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">platform_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">platform_name</span>
            <span class="n">platform_kwargs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">platform_kwargs</span>

        <span class="c1"># if the default is not set fall back to the environmental one</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">platform_name</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">platform_kwargs</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">return</span> <span class="n">platform_name</span><span class="p">,</span> \
               <span class="n">platform_kwargs</span><span class="p">,</span></div>

<div class="viewcode-block" id="OpenMMRunner.run_segment"><a class="viewcode-back" href="../../../_api/wepy.runners.openmm.html#wepy.runners.openmm.OpenMMRunner.run_segment">[docs]</a>    <span class="nd">@log_call</span><span class="p">(</span>
        <span class="n">include_args</span><span class="o">=</span><span class="p">[</span>
            <span class="s1">&#39;segment_length&#39;</span><span class="p">,</span>
            <span class="s1">&#39;getState_kwargs&#39;</span><span class="p">,</span>
            <span class="s1">&#39;platform&#39;</span><span class="p">,</span>
            <span class="s1">&#39;platform_kwargs&#39;</span><span class="p">,</span>
        <span class="p">],</span>
        <span class="n">include_result</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">def</span> <span class="nf">run_segment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                    <span class="n">walker</span><span class="p">,</span>
                    <span class="n">segment_length</span><span class="p">,</span>
                    <span class="n">getState_kwargs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">platform</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">platform_kwargs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Run dynamics for the walker.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        walker : object implementing the Walker interface</span>
<span class="sd">            The walker for which dynamics will be propagated.</span>

<span class="sd">        segment_length : int or float</span>
<span class="sd">            The numerical value that specifies how much dynamics are to be run.</span>

<span class="sd">        getState_kwargs : dict of str : bool, optional</span>
<span class="sd">            Specify the key-word arguments to pass to</span>
<span class="sd">            simulation.context.getState when getting simulation</span>
<span class="sd">            states. If None defaults object values.</span>

<span class="sd">        platform : str or None or Ellipsis</span>
<span class="sd">            The specification for the computational platform to</span>
<span class="sd">            use. If None will use the default for the runner and</span>
<span class="sd">            ignore platform_kwargs. If Ellipsis forces the use of the</span>
<span class="sd">            OpenMM default or environmentally defined platform. See</span>
<span class="sd">            OpenMM documentation for all value but typical ones are:</span>
<span class="sd">            Reference, CUDA, OpenCL. If value is None the automatic</span>
<span class="sd">            platform determining mechanism in OpenMM will be used.</span>

<span class="sd">        platform_kwargs : dict of str : bool, optional</span>
<span class="sd">            key-values to set for a platform with</span>
<span class="sd">            platform.setPropertyDefaultValue for this segment only.</span>


<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        new_walker : object implementing the Walker interface</span>
<span class="sd">            Walker after dynamics was run, only the state should be modified.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">run_segment_start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

        <span class="c1"># set the kwargs that will be passed to getState</span>
        <span class="n">tmp_getState_kwargs</span> <span class="o">=</span> <span class="n">getState_kwargs</span>

        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Default &#39;getState_kwargs&#39; in runner: &quot;</span>
                     <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">getState_kwargs</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;&#39;getState_kwargs&#39; passed to &#39;run_segment&#39; : &quot;</span>
                     <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">getState_kwargs</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># start with the object value</span>
        <span class="n">getState_kwargs</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getState_kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">tmp_getState_kwargs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">getState_kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">tmp_getState_kwargs</span><span class="p">)</span>

        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;After resolving &#39;getState_kwargs&#39; that will be used are: &quot;</span>
                     <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">getState_kwargs</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>


        <span class="n">gen_sim_start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

        <span class="c1"># make a copy of the integrator for this particular segment</span>
        <span class="n">new_integrator</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">integrator</span><span class="p">)</span>
        <span class="c1"># force setting of random seed to 0, which is a special</span>
        <span class="c1"># value that forces the integrator to choose another</span>
        <span class="c1"># random number</span>
        <span class="n">new_integrator</span><span class="o">.</span><span class="n">setRandomNumberSeed</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1">## Platform</span>

        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Default &#39;platform&#39; in runner: &quot;</span>
                     <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">platform_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;pre_cycle set &#39;platform&#39; in runner: &quot;</span>
                     <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_cycle_platform</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;&#39;platform&#39; passed to &#39;run_segment&#39; : &quot;</span>
                     <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">platform</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Default &#39;platform_kwargs&#39; in runner: &quot;</span>
                     <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">platform_kwargs</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;pre_cycle set &#39;platform_kwargs&#39; in runner: &quot;</span>
                     <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_cycle_platform_kwargs</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>


        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;&#39;platform_kwargs&#39; passed to &#39;run_segment&#39; : &quot;</span>
                     <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">platform_kwargs</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">platform_name</span><span class="p">,</span> <span class="n">platform_kwargs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resolve_platform</span><span class="p">(</span>
            <span class="n">platform</span><span class="p">,</span> <span class="n">platform_kwargs</span>
        <span class="p">)</span>


        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Resolved &#39;platform&#39; : &quot;</span>
                     <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">platform_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Resolved &#39;platform_kwargs&#39; : &quot;</span>
                     <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">platform_kwargs</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>



        <span class="c1"># create simulation object</span>

        <span class="c1">## create the platform and customize</span>



        <span class="c1"># if a platform was given we use it to make a Simulation object</span>
        <span class="k">if</span> <span class="n">platform_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Using platform configured in code.&quot;</span><span class="p">)</span>

            <span class="c1"># get the platform by its name to use</span>
            <span class="n">platform</span> <span class="o">=</span> <span class="n">omm</span><span class="o">.</span><span class="n">Platform</span><span class="o">.</span><span class="n">getPlatformByName</span><span class="p">(</span><span class="n">platform_name</span><span class="p">)</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Platform object created: </span><span class="si">{</span><span class="n">platform</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">platform_kwargs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">platform_kwargs</span> <span class="o">=</span> <span class="p">{}</span>

            <span class="c1"># set properties from the kwargs if they apply to the platform</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">platform_kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>

                <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">platform</span><span class="o">.</span><span class="n">getPropertyNames</span><span class="p">():</span>

                    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Setting platform property: </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2"> : </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">platform</span><span class="o">.</span><span class="n">setPropertyDefaultValue</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Platform kwargs given (</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2"> : </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2">) &quot;</span>
                         <span class="sa">f</span><span class="s2">&quot;but is not valid for this platform (</span><span class="si">{</span><span class="n">platform_name</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>

            <span class="c1"># make a new simulation object</span>
            <span class="n">simulation</span> <span class="o">=</span> <span class="n">omma</span><span class="o">.</span><span class="n">Simulation</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">topology</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">system</span><span class="p">,</span>
                                         <span class="n">new_integrator</span><span class="p">,</span> <span class="n">platform</span><span class="p">)</span>

        <span class="c1"># otherwise just use the default or environmentally defined one</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Using environmental platform.&quot;</span><span class="p">)</span>
            <span class="n">simulation</span> <span class="o">=</span> <span class="n">omma</span><span class="o">.</span><span class="n">Simulation</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">topology</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">system</span><span class="p">,</span>
                                         <span class="n">new_integrator</span><span class="p">)</span>

        <span class="c1"># set the state to the context from the walker</span>
        <span class="n">simulation</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">setState</span><span class="p">(</span><span class="n">walker</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">sim_state</span><span class="p">)</span>

        <span class="n">gen_sim_end</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">gen_sim_time</span> <span class="o">=</span> <span class="n">gen_sim_end</span> <span class="o">-</span> <span class="n">gen_sim_start</span>

        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Time to generate the system: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">gen_sim_time</span><span class="p">))</span>


        <span class="c1"># actually run the simulation</span>

        <span class="n">steps_start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

        <span class="c1"># Run the simulation segment for the number of time steps</span>
        <span class="k">with</span> <span class="n">start_action</span><span class="p">(</span><span class="n">action_type</span><span class="o">=</span><span class="s2">&quot;OpenMM Simulation.steps&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">ommsim_cx</span><span class="p">:</span>
            <span class="n">simulation</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">segment_length</span><span class="p">)</span>

        <span class="n">steps_end</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">steps_time</span> <span class="o">=</span> <span class="n">steps_end</span> <span class="o">-</span> <span class="n">steps_start</span>


        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Time to run </span><span class="si">{}</span><span class="s2"> sim steps: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">segment_length</span><span class="p">,</span> <span class="n">steps_time</span><span class="p">))</span>


        <span class="n">get_state_start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>


        <span class="n">get_state_end</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">get_state_time</span> <span class="o">=</span> <span class="n">get_state_end</span> <span class="o">-</span> <span class="n">get_state_start</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Getting context state time: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">get_state_time</span><span class="p">))</span>


        <span class="c1"># generate the new state/walker</span>
        <span class="n">new_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_state</span><span class="p">(</span><span class="n">simulation</span><span class="p">,</span> <span class="n">segment_length</span><span class="p">,</span>
                                        <span class="n">walker</span><span class="p">,</span> <span class="n">getState_kwargs</span><span class="p">)</span>

        <span class="c1"># create a new walker for this</span>
        <span class="n">new_walker</span> <span class="o">=</span> <span class="n">OpenMMWalker</span><span class="p">(</span><span class="n">new_state</span><span class="p">,</span> <span class="n">walker</span><span class="o">.</span><span class="n">weight</span><span class="p">)</span>

        <span class="n">run_segment_end</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">run_segment_time</span> <span class="o">=</span> <span class="n">run_segment_end</span> <span class="o">-</span> <span class="n">run_segment_start</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Total internal run_segment time: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">run_segment_time</span><span class="p">))</span>


        <span class="n">segment_split_times</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;gen_sim_time&#39;</span> <span class="p">:</span>  <span class="n">gen_sim_time</span><span class="p">,</span>
            <span class="s1">&#39;steps_time&#39;</span> <span class="p">:</span> <span class="n">steps_time</span><span class="p">,</span>
            <span class="s1">&#39;get_state_time&#39;</span> <span class="p">:</span> <span class="n">get_state_time</span><span class="p">,</span>
            <span class="s1">&#39;run_segment_time&#39;</span> <span class="p">:</span> <span class="n">run_segment_time</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_last_cycle_segments_split_times</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">segment_split_times</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">new_walker</span></div>

<div class="viewcode-block" id="OpenMMRunner.generate_state"><a class="viewcode-back" href="../../../_api/wepy.runners.openmm.html#wepy.runners.openmm.OpenMMRunner.generate_state">[docs]</a>    <span class="nd">@log_call</span><span class="p">(</span><span class="n">include_args</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;getState_kwargs&#39;</span><span class="p">],</span>
              <span class="n">include_result</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">generate_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">simulation</span><span class="p">,</span> <span class="n">segment_length</span><span class="p">,</span> <span class="n">starting_walker</span><span class="p">,</span> <span class="n">getState_kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Method for generating a wepy compliant state from an OpenMM</span>
<span class="sd">        simulation object and data about the last segment of dynamics run.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        simulation : simtk.openmm.app.Simulation object</span>
<span class="sd">            A complete simulation object from which the state will be extracted.</span>

<span class="sd">        segment_length : int</span>
<span class="sd">            The number of integration steps run in a segment of simulation.</span>

<span class="sd">        starting_walker : wepy.walker.Walker subclass object</span>
<span class="sd">            The walker that was the beginning of this segment of simyulation.</span>

<span class="sd">        getState_kwargs : dict of str : bool</span>
<span class="sd">            Specify the key-word arguments to pass to</span>
<span class="sd">            simulation.context.getState when getting simulation</span>
<span class="sd">            states.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        new_state : wepy.runners.openmm.OpenMMState object</span>
<span class="sd">            A new state from the simulation state.</span>

<span class="sd">        This method is meant to be called from within the</span>
<span class="sd">        `run_segment` method during a simulation. It can be customized</span>
<span class="sd">        in subclasses to allow for the addition of custom attributes</span>
<span class="sd">        for a state, in addition to the base ones implemented in the</span>
<span class="sd">        interface to the openmm simulation state in OpenMMState.</span>

<span class="sd">        The extra arguments to this function are data that would allow</span>
<span class="sd">        for the calculation of integral values over the duration of</span>
<span class="sd">        the segment, such as time elapsed and differences from the</span>
<span class="sd">        starting state.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># save the state of the system with all possible values</span>
        <span class="n">new_sim_state</span> <span class="o">=</span> <span class="n">simulation</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">getState</span><span class="p">(</span><span class="o">**</span><span class="n">getState_kwargs</span><span class="p">)</span>

        <span class="c1"># make an OpenMMState wrapper with this</span>
        <span class="n">new_state</span> <span class="o">=</span> <span class="n">OpenMMState</span><span class="p">(</span><span class="n">new_sim_state</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">new_state</span></div></div>


<div class="viewcode-block" id="OpenMMState"><a class="viewcode-back" href="../../../_api/wepy.runners.openmm.html#wepy.runners.openmm.OpenMMState">[docs]</a><span class="k">class</span> <span class="nc">OpenMMState</span><span class="p">(</span><span class="n">WalkerState</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Walker state that wraps an simtk.openmm.State object.</span>

<span class="sd">    The keys for which values in the state are available are given by</span>
<span class="sd">    the KEYS module constant (accessible through the class constant of</span>
<span class="sd">    the same name as well).</span>

<span class="sd">    Additional fields can be added to these states through passing</span>
<span class="sd">    extra kwargs to the constructor. These will be automatically given</span>
<span class="sd">    a suffix of &quot;_OTHER&quot; to avoid name clashes.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">KEYS</span> <span class="o">=</span> <span class="n">KEYS</span>
    <span class="sd">&quot;&quot;&quot;The provided attribute keys for the state.&quot;&quot;&quot;</span>

    <span class="n">OTHER_KEY_TEMPLATE</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_OTHER&quot;</span>
    <span class="sd">&quot;&quot;&quot;String formatting template for attributes not set in KEYS.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sim_state</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Constructor for OpenMMState.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        state : simtk.openmm.State object</span>
<span class="sd">            The simulation state retrieved from the simulation constant.</span>

<span class="sd">        kwargs : optional</span>

<span class="sd">            Additional attributes to set for the state. Will add the</span>
<span class="sd">        &quot;_OTHER&quot; suffix to the keys</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># save the simulation state</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sim_state</span> <span class="o">=</span> <span class="n">sim_state</span>

        <span class="c1"># save additional data if given</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>

            <span class="c1"># if the key is already in the sim_state keys we need to</span>
            <span class="c1"># modify it and raise a warning</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">KEYS</span><span class="p">:</span>

                <span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Key </span><span class="si">{}</span><span class="s2"> in kwargs is already taken by this class, renaming to </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">OTHER_KEY_TEMPLATE</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>

                <span class="c1"># make a new key</span>
                <span class="n">new_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">OTHER_KEY_TEMPLATE</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

                <span class="c1"># set it in the data</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="n">new_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

            <span class="c1"># otherwise just set it</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">sim_state</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The underlying simtk.openmm.State object this is wrapping.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sim_state</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>

        <span class="c1"># if this was a key for data not mapped from the OpenMM.State</span>
        <span class="c1"># object we use the _data attribute</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">KEYS</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span>
                <span class="p">(</span><span class="ow">not</span> <span class="n">key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;parameters&#39;</span><span class="p">))</span> <span class="ow">and</span>
                <span class="p">(</span><span class="ow">not</span> <span class="n">key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;parameter_derivatives&#39;</span><span class="p">))</span>
        <span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

        <span class="c1"># otherwise we have to specifically get the correct data and</span>
        <span class="c1"># process it into an array from the OpenMM.State</span>
        <span class="k">else</span><span class="p">:</span>

            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;positions&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">positions_values</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;velocities&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">velocities_values</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;forces&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">forces_values</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;kinetic_energy&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">kinetic_energy_value</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;potential_energy&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">potential_energy_value</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;time&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_value</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;box_vectors&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">box_vectors_values</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;box_volume&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">box_volume_value</span><span class="p">()</span>

            <span class="c1"># handle the parameters differently since they are dictionaries of values</span>
            <span class="k">elif</span> <span class="n">key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;parameters&#39;</span><span class="p">):</span>
                <span class="n">parameters_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters_values</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">parameters_dict</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">None</span>
                <span class="k">else</span><span class="p">:</span>

                    <span class="c1"># TODO: this was an attempt at a general way to do</span>
                    <span class="c1"># this but it doesn&#39;t work and I only ever need</span>
                    <span class="c1"># one nested level, so for now we just implement it that way</span>
                    <span class="c1"># return self._get_nested_attr_from_compound_key(key, parameters_dict)</span>

                    <span class="n">param_key</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                    <span class="k">return</span> <span class="n">parameters_dict</span><span class="p">[</span><span class="n">param_key</span><span class="p">]</span>

            <span class="k">elif</span> <span class="n">key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;parameter_derivatives&#39;</span><span class="p">):</span>
                <span class="n">pd_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameter_derivatives_values</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">pd_dict</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">None</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_nested_attr_from_compound_key</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">pd_dict</span><span class="p">)</span>

    <span class="c1">## Array properties</span>

    <span class="c1"># Positions</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">positions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The positions of the state as a numpy array simtk.units.Quantity object.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim_state</span><span class="o">.</span><span class="n">getPositions</span><span class="p">(</span><span class="n">asNumpy</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Unknown exception handled from `self.sim_state.getPositions()`, &quot;</span>
                     <span class="s2">&quot;this is probably because this attribute is not in the State.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">positions_unit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The units (as a simtk.units.Unit object) the positions are in.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="o">.</span><span class="n">unit</span>

<div class="viewcode-block" id="OpenMMState.positions_values"><a class="viewcode-back" href="../../../_api/wepy.runners.openmm.html#wepy.runners.openmm.OpenMMState.positions_values">[docs]</a>    <span class="k">def</span> <span class="nf">positions_values</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The positions of the state as a numpy array in the positions_unit</span>
<span class="sd">        simtk.units.Unit. This is what is returned by the __getitem__</span>
<span class="sd">        accessor.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="o">.</span><span class="n">value_in_unit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">positions_unit</span><span class="p">)</span></div>

    <span class="c1"># Velocities</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">velocities</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The velocities of the state as a numpy array simtk.units.Quantity object.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim_state</span><span class="o">.</span><span class="n">getVelocities</span><span class="p">(</span><span class="n">asNumpy</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Unknown exception handled from `self.sim_state.getVelocities()`, &quot;</span>
                     <span class="s2">&quot;this is probably because this attribute is not in the State.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">velocities_unit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The units (as a simtk.units.Unit object) the velocities are in.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">velocities</span><span class="o">.</span><span class="n">unit</span>

<div class="viewcode-block" id="OpenMMState.velocities_values"><a class="viewcode-back" href="../../../_api/wepy.runners.openmm.html#wepy.runners.openmm.OpenMMState.velocities_values">[docs]</a>    <span class="k">def</span> <span class="nf">velocities_values</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The velocities of the state as a numpy array in the velocities_unit</span>
<span class="sd">        simtk.units.Unit. This is what is returned by the __getitem__</span>
<span class="sd">        accessor.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">velocities</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">velocities</span>
        <span class="k">if</span> <span class="n">velocities</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">velocities</span><span class="o">.</span><span class="n">value_in_unit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">velocities_unit</span><span class="p">)</span></div>

    <span class="c1"># Forces</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">forces</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The forces of the state as a numpy array simtk.units.Quantity object.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim_state</span><span class="o">.</span><span class="n">getForces</span><span class="p">(</span><span class="n">asNumpy</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Unknown exception handled from `self.sim_state.getForces()`, &quot;</span>
                     <span class="s2">&quot;this is probably because this attribute is not in the State.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">forces_unit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The units (as a simtk.units.Unit object) the forces are in.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">forces</span><span class="o">.</span><span class="n">unit</span>

<div class="viewcode-block" id="OpenMMState.forces_values"><a class="viewcode-back" href="../../../_api/wepy.runners.openmm.html#wepy.runners.openmm.OpenMMState.forces_values">[docs]</a>    <span class="k">def</span> <span class="nf">forces_values</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The forces of the state as a numpy array in the forces_unit</span>
<span class="sd">        simtk.units.Unit. This is what is returned by the __getitem__</span>
<span class="sd">        accessor.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">forces</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">forces</span>
        <span class="k">if</span> <span class="n">forces</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">forces</span><span class="o">.</span><span class="n">value_in_unit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">forces_unit</span><span class="p">)</span></div>

    <span class="c1"># Box Vectors</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">box_vectors</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The box vectors of the state as a numpy array simtk.units.Quantity object.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim_state</span><span class="o">.</span><span class="n">getPeriodicBoxVectors</span><span class="p">(</span><span class="n">asNumpy</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Unknown exception handled from `self.sim_state.getPeriodicBoxVectors()`, &quot;</span>
                     <span class="s2">&quot;this is probably because this attribute is not in the State.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">box_vectors_unit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The units (as a simtk.units.Unit object) the box vectors are in.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">box_vectors</span><span class="o">.</span><span class="n">unit</span>

<div class="viewcode-block" id="OpenMMState.box_vectors_values"><a class="viewcode-back" href="../../../_api/wepy.runners.openmm.html#wepy.runners.openmm.OpenMMState.box_vectors_values">[docs]</a>    <span class="k">def</span> <span class="nf">box_vectors_values</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The box vectors of the state as a numpy array in the</span>
<span class="sd">        box_vectors_unit simtk.units.Unit. This is what is returned by</span>
<span class="sd">        the __getitem__ accessor.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">box_vectors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">box_vectors</span>
        <span class="k">if</span> <span class="n">box_vectors</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">box_vectors</span><span class="o">.</span><span class="n">value_in_unit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">box_vectors_unit</span><span class="p">)</span></div>


    <span class="c1">## non-array properties</span>

    <span class="c1"># Kinetic Energy</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">kinetic_energy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The kinetic energy of the state as a numpy array simtk.units.Quantity object.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim_state</span><span class="o">.</span><span class="n">getKineticEnergy</span><span class="p">()</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Unknown exception handled from `self.sim_state.getKineticEnergy()`, &quot;</span>
                     <span class="s2">&quot;this is probably because this attribute is not in the State.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">kinetic_energy_unit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The units (as a simtk.units.Unit object) the kinetic energy is in.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">kinetic_energy</span><span class="o">.</span><span class="n">unit</span>

<div class="viewcode-block" id="OpenMMState.kinetic_energy_value"><a class="viewcode-back" href="../../../_api/wepy.runners.openmm.html#wepy.runners.openmm.OpenMMState.kinetic_energy_value">[docs]</a>    <span class="k">def</span> <span class="nf">kinetic_energy_value</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The kinetic energy of the state as a numpy array in the kinetic_energy_unit</span>
<span class="sd">        simtk.units.Unit. This is what is returned by the __getitem__</span>
<span class="sd">        accessor.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">kinetic_energy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kinetic_energy</span>
        <span class="k">if</span> <span class="n">kinetic_energy</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">kinetic_energy</span><span class="o">.</span><span class="n">value_in_unit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kinetic_energy_unit</span><span class="p">)])</span></div>

    <span class="c1"># Potential Energy</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">potential_energy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The potential energy of the state as a numpy array simtk.units.Quantity object.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim_state</span><span class="o">.</span><span class="n">getPotentialEnergy</span><span class="p">()</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Unknown exception handled from `self.sim_state.getPotentialEnergy()`, &quot;</span>
                     <span class="s2">&quot;this is probably because this attribute is not in the State.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">potential_energy_unit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The units (as a simtk.units.Unit object) the potential energy is in.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">potential_energy</span><span class="o">.</span><span class="n">unit</span>

<div class="viewcode-block" id="OpenMMState.potential_energy_value"><a class="viewcode-back" href="../../../_api/wepy.runners.openmm.html#wepy.runners.openmm.OpenMMState.potential_energy_value">[docs]</a>    <span class="k">def</span> <span class="nf">potential_energy_value</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The potential energy of the state as a numpy array in the potential_energy_unit</span>
<span class="sd">        simtk.units.Unit. This is what is returned by the __getitem__</span>
<span class="sd">        accessor.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">potential_energy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">potential_energy</span>
        <span class="k">if</span> <span class="n">potential_energy</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">potential_energy</span><span class="o">.</span><span class="n">value_in_unit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">potential_energy_unit</span><span class="p">)])</span></div>

    <span class="c1"># Time</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">time</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The time of the state as a numpy array simtk.units.Quantity object.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim_state</span><span class="o">.</span><span class="n">getTime</span><span class="p">()</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Unknown exception handled from `self.sim_state.getTime()`, &quot;</span>
                     <span class="s2">&quot;this is probably because this attribute is not in the State.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">time_unit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The units (as a simtk.units.Unit object) the time is in.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">unit</span>

<div class="viewcode-block" id="OpenMMState.time_value"><a class="viewcode-back" href="../../../_api/wepy.runners.openmm.html#wepy.runners.openmm.OpenMMState.time_value">[docs]</a>    <span class="k">def</span> <span class="nf">time_value</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The time of the state as a numpy array in the time_unit</span>
<span class="sd">        simtk.units.Unit. This is what is returned by the __getitem__</span>
<span class="sd">        accessor.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">time</span>
        <span class="k">if</span> <span class="n">time</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">value_in_unit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">time_unit</span><span class="p">)])</span></div>

    <span class="c1"># Box Volume</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">box_volume</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The box volume of the state as a numpy array simtk.units.Quantity object.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim_state</span><span class="o">.</span><span class="n">getPeriodicBoxVolume</span><span class="p">()</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Unknown exception handled from `self.sim_state.getPeriodicBoxVolume()`, &quot;</span>
                     <span class="s2">&quot;this is probably because this attribute is not in the State.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">box_volume_unit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The units (as a simtk.units.Unit object) the box volume is in.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">box_volume</span><span class="o">.</span><span class="n">unit</span>

<div class="viewcode-block" id="OpenMMState.box_volume_value"><a class="viewcode-back" href="../../../_api/wepy.runners.openmm.html#wepy.runners.openmm.OpenMMState.box_volume_value">[docs]</a>    <span class="k">def</span> <span class="nf">box_volume_value</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The box volume of the state as a numpy array in the box_volume_unit</span>
<span class="sd">        simtk.units.Unit. This is what is returned by the __getitem__</span>
<span class="sd">        accessor.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">box_volume</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">box_volume</span>
        <span class="k">if</span> <span class="n">box_volume</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">box_volume</span><span class="o">.</span><span class="n">value_in_unit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">box_volume_unit</span><span class="p">)])</span></div>

    <span class="c1">## Dictionary properties</span>
    <span class="c1">## Unitless</span>

    <span class="c1"># Parameters</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The parameters of the state as a dictionary mapping the names of</span>
<span class="sd">        the parameters to their values which are numpy array</span>
<span class="sd">        simtk.units.Quantity objects.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim_state</span><span class="o">.</span><span class="n">getParameters</span><span class="p">()</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Unknown exception handled from `self.sim_state.getParameters()`, &quot;</span>
                     <span class="s2">&quot;this is probably because this attribute is not in the State.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">parameters_unit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The units for each parameter as a dictionary mapping parameter</span>
<span class="sd">        names to their corresponding unit as a simtk.units.Unit</span>
<span class="sd">        object.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">param_units</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span> <span class="p">:</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
        <span class="k">return</span> <span class="n">param_units</span>

<div class="viewcode-block" id="OpenMMState.parameters_values"><a class="viewcode-back" href="../../../_api/wepy.runners.openmm.html#wepy.runners.openmm.OpenMMState.parameters_values">[docs]</a>    <span class="k">def</span> <span class="nf">parameters_values</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The parameters of the state as a dictionary mapping the name of the</span>
<span class="sd">        parameter to a numpy array in the unit for the parameter of the</span>
<span class="sd">        same name in the parameters_unit corresponding</span>
<span class="sd">        simtk.units.Unit object. This is what is returned by the</span>
<span class="sd">        __getitem__ accessor using the compound key syntax with the</span>
<span class="sd">        prefix &#39;parameters&#39;, e.g. state[&#39;parameter/paramA&#39;] for the</span>
<span class="sd">        parameter &#39;paramA&#39;.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">param_arrs</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span> <span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span>
                          <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

        <span class="c1"># return None if there is nothing in this</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">param_arrs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">param_arrs</span></div>

    <span class="c1"># Parameter Derivatives</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">parameter_derivatives</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The parameter derivatives of the state as a dictionary mapping the</span>
<span class="sd">        names of the parameters to their values which are numpy array</span>
<span class="sd">        simtk.units.Quantity objects.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim_state</span><span class="o">.</span><span class="n">getEnergyParameterDerivatives</span><span class="p">()</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Unknown exception handled from `self.sim_state.getEnergyParameterDerivatives()`, &quot;</span>
                     <span class="s2">&quot;this is probably because this attribute is not in the State.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">parameter_derivatives_unit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The units for each parameter derivative as a dictionary mapping</span>
<span class="sd">        parameter names to their corresponding unit as a</span>
<span class="sd">        simtk.units.Unit object.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">param_units</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span> <span class="p">:</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameter_derivatives</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
        <span class="k">return</span> <span class="n">param_units</span>

<div class="viewcode-block" id="OpenMMState.parameter_derivatives_values"><a class="viewcode-back" href="../../../_api/wepy.runners.openmm.html#wepy.runners.openmm.OpenMMState.parameter_derivatives_values">[docs]</a>    <span class="k">def</span> <span class="nf">parameter_derivatives_values</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The parameter derivatives of the state as a dictionary mapping the</span>
<span class="sd">        name of the parameter to a numpy array in the unit for the</span>
<span class="sd">        parameter of the same name in the parameters_unit</span>
<span class="sd">        corresponding simtk.units.Unit object. This is what is</span>
<span class="sd">        returned by the __getitem__ accessor using the compound key</span>
<span class="sd">        syntax with the prefix &#39;parameter_derivatives&#39;,</span>
<span class="sd">        e.g. state[&#39;parameter_derivatives/paramA&#39;] for the parameter</span>
<span class="sd">        &#39;paramA&#39;.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameter_derivatives</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">param_arrs</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span> <span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span>
                          <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameter_derivatives</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

        <span class="c1"># return None if there is nothing in this</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">param_arrs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">param_arrs</span></div>

    <span class="c1"># for the dict attributes we need to transform the keys for making</span>
    <span class="c1"># a proper state where all __getitem__ things are arrays</span>
<div class="viewcode-block" id="OpenMMState._dict_attr_to_compound_key_dict"><a class="viewcode-back" href="../../../_api/wepy.runners.openmm.html#wepy.runners.openmm.OpenMMState._dict_attr_to_compound_key_dict">[docs]</a>    <span class="k">def</span> <span class="nf">_dict_attr_to_compound_key_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">root_key</span><span class="p">,</span> <span class="n">attr_dict</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Transform a dictionary of values within the compound key &#39;root_key&#39;</span>
<span class="sd">        to a dictionary mapping compound keys to values.</span>

<span class="sd">        For example give the root_key &#39;parameters&#39; and the parameters</span>
<span class="sd">        dictionary {&#39;paramA&#39; : 1.234} returns {&#39;parameters/paramA&#39; : 1.234}.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        root_key : str</span>
<span class="sd">            The compound key prefix</span>
<span class="sd">        attr_dict : dict of str : value</span>
<span class="sd">            The dictionary with simple keys within the root key namespace.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        compound_key_dict : dict of str : value</span>
<span class="sd">            The dictionary with the compound keys.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">key_template</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">/</span><span class="si">{}</span><span class="s2">&quot;</span>
        <span class="n">cmpd_key_d</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">attr_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>

            <span class="n">new_key</span> <span class="o">=</span> <span class="n">key_template</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">root_key</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
            <span class="c1"># if this is a proper feature</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
                <span class="n">cmpd_key_d</span><span class="p">[</span><span class="n">new_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
            <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="s1">&#39;__getitem__&#39;</span><span class="p">):</span>
                <span class="n">cmpd_key_d</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dict_attr_to_compound_key_dict</span><span class="p">(</span><span class="n">new_key</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Unsupported attribute type&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">cmpd_key_d</span></div>

<div class="viewcode-block" id="OpenMMState._get_nested_attr_from_compound_key"><a class="viewcode-back" href="../../../_api/wepy.runners.openmm.html#wepy.runners.openmm.OpenMMState._get_nested_attr_from_compound_key">[docs]</a>    <span class="k">def</span> <span class="nf">_get_nested_attr_from_compound_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">compound_key</span><span class="p">,</span> <span class="n">compound_feat_dict</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get arbitrarily deeply nested compound keys from the full</span>
<span class="sd">        dictionary tree.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        compound_key : str</span>
<span class="sd">            Compound key separated by &#39;/&#39; characters</span>

<span class="sd">        compound_feat_dict : dict</span>
<span class="sd">            Dictionary of arbitrary depth</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        value</span>
<span class="sd">            Value requested by the key.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">key_components</span> <span class="o">=</span> <span class="n">compound_key</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>

        <span class="c1"># if there is only one component of the key then it is not</span>
        <span class="c1"># really compound, we won&#39;t complain just return the</span>
        <span class="c1"># &quot;dictionary&quot; if it is not actually a dict like</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">compound_feat_dict</span><span class="p">,</span> <span class="s1">&#39;__getitem__&#39;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Must provide a dict-like with the compound key&quot;</span><span class="p">)</span>

        <span class="n">value</span> <span class="o">=</span> <span class="n">compound_feat_dict</span><span class="p">[</span><span class="n">key_components</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>

        <span class="c1"># if the value itself is compound recursively fetch the value</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="s1">&#39;__getitem__&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">key_components</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>

            <span class="n">subgroup_key</span> <span class="o">=</span> <span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">key_components</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>

            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_nested_attr_from_compound_key</span><span class="p">(</span><span class="n">subgroup_key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

        <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="s1">&#39;__getitem__&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">key_components</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Key does not reference a leaf node of attribute&quot;</span><span class="p">)</span>

        <span class="c1"># otherwise we have the right key so return the object</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">value</span></div>

<div class="viewcode-block" id="OpenMMState.parameters_features"><a class="viewcode-back" href="../../../_api/wepy.runners.openmm.html#wepy.runners.openmm.OpenMMState.parameters_features">[docs]</a>    <span class="k">def</span> <span class="nf">parameters_features</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns a dictionary of the parameters with their appropriate</span>
<span class="sd">        compound keys. This can be used for placing them in the same namespace</span>
<span class="sd">        as the rest of the attributes.&quot;&quot;&quot;</span>

        <span class="n">parameters</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters_values</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">parameters</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dict_attr_to_compound_key_dict</span><span class="p">(</span><span class="s1">&#39;parameters&#39;</span><span class="p">,</span> <span class="n">parameters</span><span class="p">)</span></div>

<div class="viewcode-block" id="OpenMMState.parameter_derivatives_features"><a class="viewcode-back" href="../../../_api/wepy.runners.openmm.html#wepy.runners.openmm.OpenMMState.parameter_derivatives_features">[docs]</a>    <span class="k">def</span> <span class="nf">parameter_derivatives_features</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns a dictionary of the parameter derivatives with their appropriate</span>
<span class="sd">        compound keys. This can be used for placing them in the same namespace</span>
<span class="sd">        as the rest of the attributes.&quot;&quot;&quot;</span>

        <span class="n">parameter_derivatives</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameter_derivatives_values</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">parameter_derivatives</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dict_attr_to_compound_key_dict</span><span class="p">(</span><span class="s1">&#39;parameter_derivatives&#39;</span><span class="p">,</span>
                                                        <span class="n">parameter_derivatives</span><span class="p">)</span></div>

<div class="viewcode-block" id="OpenMMState.omm_state_dict"><a class="viewcode-back" href="../../../_api/wepy.runners.openmm.html#wepy.runners.openmm.OpenMMState.omm_state_dict">[docs]</a>    <span class="k">def</span> <span class="nf">omm_state_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a dictionary with all of the default keys from the wrapped</span>
<span class="sd">        simtk.openmm.State object&quot;&quot;&quot;</span>

        <span class="n">feature_d</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;positions&#39;</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">positions_values</span><span class="p">(),</span>
                <span class="s1">&#39;velocities&#39;</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">velocities_values</span><span class="p">(),</span>
                <span class="s1">&#39;forces&#39;</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">forces_values</span><span class="p">(),</span>
                <span class="s1">&#39;kinetic_energy&#39;</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">kinetic_energy_value</span><span class="p">(),</span>
                <span class="s1">&#39;potential_energy&#39;</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">potential_energy_value</span><span class="p">(),</span>
                <span class="s1">&#39;time&#39;</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_value</span><span class="p">(),</span>
                <span class="s1">&#39;box_vectors&#39;</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">box_vectors_values</span><span class="p">(),</span>
                <span class="s1">&#39;box_volume&#39;</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">box_volume_value</span><span class="p">(),</span>
                    <span class="p">}</span>

        <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters_features</span><span class="p">()</span>
        <span class="n">param_derivs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameter_derivatives_features</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">params</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">feature_d</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">param_derivs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">feature_d</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">param_derivs</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">feature_d</span></div>

<div class="viewcode-block" id="OpenMMState.dict"><a class="viewcode-back" href="../../../_api/wepy.runners.openmm.html#wepy.runners.openmm.OpenMMState.dict">[docs]</a>    <span class="k">def</span> <span class="nf">dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># documented in superclass</span>

        <span class="n">d</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">d</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">omm_state_dict</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">d</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">return</span> <span class="n">d</span></div>

<div class="viewcode-block" id="OpenMMState.to_mdtraj"><a class="viewcode-back" href="../../../_api/wepy.runners.openmm.html#wepy.runners.openmm.OpenMMState.to_mdtraj">[docs]</a>    <span class="k">def</span> <span class="nf">to_mdtraj</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">topology</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns an mdtraj.Trajectory object from this walker&#39;s state.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        topology : mdtraj.Topology object</span>
<span class="sd">            Topology for the state.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        state_traj : mdtraj.Trajectory object</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="kn">import</span> <span class="nn">mdtraj</span> <span class="k">as</span> <span class="nn">mdj</span>
        <span class="c1"># resize the time to a 1D vector</span>
        <span class="n">unitcell_lengths</span><span class="p">,</span> <span class="n">unitcell_angles</span> <span class="o">=</span> <span class="n">box_vectors_to_lengths_angles</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">box_vectors</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">mdj</span><span class="o">.</span><span class="n">Trajectory</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">positions_values</span><span class="p">()]),</span>
                              <span class="n">unitcell_lengths</span><span class="o">=</span><span class="p">[</span><span class="n">unitcell_lengths</span><span class="p">],</span>
                              <span class="n">unitcell_angles</span><span class="o">=</span><span class="p">[</span><span class="n">unitcell_angles</span><span class="p">],</span>
                              <span class="n">topology</span><span class="o">=</span><span class="n">topology</span><span class="p">)</span></div></div>

<div class="viewcode-block" id="gen_sim_state"><a class="viewcode-back" href="../../../_api/wepy.runners.openmm.html#wepy.runners.openmm.gen_sim_state">[docs]</a><span class="k">def</span> <span class="nf">gen_sim_state</span><span class="p">(</span><span class="n">positions</span><span class="p">,</span> <span class="n">system</span><span class="p">,</span> <span class="n">integrator</span><span class="p">,</span>
                  <span class="n">getState_kwargs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Convenience function for generating an omm.State object.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>

<span class="sd">    positions : arraylike of float</span>
<span class="sd">        The positions for the system you want to set</span>

<span class="sd">    system : openmm.app.System object</span>

<span class="sd">    integrator : openmm.Integrator object</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>

<span class="sd">    sim_state : openmm.State object</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># handle the getState_kwargs</span>
    <span class="n">tmp_getState_kwargs</span> <span class="o">=</span> <span class="n">getState_kwargs</span>

    <span class="c1"># start with the defaults</span>
    <span class="n">getState_kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">GET_STATE_KWARG_DEFAULTS</span><span class="p">)</span>

    <span class="c1"># if there were customizations use them</span>
    <span class="k">if</span> <span class="n">tmp_getState_kwargs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">getState_kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">tmp_getState_kwargs</span><span class="p">)</span>

    <span class="c1"># generate a throwaway context, using the reference platform so we</span>
    <span class="c1"># don&#39;t screw up other platform stuff later in the same process</span>
    <span class="n">platform</span> <span class="o">=</span> <span class="n">omm</span><span class="o">.</span><span class="n">Platform</span><span class="o">.</span><span class="n">getPlatformByName</span><span class="p">(</span><span class="s1">&#39;Reference&#39;</span><span class="p">)</span>
    <span class="n">context</span> <span class="o">=</span> <span class="n">omm</span><span class="o">.</span><span class="n">Context</span><span class="p">(</span><span class="n">system</span><span class="p">,</span> <span class="n">copy</span><span class="p">(</span><span class="n">integrator</span><span class="p">),</span> <span class="n">platform</span><span class="p">)</span>

    <span class="c1"># set the positions</span>
    <span class="n">context</span><span class="o">.</span><span class="n">setPositions</span><span class="p">(</span><span class="n">positions</span><span class="p">)</span>

    <span class="c1"># then just retrieve it as a state using the default kwargs</span>
    <span class="n">sim_state</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">getState</span><span class="p">(</span><span class="o">**</span><span class="n">getState_kwargs</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">sim_state</span></div>

<div class="viewcode-block" id="gen_walker_state"><a class="viewcode-back" href="../../../_api/wepy.runners.openmm.html#wepy.runners.openmm.gen_walker_state">[docs]</a><span class="k">def</span> <span class="nf">gen_walker_state</span><span class="p">(</span><span class="n">positions</span><span class="p">,</span> <span class="n">system</span><span class="p">,</span> <span class="n">integrator</span><span class="p">,</span>
                     <span class="n">getState_kwargs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Convenience function for generating a wepy walker State object for</span>
<span class="sd">    an openmm simulation state.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>

<span class="sd">    positions : arraylike of float</span>
<span class="sd">        The positions for the system you want to set</span>

<span class="sd">    system : openmm.app.System object</span>

<span class="sd">    integrator : openmm.Integrator object</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>

<span class="sd">    walker_state : wepy.runners.openmm.OpenMMState object</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">state</span> <span class="o">=</span> <span class="n">OpenMMState</span><span class="p">(</span><span class="n">gen_sim_state</span><span class="p">(</span><span class="n">positions</span><span class="p">,</span> <span class="n">system</span><span class="p">,</span> <span class="n">integrator</span><span class="p">,</span>
                                      <span class="n">getState_kwargs</span><span class="o">=</span><span class="n">getState_kwargs</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">state</span></div>


<div class="viewcode-block" id="OpenMMWalker"><a class="viewcode-back" href="../../../_api/wepy.runners.openmm.html#wepy.runners.openmm.OpenMMWalker">[docs]</a><span class="k">class</span> <span class="nc">OpenMMWalker</span><span class="p">(</span><span class="n">Walker</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Walker for OpenMMRunner simulations.</span>

<span class="sd">    This simply enforces the use of an OpenMMState object for the</span>
<span class="sd">    walker state attribute.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">weight</span><span class="p">):</span>
        <span class="c1"># documented in superclass</span>

        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">OpenMMState</span><span class="p">),</span> \
            <span class="s2">&quot;state must be an instance of class OpenMMState not </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">state</span><span class="p">))</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">weight</span><span class="p">)</span></div>


<div class="viewcode-block" id="OpenMMCPUWorker"><a class="viewcode-back" href="../../../_api/wepy.runners.openmm.html#wepy.runners.openmm.OpenMMCPUWorker">[docs]</a><span class="k">class</span> <span class="nc">OpenMMCPUWorker</span><span class="p">(</span><span class="n">Worker</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Worker for OpenMM GPU simulations (CUDA or OpenCL platforms).</span>

<span class="sd">    This is intended to be used with the wepy.work_mapper.WorkerMapper</span>
<span class="sd">    work mapper class.</span>

<span class="sd">    This class must be used in order to ensure OpenMM runs jobs on the</span>
<span class="sd">    appropriate GPU device.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">NAME_TEMPLATE</span> <span class="o">=</span> <span class="s2">&quot;OpenMMCPUWorker-</span><span class="si">{}</span><span class="s2">&quot;</span>
    <span class="sd">&quot;&quot;&quot;The name template the worker processes are named to substituting in</span>
<span class="sd">    the process number.&quot;&quot;&quot;</span>

    <span class="n">DEFAULT_NUM_THREADS</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

        <span class="k">if</span> <span class="s1">&#39;num_threads&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">num_threads</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">DEFAULT_NUM_THREADS</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">num_threads</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;num_threads&#39;</span><span class="p">)</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span>
                         <span class="n">num_threads</span><span class="o">=</span><span class="n">num_threads</span><span class="p">,</span>
                         <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

<div class="viewcode-block" id="OpenMMCPUWorker.run_task"><a class="viewcode-back" href="../../../_api/wepy.runners.openmm.html#wepy.runners.openmm.OpenMMCPUWorker.run_task">[docs]</a>    <span class="k">def</span> <span class="nf">run_task</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task</span><span class="p">):</span>
        <span class="c1"># documented in superclass</span>

        <span class="c1"># make the platform kwargs dictionary</span>
        <span class="n">platform_options</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Threads&#39;</span> <span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">attributes</span><span class="p">[</span><span class="s1">&#39;num_threads&#39;</span><span class="p">])}</span>

        <span class="c1"># run the task and pass in the DeviceIndex for OpenMM to</span>
        <span class="c1"># assign work to the correct GPU</span>
        <span class="k">return</span> <span class="n">task</span><span class="p">(</span><span class="n">platform_kwargs</span><span class="o">=</span><span class="n">platform_options</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="OpenMMGPUWorker"><a class="viewcode-back" href="../../../_api/wepy.runners.openmm.html#wepy.runners.openmm.OpenMMGPUWorker">[docs]</a><span class="k">class</span> <span class="nc">OpenMMGPUWorker</span><span class="p">(</span><span class="n">Worker</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Worker for OpenMM GPU simulations (CUDA or OpenCL platforms).</span>

<span class="sd">    This is intended to be used with the wepy.work_mapper.WorkerMapper</span>
<span class="sd">    work mapper class.</span>

<span class="sd">    This class must be used in order to ensure OpenMM runs jobs on the</span>
<span class="sd">    appropriate GPU device.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">NAME_TEMPLATE</span> <span class="o">=</span> <span class="s2">&quot;OpenMMGPUWorker-</span><span class="si">{}</span><span class="s2">&quot;</span>
    <span class="sd">&quot;&quot;&quot;The name template the worker processes are named to substituting in</span>
<span class="sd">    the process number.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="OpenMMGPUWorker.run_task"><a class="viewcode-back" href="../../../_api/wepy.runners.openmm.html#wepy.runners.openmm.OpenMMGPUWorker.run_task">[docs]</a>    <span class="k">def</span> <span class="nf">run_task</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task</span><span class="p">):</span>

        <span class="c1"># get the platform</span>
        <span class="n">platform</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mapper_attributes</span><span class="p">[</span><span class="s1">&#39;platform&#39;</span><span class="p">]</span>

        <span class="c1"># get the device index from the attributes</span>
        <span class="n">device_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mapper_attributes</span><span class="p">[</span><span class="s1">&#39;device_ids&#39;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">_worker_idx</span><span class="p">]</span>

        <span class="c1"># make the platform kwargs dictionary</span>
        <span class="n">platform_options</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;DeviceIndex&#39;</span> <span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">device_id</span><span class="p">)}</span>

        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;platform=</span><span class="si">{</span><span class="n">platform</span><span class="si">}</span><span class="s2">, platform_options=</span><span class="si">{</span><span class="n">platform_options</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">task</span><span class="p">(</span>
            <span class="n">platform</span><span class="o">=</span><span class="n">platform</span><span class="p">,</span>
            <span class="n">platform_kwargs</span><span class="o">=</span><span class="n">platform_options</span><span class="p">,</span>
        <span class="p">)</span></div></div>


<div class="viewcode-block" id="OpenMMCPUWalkerTaskProcess"><a class="viewcode-back" href="../../../_api/wepy.runners.openmm.html#wepy.runners.openmm.OpenMMCPUWalkerTaskProcess">[docs]</a><span class="k">class</span> <span class="nc">OpenMMCPUWalkerTaskProcess</span><span class="p">(</span><span class="n">WalkerTaskProcess</span><span class="p">):</span>

    <span class="n">NAME_TEMPLATE</span> <span class="o">=</span> <span class="s2">&quot;OpenMM_CPU_Walker_Task-</span><span class="si">{}</span><span class="s2">&quot;</span>


<div class="viewcode-block" id="OpenMMCPUWalkerTaskProcess.run_task"><a class="viewcode-back" href="../../../_api/wepy.runners.openmm.html#wepy.runners.openmm.OpenMMCPUWalkerTaskProcess.run_task">[docs]</a>    <span class="k">def</span> <span class="nf">run_task</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task</span><span class="p">):</span>

        <span class="k">if</span> <span class="s1">&#39;num_threads&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mapper_attributes</span><span class="p">:</span>
            <span class="n">num_threads</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mapper_attributes</span><span class="p">[</span><span class="s1">&#39;num_threads&#39;</span><span class="p">]</span>

            <span class="c1"># make the platform kwargs dictionary</span>
            <span class="n">platform_options</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Threads&#39;</span> <span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">num_threads</span><span class="p">)}</span>

            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Threads=</span><span class="si">{</span><span class="n">num_threads</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">platform_options</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">return</span> <span class="n">task</span><span class="p">(</span>
            <span class="n">platform_kwargs</span><span class="o">=</span><span class="n">platform_options</span><span class="p">,</span>
        <span class="p">)</span></div></div>

<div class="viewcode-block" id="OpenMMGPUWalkerTaskProcess"><a class="viewcode-back" href="../../../_api/wepy.runners.openmm.html#wepy.runners.openmm.OpenMMGPUWalkerTaskProcess">[docs]</a><span class="k">class</span> <span class="nc">OpenMMGPUWalkerTaskProcess</span><span class="p">(</span><span class="n">WalkerTaskProcess</span><span class="p">):</span>

    <span class="n">NAME_TEMPLATE</span> <span class="o">=</span> <span class="s2">&quot;OpenMM_GPU_Walker_Task-</span><span class="si">{}</span><span class="s2">&quot;</span>


<div class="viewcode-block" id="OpenMMGPUWalkerTaskProcess.run_task"><a class="viewcode-back" href="../../../_api/wepy.runners.openmm.html#wepy.runners.openmm.OpenMMGPUWalkerTaskProcess.run_task">[docs]</a>    <span class="k">def</span> <span class="nf">run_task</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task</span><span class="p">):</span>


        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Starting to run a task as worker </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_worker_idx</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># get the platform</span>
        <span class="n">platform</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mapper_attributes</span><span class="p">[</span><span class="s1">&#39;platform&#39;</span><span class="p">]</span>

        <span class="c1"># get the device index from the attributes</span>
        <span class="n">device_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mapper_attributes</span><span class="p">[</span><span class="s1">&#39;device_ids&#39;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">_worker_idx</span><span class="p">]</span>

        <span class="c1"># make the platform kwargs dictionary</span>
        <span class="n">platform_options</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;DeviceIndex&#39;</span> <span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">device_id</span><span class="p">)}</span>

        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;platform=</span><span class="si">{</span><span class="n">platform</span><span class="si">}</span><span class="s2">, platform_options=</span><span class="si">{</span><span class="n">platform_options</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">task</span><span class="p">(</span>
            <span class="n">platform</span><span class="o">=</span><span class="n">platform</span><span class="p">,</span>
            <span class="n">platform_kwargs</span><span class="o">=</span><span class="n">platform_options</span><span class="p">,</span>
        <span class="p">)</span></div></div>
</pre></div>

          </div>
              <div class="related bottom">
                &nbsp;
  <nav id="rellinks">
    <ul>
    </ul>
  </nav>
              </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<p class="logo">
  <a href="../../../index.html">
    <img class="logo" src="../../../_static/wepy.svg" alt="Logo"/>
    
    <h1 class="logo logo-name">wepy</h1>
    
  </a>
</p>



<p class="blurb">Wepy Documentation</p>




<p>
<iframe src="https://ghbtns.com/github-btn.html?user=ADicksonLab&repo=wepy&type=watch&count=true&size=large&v=2"
  allowtransparency="true" frameborder="0" scrolling="0" width="200px" height="35px"></iframe>
</p>





<h3>Navigation</h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../_source/installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../_source/quick_start.html">Quick Start</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../_source/introduction.html">Introduction &amp; Features</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../_source/introduction.html#bibliography">Bibliography</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../_source/tutorials/index.html">Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../_source/users_guide.html">User’s Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../_source/troubleshooting.html">FAQ</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../_source/reference.html">Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../_source/glossary.html">Glossary</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../_source/api.html">API Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../_api/modules.html">Full API</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../_source/general_info.html">General Information</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../_source/news.html">News and Updates</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../_source/changelog.html">Changelog</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../_source/dev_guide.html">Development Guide</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../index.html">Documentation overview</a><ul>
  <li><a href="../../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2018, Samuel D. Lotz.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 3.5.2</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>