
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>wepy.hdf5 &#8212; wepy v0.10 documentation</title>
    <link rel="stylesheet" href="../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for wepy.hdf5</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">os.path</span> <span class="k">as</span> <span class="nn">osp</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="k">import</span> <span class="n">Sequence</span><span class="p">,</span> <span class="n">namedtuple</span><span class="p">,</span> <span class="n">defaultdict</span>
<span class="kn">import</span> <span class="nn">itertools</span> <span class="k">as</span> <span class="nn">it</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">from</span> <span class="nn">warnings</span> <span class="k">import</span> <span class="n">warn</span>
<span class="kn">from</span> <span class="nn">copy</span> <span class="k">import</span> <span class="n">copy</span>
<span class="kn">import</span> <span class="nn">logging</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">h5py</span>
<span class="kn">import</span> <span class="nn">networkx</span> <span class="k">as</span> <span class="nn">nx</span>

<span class="kn">from</span> <span class="nn">wepy.analysis.parents</span> <span class="k">import</span> <span class="n">resampling_panel</span>
<span class="kn">from</span> <span class="nn">wepy.util.mdtraj</span> <span class="k">import</span> <span class="n">mdtraj_to_json_topology</span><span class="p">,</span> <span class="n">json_to_mdtraj_topology</span>
<span class="kn">from</span> <span class="nn">wepy.util.util</span> <span class="k">import</span> <span class="n">traj_box_vectors_to_lengths_angles</span><span class="p">,</span> <span class="n">json_top_atom_count</span>

<span class="c1"># optional dependencies</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">mdtraj</span> <span class="k">as</span> <span class="nn">mdj</span>
<span class="k">except</span> <span class="n">ModuleNotFoundError</span><span class="p">:</span>
    <span class="n">warn</span><span class="p">(</span><span class="s2">&quot;mdtraj is not installed and that functionality will not work&quot;</span><span class="p">,</span> <span class="ne">RuntimeWarning</span><span class="p">)</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="k">except</span> <span class="n">ModuleNotFoundError</span><span class="p">:</span>
    <span class="n">warn</span><span class="p">(</span><span class="s2">&quot;pandas is not installed and that functionality will not work&quot;</span><span class="p">,</span> <span class="ne">RuntimeWarning</span><span class="p">)</span>


<span class="c1">## Constants for the main trajectories data group</span>
<span class="c1"># Constants</span>
<span class="n">N_DIMS</span> <span class="o">=</span> <span class="mi">3</span>

<span class="n">TRAJECTORIES</span> <span class="o">=</span> <span class="s1">&#39;trajectories&#39;</span>

<span class="c1"># strings for trajectory fields</span>
<span class="n">POSITIONS</span> <span class="o">=</span> <span class="s1">&#39;positions&#39;</span>
<span class="n">BOX_VECTORS</span> <span class="o">=</span> <span class="s1">&#39;box_vectors&#39;</span>
<span class="n">VELOCITIES</span> <span class="o">=</span> <span class="s1">&#39;velocities&#39;</span>
<span class="n">FORCES</span> <span class="o">=</span> <span class="s1">&#39;forces&#39;</span>
<span class="n">TIME</span> <span class="o">=</span> <span class="s1">&#39;time&#39;</span>
<span class="n">KINETIC_ENERGY</span> <span class="o">=</span> <span class="s1">&#39;kinetic_energy&#39;</span>
<span class="n">POTENTIAL_ENERGY</span> <span class="o">=</span> <span class="s1">&#39;potential_energy&#39;</span>
<span class="n">BOX_VOLUME</span> <span class="o">=</span> <span class="s1">&#39;box_volume&#39;</span>
<span class="n">OBSERVABLES</span> <span class="o">=</span> <span class="s1">&#39;observables&#39;</span>

<span class="n">PARAMETERS</span> <span class="o">=</span> <span class="s1">&#39;parameters&#39;</span>
<span class="n">PARAMETER_DERIVATIVES</span> <span class="o">=</span> <span class="s1">&#39;parameter_derivatives&#39;</span>

<span class="n">WEIGHTS</span> <span class="o">=</span> <span class="s1">&#39;weights&#39;</span>

<span class="c1"># lists of keys etc.</span>
<span class="n">TRAJ_DATA_FIELDS</span> <span class="o">=</span> <span class="p">(</span><span class="n">POSITIONS</span><span class="p">,</span> <span class="n">TIME</span><span class="p">,</span> <span class="n">BOX_VECTORS</span><span class="p">,</span> <span class="n">VELOCITIES</span><span class="p">,</span>
                    <span class="n">FORCES</span><span class="p">,</span> <span class="n">KINETIC_ENERGY</span><span class="p">,</span> <span class="n">POTENTIAL_ENERGY</span><span class="p">,</span>
                    <span class="n">BOX_VOLUME</span><span class="p">,</span> <span class="n">PARAMETERS</span><span class="p">,</span> <span class="n">PARAMETER_DERIVATIVES</span><span class="p">,</span>
                    <span class="n">OBSERVABLES</span><span class="p">)</span>



<span class="c1"># defaults for the rank (length of shape vector) for certain</span>
<span class="c1"># unchanging data fields. This is the rank of the feawture not the</span>
<span class="c1"># array that will acutally be saved int he hdf5. That will always be</span>
<span class="c1"># one more than the rank of the feature.</span>
<span class="n">FIELD_FEATURE_RANKS</span> <span class="o">=</span> <span class="p">((</span><span class="n">POSITIONS</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
                       <span class="p">(</span><span class="n">TIME</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
                       <span class="p">(</span><span class="n">BOX_VECTORS</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
                       <span class="p">(</span><span class="n">VELOCITIES</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
                       <span class="p">(</span><span class="n">FORCES</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
                       <span class="p">(</span><span class="n">BOX_VOLUME</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
                       <span class="p">(</span><span class="n">KINETIC_ENERGY</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
                       <span class="p">(</span><span class="n">POTENTIAL_ENERGY</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
                      <span class="p">)</span>

<span class="c1"># defaults for the shapes for those fields they can be given to.</span>
<span class="n">FIELD_FEATURE_SHAPES</span> <span class="o">=</span> <span class="p">((</span><span class="n">TIME</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,)),</span>
                        <span class="p">(</span><span class="n">BOX_VECTORS</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">)),</span>
                        <span class="p">(</span><span class="n">BOX_VOLUME</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,)),</span>
                        <span class="p">(</span><span class="n">KINETIC_ENERGY</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,)),</span>
                        <span class="p">(</span><span class="n">POTENTIAL_ENERGY</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,)),</span>
                        <span class="p">)</span>

<span class="n">WEIGHT_SHAPE</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,)</span>

<span class="n">FIELD_FEATURE_DTYPES</span> <span class="o">=</span> <span class="p">((</span><span class="n">POSITIONS</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">),</span>
                        <span class="p">(</span><span class="n">VELOCITIES</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">),</span>
                        <span class="p">(</span><span class="n">FORCES</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">),</span>
                        <span class="p">(</span><span class="n">TIME</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">),</span>
                        <span class="p">(</span><span class="n">BOX_VECTORS</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">),</span>
                        <span class="p">(</span><span class="n">BOX_VOLUME</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">),</span>
                        <span class="p">(</span><span class="n">KINETIC_ENERGY</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">),</span>
                        <span class="p">(</span><span class="n">POTENTIAL_ENERGY</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">),</span>
                        <span class="p">)</span>


<span class="c1"># Positions (and thus velocities and forces) are determined by the</span>
<span class="c1"># N_DIMS (which can be customized) and more importantly the number of</span>
<span class="c1"># particles which is always different. All the others are always wacky</span>
<span class="c1"># and different.</span>
<span class="n">POSITIONS_LIKE_FIELDS</span> <span class="o">=</span> <span class="p">(</span><span class="n">VELOCITIES</span><span class="p">,</span> <span class="n">FORCES</span><span class="p">)</span>

<span class="c1"># some fields have more than one dataset associated with them</span>
<span class="n">COMPOUND_DATA_FIELDS</span> <span class="o">=</span> <span class="p">(</span><span class="n">PARAMETERS</span><span class="p">,</span> <span class="n">PARAMETER_DERIVATIVES</span><span class="p">,</span> <span class="n">OBSERVABLES</span><span class="p">)</span>
<span class="n">COMPOUND_UNIT_FIELDS</span> <span class="o">=</span> <span class="p">(</span><span class="n">PARAMETERS</span><span class="p">,</span> <span class="n">PARAMETER_DERIVATIVES</span><span class="p">,</span> <span class="n">OBSERVABLES</span><span class="p">)</span>

<span class="c1"># some fields can have sparse data, non-sparse data must be all the</span>
<span class="c1"># same shape and larger than sparse arrays. Sparse arrays have an</span>
<span class="c1"># associated index with them aligning them to the non-sparse datasets</span>
<span class="n">SPARSE_DATA_FIELDS</span> <span class="o">=</span> <span class="p">(</span><span class="n">VELOCITIES</span><span class="p">,</span> <span class="n">FORCES</span><span class="p">,</span> <span class="n">KINETIC_ENERGY</span><span class="p">,</span> <span class="n">POTENTIAL_ENERGY</span><span class="p">,</span>
                      <span class="n">BOX_VOLUME</span><span class="p">,</span> <span class="n">PARAMETERS</span><span class="p">,</span> <span class="n">PARAMETER_DERIVATIVES</span><span class="p">,</span> <span class="n">OBSERVABLES</span><span class="p">)</span>


<span class="c1">## Run data records</span>

<span class="c1"># the groups of run records</span>
<span class="n">RESAMPLING</span> <span class="o">=</span> <span class="s1">&#39;resampling&#39;</span>
<span class="n">RESAMPLER</span> <span class="o">=</span> <span class="s1">&#39;resampler&#39;</span>
<span class="n">WARPING</span> <span class="o">=</span> <span class="s1">&#39;warping&#39;</span>
<span class="n">PROGRESS</span> <span class="o">=</span> <span class="s1">&#39;progress&#39;</span>
<span class="n">BC</span> <span class="o">=</span> <span class="s1">&#39;boundary_conditions&#39;</span>

<span class="n">CYCLE_IDXS</span> <span class="o">=</span> <span class="s1">&#39;_cycle_idxs&#39;</span>

<span class="c1"># records can be sporadic or continual. Continual records are</span>
<span class="c1"># generated every cycle and are saved every cycle and are for all</span>
<span class="c1"># walkers.  Sporadic records are generated conditional on specific</span>
<span class="c1"># events taking place and thus may or may not be produced each</span>
<span class="c1"># cycle. There also is not a single record for each (cycle, step) like</span>
<span class="c1"># there would be for continual ones because they can occur for single</span>
<span class="c1"># walkers, boundary conditions, or resamplers.</span>
<span class="n">SPORADIC_RECORDS</span> <span class="o">=</span> <span class="p">(</span><span class="n">RESAMPLER</span><span class="p">,</span> <span class="n">WARPING</span><span class="p">,</span> <span class="n">RESAMPLING</span><span class="p">,</span> <span class="n">BC</span><span class="p">)</span>

<span class="c1">## Dataset Compliances</span>
<span class="c1"># a file which has different levels of keys can be used for</span>
<span class="c1"># different things, so we define these collections of keys,</span>
<span class="c1"># and flags to keep track of which ones this dataset</span>
<span class="c1"># satisfies, ds here stands for &quot;dataset&quot;</span>
<span class="n">COMPLIANCE_TAGS</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;COORDS&#39;</span><span class="p">,</span> <span class="s1">&#39;TRAJ&#39;</span><span class="p">,</span> <span class="s1">&#39;RESTART&#39;</span><span class="p">]</span>

<span class="c1"># the minimal requirement (and need for this class) is to associate</span>
<span class="c1"># a collection of coordinates to some molecular structure (topology)</span>
<span class="n">COMPLIANCE_REQUIREMENTS</span> <span class="o">=</span> <span class="p">((</span><span class="s1">&#39;COORDS&#39;</span><span class="p">,</span>  <span class="p">(</span><span class="n">POSITIONS</span><span class="p">,)),</span>
                           <span class="p">(</span><span class="s1">&#39;TRAJ&#39;</span><span class="p">,</span>    <span class="p">(</span><span class="n">POSITIONS</span><span class="p">,</span> <span class="n">TIME</span><span class="p">,</span> <span class="n">BOX_VECTORS</span><span class="p">)),</span>
                           <span class="p">(</span><span class="s1">&#39;RESTART&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">POSITIONS</span><span class="p">,</span> <span class="n">TIME</span><span class="p">,</span> <span class="n">BOX_VECTORS</span><span class="p">,</span>
                                        <span class="n">VELOCITIES</span><span class="p">)),</span>
                          <span class="p">)</span>


<div class="viewcode-block" id="WepyHDF5"><a class="viewcode-back" href="../../api/wepy.html#wepy.hdf5.WepyHDF5">[docs]</a><span class="k">class</span> <span class="nc">WepyHDF5</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">topology</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span>
                 <span class="n">units</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">sparse_fields</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">feature_shapes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">feature_dtypes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">n_dims</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">alt_reps</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">main_rep_idxs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">expert_mode</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize a new Wepy HDF5 file. This is a file that organizes</span>
<span class="sd">        wepy.TrajHDF5 dataset subsets by simulations by runs and</span>
<span class="sd">        includes resampling records for recovering walker histories.</span>

<span class="sd">        mode:</span>
<span class="sd">        r        Readonly, file must exist</span>
<span class="sd">        r+       Read/write, file must exist</span>
<span class="sd">        w        Create file, truncate if exists</span>
<span class="sd">        x or w-  Create file, fail if exists</span>
<span class="sd">        a        Read/write if exists, create otherwise</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_filename</span> <span class="o">=</span> <span class="n">filename</span>

        <span class="k">if</span> <span class="n">expert_mode</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_h5</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_wepy_mode</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_h5py_mode</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">closed</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="c1"># terminate the constructor here</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="k">assert</span> <span class="n">mode</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="s1">&#39;r+&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="s1">&#39;w-&#39;</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="s1">&#39;c-&#39;</span><span class="p">],</span> \
          <span class="s2">&quot;mode must be either &#39;r&#39;, &#39;r+&#39;, &#39;w&#39;, &#39;x&#39;, &#39;w-&#39;, &#39;a&#39;, &#39;c&#39;, or &#39;c-&#39;&quot;</span>



        <span class="c1"># the top level mode enforced by wepy.hdf5</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_wepy_mode</span> <span class="o">=</span> <span class="n">mode</span>

        <span class="c1"># the lower level h5py mode. THis was originally different to</span>
        <span class="c1"># accomodate different modes at teh wepy level for</span>
        <span class="c1"># concatenation. I will leave these separate because this is</span>
        <span class="c1"># used elsewhere and could be a feature in the future.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_h5py_mode</span> <span class="o">=</span> <span class="n">mode</span>

        <span class="c1"># Temporary metadata: used to initialize the object but not</span>
        <span class="c1"># used after that</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_topology</span> <span class="o">=</span> <span class="n">topology</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_units</span> <span class="o">=</span> <span class="n">units</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_n_dims</span> <span class="o">=</span> <span class="n">n_dims</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_n_coords</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># set hidden feature shapes and dtype, which are only</span>
        <span class="c1"># referenced if needed when trajectories are created. These</span>
        <span class="c1"># will be saved in the settings section in the actual HDF5</span>
        <span class="c1"># file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_field_feature_shapes_kwarg</span> <span class="o">=</span> <span class="n">feature_shapes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_field_feature_dtypes_kwarg</span> <span class="o">=</span> <span class="n">feature_dtypes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_field_feature_dtypes</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_field_feature_shapes</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># save the sparse fields as a private variable for use in the</span>
        <span class="c1"># create constructor</span>
        <span class="k">if</span> <span class="n">sparse_fields</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_sparse_fields</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_sparse_fields</span> <span class="o">=</span> <span class="n">sparse_fields</span>

        <span class="c1"># if we specify an atom subset of the main POSITIONS field</span>
        <span class="c1"># we must save them</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_main_rep_idxs</span> <span class="o">=</span> <span class="n">main_rep_idxs</span>

        <span class="c1"># a dictionary specifying other alt_reps to be saved</span>
        <span class="k">if</span> <span class="n">alt_reps</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_alt_reps</span> <span class="o">=</span> <span class="n">alt_reps</span>
            <span class="c1"># all alt_reps are sparse</span>
            <span class="n">alt_rep_keys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;alt_reps/</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_alt_reps</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_sparse_fields</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">alt_rep_keys</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_alt_reps</span> <span class="o">=</span> <span class="p">{}</span>


        <span class="c1"># open the file and then run the different constructors based</span>
        <span class="c1"># on the mode</span>
        <span class="k">with</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_h5py_mode</span><span class="p">)</span> <span class="k">as</span> <span class="n">h5</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_h5</span> <span class="o">=</span> <span class="n">h5</span>

            <span class="c1"># create file mode: &#39;w&#39; will create a new file or overwrite,</span>
            <span class="c1"># &#39;w-&#39; and &#39;x&#39; will not overwrite but will create a new file</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wepy_mode</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="s1">&#39;w-&#39;</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_create_init</span><span class="p">()</span>

            <span class="c1"># read/write mode: in this mode we do not completely overwrite</span>
            <span class="c1"># the old file and start again but rather write over top of</span>
            <span class="c1"># values if requested</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wepy_mode</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;r+&#39;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_read_write_init</span><span class="p">()</span>

            <span class="c1"># add mode: read/write create if doesn&#39;t exist</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wepy_mode</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">osp</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_filename</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_read_write_init</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_create_init</span><span class="p">()</span>

            <span class="c1"># read only mode</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wepy_mode</span> <span class="o">==</span> <span class="s1">&#39;r&#39;</span><span class="p">:</span>

                <span class="c1"># if any data was given, warn the user</span>
                <span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="n">kwarg</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">kwarg</span> <span class="ow">in</span>
                        <span class="p">[</span><span class="n">topology</span><span class="p">,</span> <span class="n">units</span><span class="p">,</span> <span class="n">sparse_fields</span><span class="p">,</span>
                         <span class="n">feature_shapes</span><span class="p">,</span> <span class="n">feature_dtypes</span><span class="p">,</span>
                         <span class="n">n_dims</span><span class="p">,</span> <span class="n">alt_reps</span><span class="p">,</span> <span class="n">main_rep_idxs</span><span class="p">]]):</span>
                   <span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Data was given but opening in read-only mode&quot;</span><span class="p">,</span> <span class="ne">RuntimeWarning</span><span class="p">)</span>

                <span class="c1"># then run the initialization process</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_read_init</span><span class="p">()</span>

            <span class="c1"># flush the buffers</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_h5</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

            <span class="c1"># set the h5py mode to the value in the actual h5py.File</span>
            <span class="c1"># object after creation</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_h5py_mode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_h5</span><span class="o">.</span><span class="n">mode</span>

        <span class="c1"># get rid of the temporary variables</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_topology</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_units</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_dims</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_coords</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_field_feature_shapes_kwarg</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_field_feature_dtypes_kwarg</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_field_feature_shapes</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_field_feature_dtypes</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sparse_fields</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_main_rep_idxs</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_alt_reps</span>

        <span class="c1"># variable to reflect if it is closed or not, should be closed</span>
        <span class="c1"># after initialization</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">closed</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># end of the constructor</span>
        <span class="k">return</span> <span class="kc">None</span>


    <span class="c1"># context manager methods</span>

    <span class="k">def</span> <span class="nf">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_h5</span> <span class="o">=</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_filename</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">closed</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_value</span><span class="p">,</span> <span class="n">exc_tb</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_h5</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>


    <span class="c1"># custom deepcopy to avoid copying the actual HDF5 object</span>


    <span class="c1"># constructors</span>
    <span class="k">def</span> <span class="nf">_create_init</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Completely overwrite the data in the file. Reinitialize the values</span>
<span class="sd">        and set with the new ones if given.&quot;&quot;&quot;</span>

        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_topology</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> \
            <span class="s2">&quot;Topology must be given for a creation constructor&quot;</span>

        <span class="c1"># initialize the runs group</span>
        <span class="n">runs_grp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_h5</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="s1">&#39;runs&#39;</span><span class="p">)</span>

        <span class="c1"># initialize the settings group</span>
        <span class="n">settings_grp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_h5</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="s1">&#39;_settings&#39;</span><span class="p">)</span>

        <span class="c1"># create the topology dataset</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_h5</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s1">&#39;topology&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_topology</span><span class="p">)</span>

        <span class="c1"># sparse fields</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sparse_fields</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

            <span class="c1"># make a dataset for the sparse fields allowed.  this requires</span>
            <span class="c1"># a &#39;special&#39; datatype for variable length strings. This is</span>
            <span class="c1"># supported by HDF5 but not numpy.</span>
            <span class="n">vlen_str_dt</span> <span class="o">=</span> <span class="n">h5py</span><span class="o">.</span><span class="n">special_dtype</span><span class="p">(</span><span class="n">vlen</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>

            <span class="c1"># create the dataset with empty values for the length of the</span>
            <span class="c1"># sparse fields given</span>
            <span class="n">sparse_fields_ds</span> <span class="o">=</span> <span class="n">settings_grp</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s1">&#39;sparse_fields&#39;</span><span class="p">,</span>
                                                           <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_sparse_fields</span><span class="p">),),</span>
                                                           <span class="n">dtype</span><span class="o">=</span><span class="n">vlen_str_dt</span><span class="p">,</span>
                                                           <span class="n">maxshape</span><span class="o">=</span><span class="p">(</span><span class="kc">None</span><span class="p">,))</span>

            <span class="c1"># set the flags</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">sparse_field</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_sparse_fields</span><span class="p">):</span>
                <span class="n">sparse_fields_ds</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">sparse_field</span>


        <span class="c1"># field feature shapes and dtypes</span>

        <span class="c1"># initialize to the defaults, this gives values to</span>
        <span class="c1"># self._n_coords, and self.field_feature_dtypes, and</span>
        <span class="c1"># self.field_feature_shapes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_default_init_field_attributes</span><span class="p">(</span><span class="n">n_dims</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_dims</span><span class="p">)</span>

        <span class="c1"># save the number of dimensions and number of atoms in settings</span>
        <span class="n">settings_grp</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s1">&#39;n_dims&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_dims</span><span class="p">))</span>
        <span class="n">settings_grp</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s1">&#39;n_atoms&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_coords</span><span class="p">))</span>

        <span class="c1"># the main rep atom idxs</span>
        <span class="n">settings_grp</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s1">&#39;main_rep_idxs&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_main_rep_idxs</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">)</span>

        <span class="c1"># alt_reps settings</span>
        <span class="n">alt_reps_idxs_grp</span> <span class="o">=</span> <span class="n">settings_grp</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="s2">&quot;alt_reps_idxs&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">alt_rep_name</span><span class="p">,</span> <span class="n">idxs</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_alt_reps</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">alt_reps_idxs_grp</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="n">alt_rep_name</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">idxs</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">)</span>

        <span class="c1"># if both feature shapes and dtypes were specified overwrite</span>
        <span class="c1"># (or initialize if not set by defaults) the defaults</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_field_feature_shapes_kwarg</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span>\
           <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_field_feature_dtypes_kwarg</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_field_feature_shapes</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_field_feature_shapes_kwarg</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_field_feature_dtypes</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_field_feature_dtypes_kwarg</span><span class="p">)</span>

        <span class="c1"># any sparse field with unspecified shape and dtype must be</span>
        <span class="c1"># set to None so that it will be set at runtime</span>
        <span class="k">for</span> <span class="n">sparse_field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sparse_fields</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">sparse_field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_field_feature_shapes</span><span class="p">)</span> <span class="ow">or</span> \
               <span class="p">(</span><span class="ow">not</span> <span class="n">sparse_field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_field_feature_dtypes</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_field_feature_shapes</span><span class="p">[</span><span class="n">sparse_field</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_field_feature_dtypes</span><span class="p">[</span><span class="n">sparse_field</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>


        <span class="c1"># save the field feature shapes and dtypes in the settings group</span>
        <span class="n">shapes_grp</span> <span class="o">=</span> <span class="n">settings_grp</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="s1">&#39;field_feature_shapes&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">field_path</span><span class="p">,</span> <span class="n">field_shape</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_field_feature_shapes</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">field_shape</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># set it as a dimensionless array of NaN</span>
                <span class="n">field_shape</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>

            <span class="n">shapes_grp</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="n">field_path</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">field_shape</span><span class="p">)</span>

        <span class="n">dtypes_grp</span> <span class="o">=</span> <span class="n">settings_grp</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="s1">&#39;field_feature_dtypes&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">field_path</span><span class="p">,</span> <span class="n">field_dtype</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_field_feature_dtypes</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">field_dtype</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">dt_str</span> <span class="o">=</span> <span class="s1">&#39;None&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># make a json string of the datatype that can be read</span>
                <span class="c1"># in again, we call np.dtype again because there is no</span>
                <span class="c1"># np.float.descr attribute</span>
                <span class="n">dt_str</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="n">field_dtype</span><span class="p">)</span><span class="o">.</span><span class="n">descr</span><span class="p">)</span>

            <span class="n">dtypes_grp</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="n">field_path</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">dt_str</span><span class="p">)</span>

        <span class="c1"># initialize the units group</span>
        <span class="n">unit_grp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_h5</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="s1">&#39;units&#39;</span><span class="p">)</span>

        <span class="c1"># if units were not given set them all to None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_units</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_units</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">field_path</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_field_feature_shapes</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_units</span><span class="p">[</span><span class="n">field_path</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># set the units</span>
        <span class="k">for</span> <span class="n">field_path</span><span class="p">,</span> <span class="n">unit_value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_units</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>

            <span class="c1"># ignore the field if not given</span>
            <span class="k">if</span> <span class="n">unit_value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">unit_path</span> <span class="o">=</span> <span class="s1">&#39;/units/</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">field_path</span><span class="p">)</span>

            <span class="n">unit_grp</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="n">unit_path</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">unit_value</span><span class="p">)</span>


        <span class="c1"># create the group for the run data records</span>
        <span class="n">records_grp</span> <span class="o">=</span> <span class="n">settings_grp</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="s1">&#39;record_fields&#39;</span><span class="p">)</span>

        <span class="c1"># create a dataset for the continuation run tuples</span>
        <span class="c1"># (continuation_run, base_run), where the first element</span>
        <span class="c1"># of the new run that is continuing the run in the second</span>
        <span class="c1"># position</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_init_continuations</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_read_write_init</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Write over values if given but do not reinitialize any old ones. &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_read_init</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_add_init</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create the dataset if it doesn&#39;t exist and put it in r+ mode,</span>
<span class="sd">        otherwise, just open in r+ mode.&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_exist_flags</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_create_init</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_read_write_init</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_read_init</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Read only initialization currently has nothing to do.&quot;&quot;&quot;</span>

        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">_get_field_path_grp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run_idx</span><span class="p">,</span> <span class="n">traj_idx</span><span class="p">,</span> <span class="n">field_path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Given a field path for the trajectory returns the group the field&#39;s</span>
<span class="sd">        dataset goes in and the key for the field name in that group.</span>

<span class="sd">        The field path for a simple field is just the name of the</span>
<span class="sd">        field and for a compound field it is the compound field group</span>
<span class="sd">        name with the subfield separated by a &#39;/&#39; like</span>
<span class="sd">        &#39;observables/observable1&#39; where &#39;observables&#39; is the compound</span>
<span class="sd">        field group and &#39;observable1&#39; is the subfield name.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># check if it is compound</span>
        <span class="k">if</span> <span class="s1">&#39;/&#39;</span> <span class="ow">in</span> <span class="n">field_path</span><span class="p">:</span>
            <span class="c1"># split it</span>
            <span class="n">grp_name</span><span class="p">,</span> <span class="n">field_name</span> <span class="o">=</span> <span class="n">field_path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
            <span class="c1"># get the hdf5 group</span>
            <span class="n">grp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">h5</span><span class="p">[</span><span class="s1">&#39;runs/</span><span class="si">{}</span><span class="s1">/trajectories/</span><span class="si">{}</span><span class="s1">/</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">run_idx</span><span class="p">,</span> <span class="n">traj_idx</span><span class="p">,</span> <span class="n">grp_name</span><span class="p">)]</span>
        <span class="c1"># its simple so just return the root group and the original path</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">grp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">h5</span>
            <span class="n">field_name</span> <span class="o">=</span> <span class="n">field_path</span>

        <span class="k">return</span> <span class="n">grp</span><span class="p">,</span> <span class="n">field_name</span>

    <span class="k">def</span> <span class="nf">_set_default_init_field_attributes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_dims</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Sets the feature_shapes and feature_dtypes to be the default for</span>
<span class="sd">        this module. These will be used to initialize field datasets when no</span>
<span class="sd">        given during construction (i.e. for sparse values)&quot;&quot;&quot;</span>

        <span class="c1"># we use the module defaults for the datasets to initialize them</span>
        <span class="n">field_feature_shapes</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">FIELD_FEATURE_SHAPES</span><span class="p">)</span>
        <span class="n">field_feature_dtypes</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">FIELD_FEATURE_DTYPES</span><span class="p">)</span>


        <span class="c1"># get the number of coordinates of positions. If there is a</span>
        <span class="c1"># main_reps then we have to set the number of atoms to that,</span>
        <span class="c1"># if not we count the number of atoms in the topology</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_main_rep_idxs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_n_coords</span> <span class="o">=</span> <span class="n">json_top_atom_count</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">topology</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_main_rep_idxs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_coords</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_n_coords</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_main_rep_idxs</span><span class="p">)</span>

        <span class="c1"># get the number of dimensions as a default</span>
        <span class="k">if</span> <span class="n">n_dims</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_n_dims</span> <span class="o">=</span> <span class="n">N_DIMS</span>

        <span class="c1"># feature shapes for positions and positions-like fields are</span>
        <span class="c1"># not known at the module level due to different number of</span>
        <span class="c1"># coordinates (number of atoms) and number of dimensions</span>
        <span class="c1"># (default 3 spatial). We set them now that we know this</span>
        <span class="c1"># information.</span>
        <span class="c1"># add the postitions shape</span>
        <span class="n">field_feature_shapes</span><span class="p">[</span><span class="n">POSITIONS</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_coords</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_dims</span><span class="p">)</span>
        <span class="c1"># add the positions-like field shapes (velocities and forces) as the same</span>
        <span class="k">for</span> <span class="n">poslike_field</span> <span class="ow">in</span> <span class="n">POSITIONS_LIKE_FIELDS</span><span class="p">:</span>
            <span class="n">field_feature_shapes</span><span class="p">[</span><span class="n">poslike_field</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_coords</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_dims</span><span class="p">)</span>

        <span class="c1"># set the attributes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_field_feature_shapes</span> <span class="o">=</span> <span class="n">field_feature_shapes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_field_feature_dtypes</span> <span class="o">=</span> <span class="n">field_feature_dtypes</span>


    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">filename</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filename</span>

<div class="viewcode-block" id="WepyHDF5.open"><a class="viewcode-back" href="../../api/wepy.html#wepy.hdf5.WepyHDF5.open">[docs]</a>    <span class="k">def</span> <span class="nf">open</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">closed</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_h5</span> <span class="o">=</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_filename</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_h5py_mode</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">closed</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s2">&quot;This file is already open&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="WepyHDF5.close"><a class="viewcode-back" href="../../api/wepy.html#wepy.hdf5.WepyHDF5.close">[docs]</a>    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">closed</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_h5</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">closed</span> <span class="o">=</span> <span class="kc">True</span></div>

    <span class="c1"># TODO is this right? shouldn&#39;t we actually delete the data then close</span>
    <span class="k">def</span> <span class="nf">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<div class="viewcode-block" id="WepyHDF5.clone"><a class="viewcode-back" href="../../api/wepy.html#wepy.hdf5.WepyHDF5.clone">[docs]</a>    <span class="k">def</span> <span class="nf">clone</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Clones this WepyHDF5 file without any of the actual runs and run</span>
<span class="sd">        data. This includes the topology, units, sparse_fields,</span>
<span class="sd">        feature shapes and dtypes, alt_reps, and main representation</span>
<span class="sd">        information.</span>

<span class="sd">        This method will flush the buffers for this file.</span>

<span class="sd">        Does not preserve metadata pertaining to inter-run</span>
<span class="sd">        relationships like continuations.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">assert</span> <span class="n">mode</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="s1">&#39;w-&#39;</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">],</span> <span class="s2">&quot;must be opened in a file creation mode&quot;</span>

        <span class="c1"># we manually construct an HDF5 and copy the groups over</span>
        <span class="n">new_h5</span> <span class="o">=</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">)</span>

        <span class="n">new_h5</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="s1">&#39;runs&#39;</span><span class="p">)</span>

        <span class="c1"># flush the datasets buffers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">h5</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="n">new_h5</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

        <span class="c1"># copy the existing datasets to the new one</span>
        <span class="n">h5py</span><span class="o">.</span><span class="n">h5o</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_h5</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;topology&#39;</span><span class="p">,</span> <span class="n">new_h5</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;topology&#39;</span><span class="p">)</span>
        <span class="n">h5py</span><span class="o">.</span><span class="n">h5o</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_h5</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;units&#39;</span><span class="p">,</span> <span class="n">new_h5</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;units&#39;</span><span class="p">)</span>
        <span class="n">h5py</span><span class="o">.</span><span class="n">h5o</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_h5</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;_settings&#39;</span><span class="p">,</span> <span class="n">new_h5</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;_settings&#39;</span><span class="p">)</span>

        <span class="c1"># for the settings we need to get rid of the data for interun</span>
        <span class="c1"># relationships like the continuations, so we reinitialize the</span>
        <span class="c1"># continuations</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_init_continuations</span><span class="p">()</span>

        <span class="c1"># now make a WepyHDF5 object in &quot;expert_mode&quot; which means it</span>
        <span class="c1"># is just empy and we construct it manually, &quot;surgically&quot; as I</span>
        <span class="c1"># like to call it</span>
        <span class="n">new_wepy_h5</span> <span class="o">=</span> <span class="n">WepyHDF5</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">expert_mode</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># perform the surgery:</span>

        <span class="c1"># attach the h5py.File</span>
        <span class="n">new_wepy_h5</span><span class="o">.</span><span class="n">_h5</span> <span class="o">=</span> <span class="n">new_h5</span>
        <span class="c1"># set the wepy mode to read-write since the creation flags</span>
        <span class="c1"># were already used in construction of the h5py.File object</span>
        <span class="n">new_wepy_h5</span><span class="o">.</span><span class="n">_wepy_mode</span> <span class="o">=</span> <span class="s1">&#39;r+&#39;</span>
        <span class="n">new_wepy_h5</span><span class="o">.</span><span class="n">_h5py_mode</span> <span class="o">=</span> <span class="s1">&#39;r+&#39;</span>

        <span class="c1"># close the h5py.File and set the attribute to closed</span>
        <span class="n">new_wepy_h5</span><span class="o">.</span><span class="n">_h5</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">new_wepy_h5</span><span class="o">.</span><span class="n">closed</span> <span class="o">=</span> <span class="kc">True</span>


        <span class="c1"># return the runless WepyHDF5 object</span>
        <span class="k">return</span> <span class="n">new_wepy_h5</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">mode</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wepy_mode</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">h5_mode</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_h5</span><span class="o">.</span><span class="n">mode</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">h5</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_h5</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">n_trajs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">run_traj_idx_tuples</span><span class="p">()))</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">settings_grp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">settings_grp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">h5</span><span class="p">[</span><span class="s1">&#39;_settings&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">settings_grp</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">n_atoms</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">h5</span><span class="p">[</span><span class="s1">&#39;_settings/n_atoms&#39;</span><span class="p">][()]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">n_dims</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">h5</span><span class="p">[</span><span class="s1">&#39;_settings/n_dims&#39;</span><span class="p">][()]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">topology</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The topology for the full simulated system. May not be the main</span>
<span class="sd">        representation in the POSITIONS field; for that use the</span>
<span class="sd">        `topology` method.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_h5</span><span class="p">[</span><span class="s1">&#39;topology&#39;</span><span class="p">][()]</span>


<div class="viewcode-block" id="WepyHDF5.get_mdtraj_topology"><a class="viewcode-back" href="../../api/wepy.html#wepy.hdf5.WepyHDF5.get_mdtraj_topology">[docs]</a>    <span class="k">def</span> <span class="nf">get_mdtraj_topology</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">alt_rep</span><span class="o">=</span><span class="n">POSITIONS</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get an MDTraj `Topology` object for a subset of the atoms in the</span>
<span class="sd">        positions of a particular representation. By default gives the</span>
<span class="sd">        topology for the main &#39;positions&#39; field (when alt_rep</span>
<span class="sd">        &#39;positions&#39;). To get the full topology the file was</span>
<span class="sd">        initialized with set `alt_rep` to `None`. Topologies for</span>
<span class="sd">        alternative representations (subfields of &#39;alt_reps&#39;) can be</span>
<span class="sd">        obtained by passing in the key for that alt_rep. For example,</span>
<span class="sd">        &#39;all_atoms&#39; for the field in alt_reps called &#39;all_atoms&#39;.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">full_mdj_top</span> <span class="o">=</span> <span class="n">json_to_mdtraj_topology</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">topology</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">alt_rep</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">full_mdj_top</span>
        <span class="k">elif</span> <span class="n">alt_rep</span> <span class="o">==</span> <span class="n">POSITIONS</span><span class="p">:</span>
            <span class="c1"># get the subset topology for the main rep idxs</span>
            <span class="k">return</span> <span class="n">full_mdj_top</span><span class="o">.</span><span class="n">subset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">main_rep_idxs</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">alt_rep</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">alt_rep_idxs</span><span class="p">:</span>
            <span class="c1"># get the subset for the alt rep</span>
            <span class="k">return</span> <span class="n">full_mdj_top</span><span class="o">.</span><span class="n">subset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">alt_rep_idxs</span><span class="p">[</span><span class="n">alt_rep</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;alt_rep </span><span class="si">{}</span><span class="s2"> not found&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">alt_rep</span><span class="p">))</span></div>

<div class="viewcode-block" id="WepyHDF5.get_topology"><a class="viewcode-back" href="../../api/wepy.html#wepy.hdf5.WepyHDF5.get_topology">[docs]</a>    <span class="k">def</span> <span class="nf">get_topology</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">alt_rep</span><span class="o">=</span><span class="n">POSITIONS</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get a JSON topology for a subset of the atoms in the</span>
<span class="sd">        positions of a particular representation. By default gives the</span>
<span class="sd">        topology for the main &#39;positions&#39; field (when alt_rep</span>
<span class="sd">        &#39;positions&#39;). To get the full topology the file was</span>
<span class="sd">        initialized with set `alt_rep` to `None`. Topologies for</span>
<span class="sd">        alternative representations (subfields of &#39;alt_reps&#39;) can be</span>
<span class="sd">        obtained by passing in the key for that alt_rep. For example,</span>
<span class="sd">        &#39;all_atoms&#39; for the field in alt_reps called &#39;all_atoms&#39;.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">mdj_top</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_mdtraj_topology</span><span class="p">(</span><span class="n">alt_rep</span><span class="o">=</span><span class="n">alt_rep</span><span class="p">)</span>
        <span class="n">json_top</span> <span class="o">=</span> <span class="n">mdtraj_to_json_topology</span><span class="p">(</span><span class="n">mdj_top</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">json_top</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">sparse_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">h5</span><span class="p">[</span><span class="s1">&#39;_settings/sparse_fields&#39;</span><span class="p">][:]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">main_rep_idxs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="s1">&#39;/_settings/main_rep_idxs&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">h5</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">h5</span><span class="p">[</span><span class="s1">&#39;/_settings/main_rep_idxs&#39;</span><span class="p">][:]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">alt_rep_idxs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">idxs_grp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">h5</span><span class="p">[</span><span class="s1">&#39;/_settings/alt_reps_idxs&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">name</span> <span class="p">:</span> <span class="n">ds</span><span class="p">[:]</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">ds</span> <span class="ow">in</span> <span class="n">idxs_grp</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">field_feature_shapes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">shapes_grp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">h5</span><span class="p">[</span><span class="s1">&#39;_settings/field_feature_shapes&#39;</span><span class="p">]</span>

        <span class="n">field_paths</span> <span class="o">=</span> <span class="n">iter_field_paths</span><span class="p">(</span><span class="n">shapes_grp</span><span class="p">)</span>

        <span class="n">shapes</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">field_path</span> <span class="ow">in</span> <span class="n">field_paths</span><span class="p">:</span>
            <span class="n">shape</span> <span class="o">=</span> <span class="n">shapes_grp</span><span class="p">[</span><span class="n">field_path</span><span class="p">][()]</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
                <span class="n">shapes</span><span class="p">[</span><span class="n">field_path</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">shapes</span><span class="p">[</span><span class="n">field_path</span><span class="p">]</span> <span class="o">=</span> <span class="n">shape</span>

        <span class="k">return</span> <span class="n">shapes</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">field_feature_dtypes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">dtypes_grp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">h5</span><span class="p">[</span><span class="s1">&#39;_settings/field_feature_dtypes&#39;</span><span class="p">]</span>

        <span class="n">field_paths</span> <span class="o">=</span> <span class="n">iter_field_paths</span><span class="p">(</span><span class="n">dtypes_grp</span><span class="p">)</span>

        <span class="n">dtypes</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">field_path</span> <span class="ow">in</span> <span class="n">field_paths</span><span class="p">:</span>
            <span class="n">dtype_str</span> <span class="o">=</span> <span class="n">dtypes_grp</span><span class="p">[</span><span class="n">field_path</span><span class="p">][()]</span>
            <span class="c1"># if there is &#39;None&#39; flag for the dtype then return None</span>
            <span class="k">if</span> <span class="n">dtype_str</span> <span class="o">==</span> <span class="s1">&#39;None&#39;</span><span class="p">:</span>
                <span class="n">dtypes</span><span class="p">[</span><span class="n">field_path</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">dtype_obj</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">dtype_str</span><span class="p">)</span>
                <span class="n">dtype_obj</span> <span class="o">=</span> <span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">dtype_obj</span><span class="p">]</span>
                <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="n">dtype_obj</span><span class="p">)</span>
                <span class="n">dtypes</span><span class="p">[</span><span class="n">field_path</span><span class="p">]</span> <span class="o">=</span> <span class="n">dtype</span>

        <span class="k">return</span> <span class="n">dtypes</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">continuations</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings_grp</span><span class="p">[</span><span class="s1">&#39;continuations&#39;</span><span class="p">][:]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_h5</span><span class="o">.</span><span class="n">attrs</span><span class="p">)</span>

<div class="viewcode-block" id="WepyHDF5.add_metadata"><a class="viewcode-back" href="../../api/wepy.html#wepy.hdf5.WepyHDF5.add_metadata">[docs]</a>    <span class="k">def</span> <span class="nf">add_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_h5</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">runs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">h5</span><span class="p">[</span><span class="s1">&#39;runs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">n_runs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_h5</span><span class="p">[</span><span class="s1">&#39;runs&#39;</span><span class="p">])</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">run_idxs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_h5</span><span class="p">[</span><span class="s1">&#39;runs&#39;</span><span class="p">])))</span>

<div class="viewcode-block" id="WepyHDF5.next_run_idx"><a class="viewcode-back" href="../../api/wepy.html#wepy.hdf5.WepyHDF5.next_run_idx">[docs]</a>    <span class="k">def</span> <span class="nf">next_run_idx</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_runs</span></div>

<div class="viewcode-block" id="WepyHDF5.run"><a class="viewcode-back" href="../../api/wepy.html#wepy.hdf5.WepyHDF5.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run_idx</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_h5</span><span class="p">[</span><span class="s1">&#39;runs/</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">run_idx</span><span class="p">))]</span></div>

<div class="viewcode-block" id="WepyHDF5.traj"><a class="viewcode-back" href="../../api/wepy.html#wepy.hdf5.WepyHDF5.traj">[docs]</a>    <span class="k">def</span> <span class="nf">traj</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run_idx</span><span class="p">,</span> <span class="n">traj_idx</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_h5</span><span class="p">[</span><span class="s1">&#39;runs/</span><span class="si">{}</span><span class="s1">/trajectories/</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">run_idx</span><span class="p">,</span> <span class="n">traj_idx</span><span class="p">)]</span></div>

    <span class="k">def</span> <span class="nf">traj_n_frames</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run_idx</span><span class="p">,</span> <span class="n">traj_idx</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">traj</span><span class="p">(</span><span class="n">run_idx</span><span class="p">,</span> <span class="n">traj_idx</span><span class="p">)[</span><span class="n">POSITIONS</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

<div class="viewcode-block" id="WepyHDF5.run_n_frames"><a class="viewcode-back" href="../../api/wepy.html#wepy.hdf5.WepyHDF5.run_n_frames">[docs]</a>    <span class="k">def</span> <span class="nf">run_n_frames</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run_idx</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">traj_n_frames</span><span class="p">(</span><span class="n">run_idx</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span></div>

<div class="viewcode-block" id="WepyHDF5.run_n_cycles"><a class="viewcode-back" href="../../api/wepy.html#wepy.hdf5.WepyHDF5.run_n_cycles">[docs]</a>    <span class="k">def</span> <span class="nf">run_n_cycles</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run_idx</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_n_frames</span><span class="p">(</span><span class="n">run_idx</span><span class="p">)</span></div>

<div class="viewcode-block" id="WepyHDF5.run_trajs"><a class="viewcode-back" href="../../api/wepy.html#wepy.hdf5.WepyHDF5.run_trajs">[docs]</a>    <span class="k">def</span> <span class="nf">run_trajs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run_idx</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_h5</span><span class="p">[</span><span class="s1">&#39;runs/</span><span class="si">{}</span><span class="s1">/trajectories&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">run_idx</span><span class="p">)]</span></div>

<div class="viewcode-block" id="WepyHDF5.n_run_trajs"><a class="viewcode-back" href="../../api/wepy.html#wepy.hdf5.WepyHDF5.n_run_trajs">[docs]</a>    <span class="k">def</span> <span class="nf">n_run_trajs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run_idx</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_h5</span><span class="p">[</span><span class="s1">&#39;runs/</span><span class="si">{}</span><span class="s1">/trajectories&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">run_idx</span><span class="p">)])</span></div>

<div class="viewcode-block" id="WepyHDF5.next_run_traj_idx"><a class="viewcode-back" href="../../api/wepy.html#wepy.hdf5.WepyHDF5.next_run_traj_idx">[docs]</a>    <span class="k">def</span> <span class="nf">next_run_traj_idx</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run_idx</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_run_trajs</span><span class="p">(</span><span class="n">run_idx</span><span class="p">)</span></div>

<div class="viewcode-block" id="WepyHDF5.run_traj_idxs"><a class="viewcode-back" href="../../api/wepy.html#wepy.hdf5.WepyHDF5.run_traj_idxs">[docs]</a>    <span class="k">def</span> <span class="nf">run_traj_idxs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run_idx</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_h5</span><span class="p">[</span><span class="s1">&#39;runs/</span><span class="si">{}</span><span class="s1">/trajectories&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">run_idx</span><span class="p">)]))</span></div>

<div class="viewcode-block" id="WepyHDF5.run_traj_idx_tuples"><a class="viewcode-back" href="../../api/wepy.html#wepy.hdf5.WepyHDF5.run_traj_idx_tuples">[docs]</a>    <span class="k">def</span> <span class="nf">run_traj_idx_tuples</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">runs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">tups</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">runs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">run_idxs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_idxs</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">run_idxs</span> <span class="o">=</span> <span class="n">runs</span>
        <span class="k">for</span> <span class="n">run_idx</span> <span class="ow">in</span> <span class="n">run_idxs</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">traj_idx</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_traj_idxs</span><span class="p">(</span><span class="n">run_idx</span><span class="p">):</span>
                <span class="n">tups</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">run_idx</span><span class="p">,</span> <span class="n">traj_idx</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">tups</span></div>

    <span class="k">def</span> <span class="nf">_init_continuations</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This will either create a dataset in the settings for the</span>
<span class="sd">        continuations or if continuations already exist it will reinitialize</span>
<span class="sd">        them and delete the data that exists there.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># if the continuations dset already exists we reinitialize the</span>
        <span class="c1"># data</span>
        <span class="k">if</span> <span class="s1">&#39;continuations&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings_grp</span><span class="p">:</span>
            <span class="n">cont_dset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings_grp</span><span class="p">[</span><span class="s1">&#39;continuations&#39;</span><span class="p">]</span>
            <span class="n">cont_dset</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="p">)</span>

        <span class="c1"># otherwise we just create the data</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cont_dset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings_grp</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s1">&#39;continuations&#39;</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">,</span>
                                    <span class="n">maxshape</span><span class="o">=</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">cont_dset</span>


<div class="viewcode-block" id="WepyHDF5.init_record_fields"><a class="viewcode-back" href="../../api/wepy.html#wepy.hdf5.WepyHDF5.init_record_fields">[docs]</a>    <span class="k">def</span> <span class="nf">init_record_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run_record_key</span><span class="p">,</span> <span class="n">record_fields</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Save which records are to be considered from a run record group&#39;s</span>
<span class="sd">        datasets to be in the table like representation. This exists</span>
<span class="sd">        to allow there to large and small datasets for records to be</span>
<span class="sd">        stored together but allow for a more compact single table like</span>
<span class="sd">        representation to be produced for serialization.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">record_fields_grp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings_grp</span><span class="p">[</span><span class="s1">&#39;record_fields&#39;</span><span class="p">]</span>

        <span class="c1"># make a dataset for the sparse fields allowed.  this requires</span>
        <span class="c1"># a &#39;special&#39; datatype for variable length strings. This is</span>
        <span class="c1"># supported by HDF5 but not numpy.</span>
        <span class="n">vlen_str_dt</span> <span class="o">=</span> <span class="n">h5py</span><span class="o">.</span><span class="n">special_dtype</span><span class="p">(</span><span class="n">vlen</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>

        <span class="c1"># create the dataset with the strings of the fields which are records</span>
        <span class="n">record_group_fields_ds</span> <span class="o">=</span> <span class="n">record_fields_grp</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="n">run_record_key</span><span class="p">,</span>
                                                             <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">record_fields</span><span class="p">),),</span>
                                                                  <span class="n">dtype</span><span class="o">=</span><span class="n">vlen_str_dt</span><span class="p">,</span>
                                                                  <span class="n">maxshape</span><span class="o">=</span><span class="p">(</span><span class="kc">None</span><span class="p">,))</span>

        <span class="c1"># set the flags</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">record_field</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">record_fields</span><span class="p">):</span>
            <span class="n">record_group_fields_ds</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">record_field</span></div>

<div class="viewcode-block" id="WepyHDF5.init_resampling_record_fields"><a class="viewcode-back" href="../../api/wepy.html#wepy.hdf5.WepyHDF5.init_resampling_record_fields">[docs]</a>    <span class="k">def</span> <span class="nf">init_resampling_record_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resampler</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_record_fields</span><span class="p">(</span><span class="n">RESAMPLING</span><span class="p">,</span> <span class="n">resampler</span><span class="o">.</span><span class="n">resampling_record_field_names</span><span class="p">())</span></div>

<div class="viewcode-block" id="WepyHDF5.init_resampler_record_fields"><a class="viewcode-back" href="../../api/wepy.html#wepy.hdf5.WepyHDF5.init_resampler_record_fields">[docs]</a>    <span class="k">def</span> <span class="nf">init_resampler_record_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resampler</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_record_fields</span><span class="p">(</span><span class="n">RESAMPLER</span><span class="p">,</span> <span class="n">resampler</span><span class="o">.</span><span class="n">resampler_record_field_names</span><span class="p">())</span></div>

<div class="viewcode-block" id="WepyHDF5.init_bc_record_fields"><a class="viewcode-back" href="../../api/wepy.html#wepy.hdf5.WepyHDF5.init_bc_record_fields">[docs]</a>    <span class="k">def</span> <span class="nf">init_bc_record_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bc</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_record_fields</span><span class="p">(</span><span class="n">BC</span><span class="p">,</span> <span class="n">bc</span><span class="o">.</span><span class="n">bc_record_field_names</span><span class="p">())</span></div>

<div class="viewcode-block" id="WepyHDF5.init_warping_record_fields"><a class="viewcode-back" href="../../api/wepy.html#wepy.hdf5.WepyHDF5.init_warping_record_fields">[docs]</a>    <span class="k">def</span> <span class="nf">init_warping_record_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bc</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_record_fields</span><span class="p">(</span><span class="n">WARPING</span><span class="p">,</span> <span class="n">bc</span><span class="o">.</span><span class="n">warping_record_field_names</span><span class="p">())</span></div>

<div class="viewcode-block" id="WepyHDF5.init_progress_record_fields"><a class="viewcode-back" href="../../api/wepy.html#wepy.hdf5.WepyHDF5.init_progress_record_fields">[docs]</a>    <span class="k">def</span> <span class="nf">init_progress_record_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bc</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_record_fields</span><span class="p">(</span><span class="n">PROGRESS</span><span class="p">,</span> <span class="n">bc</span><span class="o">.</span><span class="n">progress_record_field_names</span><span class="p">())</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">record_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">record_fields_grp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings_grp</span><span class="p">[</span><span class="s1">&#39;record_fields&#39;</span><span class="p">]</span>

        <span class="n">record_fields_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">group_name</span><span class="p">,</span> <span class="n">dset</span> <span class="ow">in</span> <span class="n">record_fields_grp</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">record_fields_dict</span><span class="p">[</span><span class="n">group_name</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">dset</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">record_fields_dict</span>

    <span class="k">def</span> <span class="nf">_add_run_init</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run_idx</span><span class="p">,</span> <span class="n">continue_run</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Routines for creating a run includes updating and setting object</span>
<span class="sd">        global variables, increasing the counter for the number of runs.&quot;&quot;&quot;</span>

        <span class="c1"># add the run idx as metadata in the run group</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_h5</span><span class="p">[</span><span class="s1">&#39;runs/</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">run_idx</span><span class="p">)]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;run_idx&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">run_idx</span>

        <span class="c1"># if this is continuing another run add the tuple (this_run,</span>
        <span class="c1"># continues_run) to the contig settings</span>
        <span class="k">if</span> <span class="n">continue_run</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">add_continuation</span><span class="p">(</span><span class="n">run_idx</span><span class="p">,</span> <span class="n">continue_run</span><span class="p">)</span>


<div class="viewcode-block" id="WepyHDF5.add_continuation"><a class="viewcode-back" href="../../api/wepy.html#wepy.hdf5.WepyHDF5.add_continuation">[docs]</a>    <span class="k">def</span> <span class="nf">add_continuation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">continuation_run</span><span class="p">,</span> <span class="n">base_run</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add a continuation between runs.</span>

<span class="sd">        continuation_run :: the run index of the run that continues base_run</span>

<span class="sd">        base_run :: the run that is being continued</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">continuations_dset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings_grp</span><span class="p">[</span><span class="s1">&#39;continuations&#39;</span><span class="p">]</span>
        <span class="n">continuations_dset</span><span class="o">.</span><span class="n">resize</span><span class="p">((</span><span class="n">continuations_dset</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">continuations_dset</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],))</span>
        <span class="n">continuations_dset</span><span class="p">[</span><span class="n">continuations_dset</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">continuation_run</span><span class="p">,</span> <span class="n">base_run</span><span class="p">])</span></div>

<div class="viewcode-block" id="WepyHDF5.link_run"><a class="viewcode-back" href="../../api/wepy.html#wepy.hdf5.WepyHDF5.link_run">[docs]</a>    <span class="k">def</span> <span class="nf">link_run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filepath</span><span class="p">,</span> <span class="n">run_idx</span><span class="p">,</span> <span class="n">continue_run</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add a run from another file to this one as an HDF5 external</span>
<span class="sd">        link. Intuitively this is like mounting a drive in a filesystem.&quot;&quot;&quot;</span>

        <span class="c1"># link to the external run</span>
        <span class="n">ext_run_link</span> <span class="o">=</span> <span class="n">h5py</span><span class="o">.</span><span class="n">ExternalLink</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="s1">&#39;runs/</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">run_idx</span><span class="p">))</span>

        <span class="c1"># the run index in this file, as determined by the counter</span>
        <span class="n">here_run_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">next_run_idx</span><span class="p">()</span>

        <span class="c1"># set the local run as the external link to the other run</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_h5</span><span class="p">[</span><span class="s1">&#39;runs/</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">here_run_idx</span><span class="p">)]</span> <span class="o">=</span> <span class="n">ext_run_link</span>

        <span class="c1"># run the initialization routines for adding a run</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_run_init</span><span class="p">(</span><span class="n">here_run_idx</span><span class="p">,</span> <span class="n">continue_run</span><span class="o">=</span><span class="n">continue_run</span><span class="p">)</span>

        <span class="n">run_grp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_h5</span><span class="p">[</span><span class="s1">&#39;runs/</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">here_run_idx</span><span class="p">)]</span>

        <span class="c1"># add metadata if given</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">!=</span> <span class="s1">&#39;run_idx&#39;</span><span class="p">:</span>
                <span class="n">run_grp</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">warn</span><span class="p">(</span><span class="s1">&#39;run_idx metadata is set by wepy and cannot be used&#39;</span><span class="p">,</span> <span class="ne">RuntimeWarning</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">here_run_idx</span></div>

<div class="viewcode-block" id="WepyHDF5.link_file_runs"><a class="viewcode-back" href="../../api/wepy.html#wepy.hdf5.WepyHDF5.link_file_runs">[docs]</a>    <span class="k">def</span> <span class="nf">link_file_runs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">wepy_h5_path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Link all runs from another WepyHDF5 file. This preserves</span>
<span class="sd">        continuations within that file. This will open the file if not</span>
<span class="sd">        already opened.</span>

<span class="sd">        returns the indices of the new runs in this file.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">wepy_h5</span> <span class="o">=</span> <span class="n">WepyHDF5</span><span class="p">(</span><span class="n">wepy_h5_path</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">wepy_h5</span><span class="p">:</span>
            <span class="n">ext_run_idxs</span> <span class="o">=</span> <span class="n">wepy_h5</span><span class="o">.</span><span class="n">run_idxs</span>
            <span class="n">continuations</span> <span class="o">=</span> <span class="n">wepy_h5</span><span class="o">.</span><span class="n">continuations</span>

        <span class="c1"># add the runs</span>
        <span class="n">new_run_idxs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">ext_run_idx</span> <span class="ow">in</span> <span class="n">ext_run_idxs</span><span class="p">:</span>

            <span class="c1"># link the next run, and get its new run index</span>
            <span class="n">new_run_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">link_run</span><span class="p">(</span><span class="n">wepy_h5_path</span><span class="p">,</span> <span class="n">ext_run_idx</span><span class="p">)</span>

            <span class="c1"># save that run idx</span>
            <span class="n">new_run_idxs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_run_idx</span><span class="p">)</span>

        <span class="c1"># copy the continuations over translating the run idxs,</span>
        <span class="c1"># for each continuation in the other files continuations</span>
        <span class="k">for</span> <span class="n">continuation</span> <span class="ow">in</span> <span class="n">continuations</span><span class="p">:</span>

            <span class="c1"># translate each run index from the external file</span>
            <span class="c1"># continuations to the run idxs they were just assigned in</span>
            <span class="c1"># this file</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_continuation</span><span class="p">(</span><span class="n">new_run_idxs</span><span class="p">[</span><span class="n">continuation</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span>
                                  <span class="n">new_run_idxs</span><span class="p">[</span><span class="n">continuation</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>

        <span class="k">return</span> <span class="n">new_run_idxs</span></div>


<div class="viewcode-block" id="WepyHDF5.new_run"><a class="viewcode-back" href="../../api/wepy.html#wepy.hdf5.WepyHDF5.new_run">[docs]</a>    <span class="k">def</span> <span class="nf">new_run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">continue_run</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

        <span class="c1"># check to see if the continue_run is actually in this file</span>
        <span class="k">if</span> <span class="n">continue_run</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">continue_run</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_idxs</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The continue_run idx given, </span><span class="si">{}</span><span class="s2">, is not present in this file&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">continue_run</span><span class="p">))</span>

        <span class="c1"># get the index for this run</span>
        <span class="n">new_run_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">next_run_idx</span><span class="p">()</span>

        <span class="c1"># create a new group named the next integer in the counter</span>
        <span class="n">run_grp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_h5</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="s1">&#39;runs/</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">new_run_idx</span><span class="p">))</span>

        <span class="c1"># initialize the walkers group</span>
        <span class="n">traj_grp</span> <span class="o">=</span> <span class="n">run_grp</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="s1">&#39;trajectories&#39;</span><span class="p">)</span>


        <span class="c1"># run the initialization routines for adding a run</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_run_init</span><span class="p">(</span><span class="n">new_run_idx</span><span class="p">,</span> <span class="n">continue_run</span><span class="o">=</span><span class="n">continue_run</span><span class="p">)</span>


        <span class="c1"># TODO get rid of this?</span>
        <span class="c1"># add metadata if given</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">!=</span> <span class="s1">&#39;run_idx&#39;</span><span class="p">:</span>
                <span class="n">run_grp</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">warn</span><span class="p">(</span><span class="s1">&#39;run_idx metadata is set by wepy and cannot be used&#39;</span><span class="p">,</span> <span class="ne">RuntimeWarning</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">run_grp</span></div>

    <span class="c1"># application level methods for setting the fields for run record</span>
    <span class="c1"># groups given the objects themselves</span>
<div class="viewcode-block" id="WepyHDF5.init_run_resampling"><a class="viewcode-back" href="../../api/wepy.html#wepy.hdf5.WepyHDF5.init_run_resampling">[docs]</a>    <span class="k">def</span> <span class="nf">init_run_resampling</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run_idx</span><span class="p">,</span> <span class="n">resampler</span><span class="p">):</span>

        <span class="c1"># set the enumeration of the decisions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_run_resampling_decision</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">resampler</span><span class="p">)</span>

        <span class="c1"># set the data fields that can be used for table like records</span>
        <span class="n">resampler</span><span class="o">.</span><span class="n">resampler_record_field_names</span><span class="p">()</span>
        <span class="n">resampler</span><span class="o">.</span><span class="n">resampling_record_field_names</span><span class="p">()</span>

        <span class="c1"># then make the records group</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="n">resampler</span><span class="o">.</span><span class="n">resampling_fields</span><span class="p">()</span>
        <span class="n">grp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_run_record_grp</span><span class="p">(</span><span class="n">run_idx</span><span class="p">,</span> <span class="n">RESAMPLING</span><span class="p">,</span> <span class="n">fields</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">grp</span></div>

<div class="viewcode-block" id="WepyHDF5.init_run_resampling_decision"><a class="viewcode-back" href="../../api/wepy.html#wepy.hdf5.WepyHDF5.init_run_resampling_decision">[docs]</a>    <span class="k">def</span> <span class="nf">init_run_resampling_decision</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run_idx</span><span class="p">,</span> <span class="n">resampler</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">init_run_fields_resampling_decision</span><span class="p">(</span><span class="n">run_idx</span><span class="p">,</span> <span class="n">resampler</span><span class="o">.</span><span class="n">DECISION</span><span class="o">.</span><span class="n">enum_dict_by_name</span><span class="p">())</span></div>

<div class="viewcode-block" id="WepyHDF5.init_run_resampler"><a class="viewcode-back" href="../../api/wepy.html#wepy.hdf5.WepyHDF5.init_run_resampler">[docs]</a>    <span class="k">def</span> <span class="nf">init_run_resampler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run_idx</span><span class="p">,</span> <span class="n">resampler</span><span class="p">):</span>

        <span class="n">fields</span> <span class="o">=</span> <span class="n">resampler</span><span class="o">.</span><span class="n">resampler_fields</span><span class="p">()</span>

        <span class="n">grp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_run_record_grp</span><span class="p">(</span><span class="n">run_idx</span><span class="p">,</span> <span class="n">RESAMPLER</span><span class="p">,</span> <span class="n">fields</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">grp</span></div>

<div class="viewcode-block" id="WepyHDF5.init_run_warping"><a class="viewcode-back" href="../../api/wepy.html#wepy.hdf5.WepyHDF5.init_run_warping">[docs]</a>    <span class="k">def</span> <span class="nf">init_run_warping</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run_idx</span><span class="p">,</span> <span class="n">bc</span><span class="p">):</span>

        <span class="n">fields</span> <span class="o">=</span> <span class="n">bc</span><span class="o">.</span><span class="n">warping_fields</span><span class="p">()</span>
        <span class="n">grp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_run_record_grp</span><span class="p">(</span><span class="n">run_idx</span><span class="p">,</span> <span class="n">WARPING</span><span class="p">,</span> <span class="n">fields</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">grp</span></div>

<div class="viewcode-block" id="WepyHDF5.init_run_progress"><a class="viewcode-back" href="../../api/wepy.html#wepy.hdf5.WepyHDF5.init_run_progress">[docs]</a>    <span class="k">def</span> <span class="nf">init_run_progress</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run_idx</span><span class="p">,</span> <span class="n">bc</span><span class="p">):</span>

        <span class="n">fields</span> <span class="o">=</span> <span class="n">bc</span><span class="o">.</span><span class="n">progress_fields</span><span class="p">()</span>

        <span class="n">grp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_run_record_grp</span><span class="p">(</span><span class="n">run_idx</span><span class="p">,</span> <span class="n">PROGRESS</span><span class="p">,</span> <span class="n">fields</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">grp</span></div>

<div class="viewcode-block" id="WepyHDF5.init_run_bc"><a class="viewcode-back" href="../../api/wepy.html#wepy.hdf5.WepyHDF5.init_run_bc">[docs]</a>    <span class="k">def</span> <span class="nf">init_run_bc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run_idx</span><span class="p">,</span> <span class="n">bc</span><span class="p">):</span>

        <span class="n">fields</span> <span class="o">=</span> <span class="n">bc</span><span class="o">.</span><span class="n">bc_fields</span><span class="p">()</span>

        <span class="n">grp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_run_record_grp</span><span class="p">(</span><span class="n">run_idx</span><span class="p">,</span> <span class="n">BC</span><span class="p">,</span> <span class="n">fields</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">grp</span></div>

    <span class="c1"># application level methods for initializing the run records</span>
    <span class="c1"># groups with just the fields and without the objects</span>
<div class="viewcode-block" id="WepyHDF5.init_run_fields_resampling"><a class="viewcode-back" href="../../api/wepy.html#wepy.hdf5.WepyHDF5.init_run_fields_resampling">[docs]</a>    <span class="k">def</span> <span class="nf">init_run_fields_resampling</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run_idx</span><span class="p">,</span> <span class="n">fields</span><span class="p">):</span>

        <span class="n">grp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_run_record_grp</span><span class="p">(</span><span class="n">run_idx</span><span class="p">,</span> <span class="n">RESAMPLING</span><span class="p">,</span> <span class="n">fields</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">grp</span></div>

<div class="viewcode-block" id="WepyHDF5.init_run_fields_resampling_decision"><a class="viewcode-back" href="../../api/wepy.html#wepy.hdf5.WepyHDF5.init_run_fields_resampling_decision">[docs]</a>    <span class="k">def</span> <span class="nf">init_run_fields_resampling_decision</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run_idx</span><span class="p">,</span> <span class="n">decision_enum_dict</span><span class="p">):</span>

        <span class="n">decision_grp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">run_idx</span><span class="p">)</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="s1">&#39;decision&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">decision_enum_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">decision_grp</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">value</span><span class="p">)</span></div>


<div class="viewcode-block" id="WepyHDF5.init_run_fields_resampler"><a class="viewcode-back" href="../../api/wepy.html#wepy.hdf5.WepyHDF5.init_run_fields_resampler">[docs]</a>    <span class="k">def</span> <span class="nf">init_run_fields_resampler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run_idx</span><span class="p">,</span> <span class="n">fields</span><span class="p">):</span>

        <span class="n">grp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_run_record_grp</span><span class="p">(</span><span class="n">run_idx</span><span class="p">,</span> <span class="n">RESAMPLER</span><span class="p">,</span> <span class="n">fields</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">grp</span></div>

<div class="viewcode-block" id="WepyHDF5.init_run_fields_warping"><a class="viewcode-back" href="../../api/wepy.html#wepy.hdf5.WepyHDF5.init_run_fields_warping">[docs]</a>    <span class="k">def</span> <span class="nf">init_run_fields_warping</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run_idx</span><span class="p">,</span> <span class="n">fields</span><span class="p">):</span>

        <span class="n">grp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_run_record_grp</span><span class="p">(</span><span class="n">run_idx</span><span class="p">,</span> <span class="n">WARPING</span><span class="p">,</span> <span class="n">fields</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">grp</span></div>

<div class="viewcode-block" id="WepyHDF5.init_run_fields_progress"><a class="viewcode-back" href="../../api/wepy.html#wepy.hdf5.WepyHDF5.init_run_fields_progress">[docs]</a>    <span class="k">def</span> <span class="nf">init_run_fields_progress</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run_idx</span><span class="p">,</span> <span class="n">fields</span><span class="p">):</span>

        <span class="n">grp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_run_record_grp</span><span class="p">(</span><span class="n">run_idx</span><span class="p">,</span> <span class="n">PROGRESS</span><span class="p">,</span> <span class="n">fields</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">grp</span></div>

<div class="viewcode-block" id="WepyHDF5.init_run_fields_bc"><a class="viewcode-back" href="../../api/wepy.html#wepy.hdf5.WepyHDF5.init_run_fields_bc">[docs]</a>    <span class="k">def</span> <span class="nf">init_run_fields_bc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run_idx</span><span class="p">,</span> <span class="n">fields</span><span class="p">):</span>

        <span class="n">grp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_run_record_grp</span><span class="p">(</span><span class="n">run_idx</span><span class="p">,</span> <span class="n">BC</span><span class="p">,</span> <span class="n">fields</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">grp</span></div>


<div class="viewcode-block" id="WepyHDF5.init_run_record_grp"><a class="viewcode-back" href="../../api/wepy.html#wepy.hdf5.WepyHDF5.init_run_record_grp">[docs]</a>    <span class="k">def</span> <span class="nf">init_run_record_grp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run_idx</span><span class="p">,</span> <span class="n">run_record_key</span><span class="p">,</span> <span class="n">fields</span><span class="p">):</span>

        <span class="c1"># initialize the record group based on whether it is sporadic</span>
        <span class="c1"># or continual</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_sporadic_records</span><span class="p">(</span><span class="n">run_record_key</span><span class="p">):</span>
            <span class="n">grp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_init_run_sporadic_record_grp</span><span class="p">(</span><span class="n">run_idx</span><span class="p">,</span> <span class="n">run_record_key</span><span class="p">,</span>
                                                     <span class="n">fields</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">grp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_init_run_continual_record_grp</span><span class="p">(</span><span class="n">run_idx</span><span class="p">,</span> <span class="n">run_record_key</span><span class="p">,</span>
                                                      <span class="n">fields</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_init_run_sporadic_record_grp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run_idx</span><span class="p">,</span> <span class="n">run_record_key</span><span class="p">,</span> <span class="n">fields</span><span class="p">):</span>

        <span class="c1"># create the group</span>
        <span class="n">run_grp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">run_idx</span><span class="p">)</span>
        <span class="n">record_grp</span> <span class="o">=</span> <span class="n">run_grp</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="n">run_record_key</span><span class="p">)</span>

        <span class="c1"># initialize the cycles dataset that maps when the records</span>
        <span class="c1"># were recorded</span>
        <span class="n">record_grp</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="n">CYCLE_IDXS</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">,</span>
                                  <span class="n">maxshape</span><span class="o">=</span><span class="p">(</span><span class="kc">None</span><span class="p">,))</span>

        <span class="c1"># for each field simply create the dataset</span>
        <span class="k">for</span> <span class="n">field_name</span><span class="p">,</span> <span class="n">field_shape</span><span class="p">,</span> <span class="n">field_dtype</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">:</span>

            <span class="c1"># initialize this field</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_init_run_records_field</span><span class="p">(</span><span class="n">run_idx</span><span class="p">,</span> <span class="n">run_record_key</span><span class="p">,</span>
                                         <span class="n">field_name</span><span class="p">,</span> <span class="n">field_shape</span><span class="p">,</span> <span class="n">field_dtype</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">record_grp</span>


    <span class="k">def</span> <span class="nf">_init_run_continual_record_grp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run_idx</span><span class="p">,</span> <span class="n">run_record_key</span><span class="p">,</span> <span class="n">fields</span><span class="p">):</span>

        <span class="c1"># create the group</span>
        <span class="n">run_grp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">run_idx</span><span class="p">)</span>
        <span class="n">record_grp</span> <span class="o">=</span> <span class="n">run_grp</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="n">run_record_key</span><span class="p">)</span>

        <span class="c1"># for each field simply create the dataset</span>
        <span class="k">for</span> <span class="n">field_name</span><span class="p">,</span> <span class="n">field_shape</span><span class="p">,</span> <span class="n">field_dtype</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">:</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_init_run_records_field</span><span class="p">(</span><span class="n">run_idx</span><span class="p">,</span> <span class="n">run_record_key</span><span class="p">,</span>
                                         <span class="n">field_name</span><span class="p">,</span> <span class="n">field_shape</span><span class="p">,</span> <span class="n">field_dtype</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">record_grp</span>

    <span class="k">def</span> <span class="nf">_init_run_records_field</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run_idx</span><span class="p">,</span> <span class="n">run_record_key</span><span class="p">,</span>
                                <span class="n">field_name</span><span class="p">,</span> <span class="n">field_shape</span><span class="p">,</span> <span class="n">field_dtype</span><span class="p">):</span>

        <span class="n">record_grp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">run_idx</span><span class="p">)[</span><span class="n">run_record_key</span><span class="p">]</span>

        <span class="c1"># check if it is variable length</span>
        <span class="k">if</span> <span class="n">field_shape</span> <span class="ow">is</span> <span class="bp">Ellipsis</span><span class="p">:</span>
            <span class="c1"># make a special dtype that allows it to be</span>
            <span class="c1"># variable length</span>
            <span class="n">vlen_dt</span> <span class="o">=</span> <span class="n">h5py</span><span class="o">.</span><span class="n">special_dtype</span><span class="p">(</span><span class="n">vlen</span><span class="o">=</span><span class="n">field_dtype</span><span class="p">)</span>

            <span class="c1"># this is only allowed to be a single dimension</span>
            <span class="c1"># since no real shape was given</span>
            <span class="n">dset</span> <span class="o">=</span> <span class="n">record_grp</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="n">field_name</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">vlen_dt</span><span class="p">,</span>
                                        <span class="n">maxshape</span><span class="o">=</span><span class="p">(</span><span class="kc">None</span><span class="p">,))</span>

        <span class="c1"># its not just make it normally</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># create the group</span>
            <span class="n">dset</span> <span class="o">=</span> <span class="n">record_grp</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="n">field_name</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">*</span><span class="n">field_shape</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">field_dtype</span><span class="p">,</span>
                                      <span class="n">maxshape</span><span class="o">=</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="n">field_shape</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">dset</span>

    <span class="k">def</span> <span class="nf">_is_sporadic_records</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run_record_key</span><span class="p">):</span>

        <span class="c1"># assume it is continual and check if it is in the sporadic groups</span>
        <span class="k">if</span> <span class="n">run_record_key</span> <span class="ow">in</span> <span class="n">SPORADIC_RECORDS</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">_init_traj_field</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run_idx</span><span class="p">,</span> <span class="n">traj_idx</span><span class="p">,</span> <span class="n">field_path</span><span class="p">,</span> <span class="n">feature_shape</span><span class="p">,</span> <span class="n">dtype</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize a data field in the trajectory to be empty but</span>
<span class="sd">        resizeable.&quot;&quot;&quot;</span>

        <span class="c1"># check whether this is a sparse field and create it</span>
        <span class="c1"># appropriately</span>
        <span class="k">if</span> <span class="n">field_path</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sparse_fields</span><span class="p">:</span>
            <span class="c1"># it is a sparse field</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_init_sparse_traj_field</span><span class="p">(</span><span class="n">run_idx</span><span class="p">,</span> <span class="n">traj_idx</span><span class="p">,</span> <span class="n">field_path</span><span class="p">,</span> <span class="n">feature_shape</span><span class="p">,</span> <span class="n">dtype</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># it is not a sparse field (AKA simple)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_init_contiguous_traj_field</span><span class="p">(</span><span class="n">run_idx</span><span class="p">,</span> <span class="n">traj_idx</span><span class="p">,</span> <span class="n">field_path</span><span class="p">,</span> <span class="n">feature_shape</span><span class="p">,</span> <span class="n">dtype</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_init_contiguous_traj_field</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run_idx</span><span class="p">,</span> <span class="n">traj_idx</span><span class="p">,</span> <span class="n">field_path</span><span class="p">,</span> <span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="p">):</span>

        <span class="n">traj_grp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_h5</span><span class="p">[</span><span class="s1">&#39;runs/</span><span class="si">{}</span><span class="s1">/trajectories/</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">run_idx</span><span class="p">,</span> <span class="n">traj_idx</span><span class="p">)]</span>

        <span class="c1"># create the empty dataset in the correct group, setting</span>
        <span class="c1"># maxshape so it can be resized for new feature vectors to be added</span>
        <span class="n">traj_grp</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="n">field_path</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">*</span><span class="p">[</span><span class="mi">0</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">shape</span><span class="p">]),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span>
                           <span class="n">maxshape</span><span class="o">=</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="n">shape</span><span class="p">))</span>


    <span class="k">def</span> <span class="nf">_init_sparse_traj_field</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run_idx</span><span class="p">,</span> <span class="n">traj_idx</span><span class="p">,</span> <span class="n">field_path</span><span class="p">,</span> <span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="p">):</span>

        <span class="n">traj_grp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_h5</span><span class="p">[</span><span class="s1">&#39;runs/</span><span class="si">{}</span><span class="s1">/trajectories/</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">run_idx</span><span class="p">,</span> <span class="n">traj_idx</span><span class="p">)]</span>

        <span class="c1"># check to see that neither the shape and dtype are</span>
        <span class="c1"># None which indicates it is a runtime defined value and</span>
        <span class="c1"># should be ignored here</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">shape</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">dtype</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="c1"># do nothing</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>

            <span class="c1"># only create the group if you are going to add the</span>
            <span class="c1"># datasets so the extend function can know if it has been</span>
            <span class="c1"># properly initialized easier</span>
            <span class="n">sparse_grp</span> <span class="o">=</span> <span class="n">traj_grp</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="n">field_path</span><span class="p">)</span>

            <span class="c1"># create the dataset for the feature data</span>
            <span class="n">sparse_grp</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">*</span><span class="p">[</span><span class="mi">0</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">shape</span><span class="p">]),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span>
                               <span class="n">maxshape</span><span class="o">=</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="n">shape</span><span class="p">))</span>

            <span class="c1"># create the dataset for the sparse indices</span>
            <span class="n">sparse_grp</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s1">&#39;_sparse_idxs&#39;</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">,</span> <span class="n">maxshape</span><span class="o">=</span><span class="p">(</span><span class="kc">None</span><span class="p">,))</span>


    <span class="k">def</span> <span class="nf">_init_traj_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run_idx</span><span class="p">,</span> <span class="n">traj_idx</span><span class="p">,</span>
                          <span class="n">field_paths</span><span class="p">,</span> <span class="n">field_feature_shapes</span><span class="p">,</span> <span class="n">field_feature_dtypes</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">field_path</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">field_paths</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_init_traj_field</span><span class="p">(</span><span class="n">run_idx</span><span class="p">,</span> <span class="n">traj_idx</span><span class="p">,</span>
                                  <span class="n">field_path</span><span class="p">,</span> <span class="n">field_feature_shapes</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">field_feature_dtypes</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

<div class="viewcode-block" id="WepyHDF5.traj_n_frames"><a class="viewcode-back" href="../../api/wepy.html#wepy.hdf5.WepyHDF5.traj_n_frames">[docs]</a>    <span class="k">def</span> <span class="nf">traj_n_frames</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run_idx</span><span class="p">,</span> <span class="n">traj_idx</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">traj</span><span class="p">(</span><span class="n">run_idx</span><span class="p">,</span> <span class="n">traj_idx</span><span class="p">)[</span><span class="n">POSITIONS</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></div>

<div class="viewcode-block" id="WepyHDF5.add_traj"><a class="viewcode-back" href="../../api/wepy.html#wepy.hdf5.WepyHDF5.add_traj">[docs]</a>    <span class="k">def</span> <span class="nf">add_traj</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run_idx</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sparse_idxs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="c1"># convenient alias</span>
        <span class="n">traj_data</span> <span class="o">=</span> <span class="n">data</span>

        <span class="c1"># initialize None kwargs</span>
        <span class="k">if</span> <span class="n">sparse_idxs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">sparse_idxs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">metadata</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">metadata</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># positions are mandatory</span>
        <span class="k">assert</span> <span class="n">POSITIONS</span> <span class="ow">in</span> <span class="n">traj_data</span><span class="p">,</span> <span class="s2">&quot;positions must be given to create a trajectory&quot;</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">traj_data</span><span class="p">[</span><span class="n">POSITIONS</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span>

        <span class="n">n_frames</span> <span class="o">=</span> <span class="n">traj_data</span><span class="p">[</span><span class="n">POSITIONS</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># if weights are None then we assume they are 1.0</span>
        <span class="k">if</span> <span class="n">weights</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">n_frames</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">),</span> <span class="s2">&quot;weights must be a numpy.ndarray&quot;</span>
            <span class="k">assert</span> <span class="n">weights</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">n_frames</span><span class="p">,</span>\
                <span class="s2">&quot;weights and the number of frames must be the same length&quot;</span>

        <span class="c1"># current traj_idx</span>
        <span class="n">traj_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">next_run_traj_idx</span><span class="p">(</span><span class="n">run_idx</span><span class="p">)</span>
        <span class="c1"># make a group for this trajectory, with the current traj_idx</span>
        <span class="c1"># for this run</span>
        <span class="n">traj_grp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_h5</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span>
                        <span class="s1">&#39;runs/</span><span class="si">{}</span><span class="s1">/trajectories/</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">run_idx</span><span class="p">,</span> <span class="n">traj_idx</span><span class="p">))</span>

        <span class="c1"># add the run_idx as metadata</span>
        <span class="n">traj_grp</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;run_idx&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">run_idx</span>
        <span class="c1"># add the traj_idx as metadata</span>
        <span class="n">traj_grp</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;traj_idx&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">traj_idx</span>


        <span class="c1"># add the rest of the metadata if given</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">metadata</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;run_idx&#39;</span><span class="p">,</span> <span class="s1">&#39;traj_idx&#39;</span><span class="p">]:</span>
                <span class="n">traj_grp</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">warn</span><span class="p">(</span><span class="s2">&quot;run_idx and traj_idx are used by wepy and cannot be set&quot;</span><span class="p">,</span> <span class="ne">RuntimeWarning</span><span class="p">)</span>


        <span class="c1"># check to make sure the positions are the right shape</span>
        <span class="k">assert</span> <span class="n">traj_data</span><span class="p">[</span><span class="n">POSITIONS</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_atoms</span><span class="p">,</span> \
            <span class="s2">&quot;positions given have different number of atoms: </span><span class="si">{}</span><span class="s2">, should be </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">traj_data</span><span class="p">[</span><span class="n">POSITIONS</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_atoms</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">traj_data</span><span class="p">[</span><span class="n">POSITIONS</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_dims</span><span class="p">,</span> \
            <span class="s2">&quot;positions given have different number of dims: </span><span class="si">{}</span><span class="s2">, should be </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">traj_data</span><span class="p">[</span><span class="n">POSITIONS</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_dims</span><span class="p">)</span>

        <span class="c1"># add datasets to the traj group</span>

        <span class="c1"># weights</span>
        <span class="n">traj_grp</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="n">WEIGHTS</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">weights</span><span class="p">,</span> <span class="n">maxshape</span><span class="o">=</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="n">WEIGHT_SHAPE</span><span class="p">))</span>
        <span class="c1"># positions</span>

        <span class="n">positions_shape</span> <span class="o">=</span> <span class="n">traj_data</span><span class="p">[</span><span class="n">POSITIONS</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>

        <span class="c1"># add the rest of the traj_data</span>
        <span class="k">for</span> <span class="n">field_path</span><span class="p">,</span> <span class="n">field_data</span> <span class="ow">in</span> <span class="n">traj_data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>

            <span class="c1"># if there were sparse idxs for this field pass them in</span>
            <span class="k">if</span> <span class="n">field_path</span> <span class="ow">in</span> <span class="n">sparse_idxs</span><span class="p">:</span>
                <span class="n">field_sparse_idxs</span> <span class="o">=</span> <span class="n">sparse_idxs</span><span class="p">[</span><span class="n">field_path</span><span class="p">]</span>
            <span class="c1"># if this is a sparse field and no sparse_idxs were given</span>
            <span class="c1"># we still need to initialize it as a sparse field so it</span>
            <span class="c1"># can be extended properly so we make sparse_idxs to match</span>
            <span class="c1"># the full length of this initial trajectory data</span>
            <span class="k">elif</span> <span class="n">field_path</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sparse_fields</span><span class="p">:</span>
                <span class="n">field_sparse_idxs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">positions_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="c1"># otherwise it is not a sparse field so we just pass in None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">field_sparse_idxs</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_add_traj_field_data</span><span class="p">(</span><span class="n">run_idx</span><span class="p">,</span> <span class="n">traj_idx</span><span class="p">,</span> <span class="n">field_path</span><span class="p">,</span> <span class="n">field_data</span><span class="p">,</span>
                                      <span class="n">sparse_idxs</span><span class="o">=</span><span class="n">field_sparse_idxs</span><span class="p">)</span>

        <span class="c1">## initialize empty sparse fields</span>
        <span class="c1"># get the sparse field datasets that haven&#39;t been initialized</span>
        <span class="n">traj_init_fields</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">sparse_idxs</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">traj_data</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">uninit_sparse_fields</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sparse_fields</span><span class="p">)</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">traj_init_fields</span><span class="p">)</span>
        <span class="c1"># the shapes</span>
        <span class="n">uninit_sparse_shapes</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">field_feature_shapes</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">uninit_sparse_fields</span><span class="p">]</span>
        <span class="c1"># the dtypes</span>
        <span class="n">uninit_sparse_dtypes</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">field_feature_dtypes</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">uninit_sparse_fields</span><span class="p">]</span>
        <span class="c1"># initialize the sparse fields in the hdf5</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_init_traj_fields</span><span class="p">(</span><span class="n">run_idx</span><span class="p">,</span> <span class="n">traj_idx</span><span class="p">,</span>
                               <span class="n">uninit_sparse_fields</span><span class="p">,</span> <span class="n">uninit_sparse_shapes</span><span class="p">,</span> <span class="n">uninit_sparse_dtypes</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">traj_grp</span></div>

    <span class="k">def</span> <span class="nf">_add_traj_field_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run_idx</span><span class="p">,</span> <span class="n">traj_idx</span><span class="p">,</span> <span class="n">field_path</span><span class="p">,</span> <span class="n">field_data</span><span class="p">,</span> <span class="n">sparse_idxs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="c1"># get the traj group</span>
        <span class="n">traj_grp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_h5</span><span class="p">[</span><span class="s1">&#39;runs/</span><span class="si">{}</span><span class="s1">/trajectories/</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">run_idx</span><span class="p">,</span> <span class="n">traj_idx</span><span class="p">)]</span>

        <span class="c1"># if it is a sparse dataset we need to add the data and add</span>
        <span class="c1"># the idxs in a group</span>
        <span class="k">if</span> <span class="n">sparse_idxs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">traj_grp</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="n">field_path</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">field_data</span><span class="p">,</span>
                                    <span class="n">maxshape</span><span class="o">=</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="n">field_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:]))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sparse_grp</span> <span class="o">=</span> <span class="n">traj_grp</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="n">field_path</span><span class="p">)</span>
            <span class="c1"># add the data to this group</span>
            <span class="n">sparse_grp</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">field_data</span><span class="p">,</span>
                                      <span class="n">maxshape</span><span class="o">=</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="n">field_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:]))</span>
            <span class="c1"># add the sparse idxs</span>
            <span class="n">sparse_grp</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s1">&#39;_sparse_idxs&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">sparse_idxs</span><span class="p">,</span>
                                      <span class="n">maxshape</span><span class="o">=</span><span class="p">(</span><span class="kc">None</span><span class="p">,))</span>

    <span class="k">def</span> <span class="nf">_extend_dataset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dset_path</span><span class="p">,</span> <span class="n">new_data</span><span class="p">):</span>
        <span class="n">dset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">h5</span><span class="p">[</span><span class="n">dset_path</span><span class="p">]</span>
        <span class="n">extend_dataset</span><span class="p">(</span><span class="n">dset</span><span class="p">,</span> <span class="n">new_data</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_extend_contiguous_traj_field</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run_idx</span><span class="p">,</span> <span class="n">traj_idx</span><span class="p">,</span> <span class="n">field_path</span><span class="p">,</span> <span class="n">field_data</span><span class="p">):</span>

        <span class="n">traj_grp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">h5</span><span class="p">[</span><span class="s1">&#39;/runs/</span><span class="si">{}</span><span class="s1">/trajectories/</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">run_idx</span><span class="p">,</span> <span class="n">traj_idx</span><span class="p">)]</span>
        <span class="n">field</span> <span class="o">=</span> <span class="n">traj_grp</span><span class="p">[</span><span class="n">field_path</span><span class="p">]</span>

        <span class="c1"># make sure this is a feature vector</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">field_data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">,</span> \
            <span class="s2">&quot;field_data must be a feature vector with the same number of dimensions as the number&quot;</span>

        <span class="c1"># of datase new frames</span>
        <span class="n">n_new_frames</span> <span class="o">=</span> <span class="n">field_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># check the field to make sure it is not empty</span>
        <span class="k">if</span> <span class="nb">all</span><span class="p">([</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">field</span><span class="o">.</span><span class="n">shape</span><span class="p">]):</span>

            <span class="c1"># check the feature shape against the maxshape which gives</span>
            <span class="c1"># the feature dimensions for an empty dataset</span>
            <span class="k">assert</span> <span class="n">field_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">==</span> <span class="n">field</span><span class="o">.</span><span class="n">maxshape</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> \
                <span class="s2">&quot;field feature dimensions must be the same, i.e. all but the first dimension&quot;</span>

            <span class="c1"># if it is empty resize it to make an array the size of</span>
            <span class="c1"># the new field_data with the maxshape for the feature</span>
            <span class="c1"># dimensions</span>
            <span class="n">feature_dims</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">maxshape</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
            <span class="n">field</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span> <span class="p">(</span><span class="n">n_new_frames</span><span class="p">,</span> <span class="o">*</span><span class="n">feature_dims</span><span class="p">)</span> <span class="p">)</span>

            <span class="c1"># set the new data to this</span>
            <span class="n">field</span><span class="p">[</span><span class="mi">0</span><span class="p">:,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">field_data</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># make sure the new data has the right dimensions against</span>
            <span class="c1"># the shape it already has</span>
            <span class="k">assert</span> <span class="n">field_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">==</span> <span class="n">field</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> \
                <span class="s2">&quot;field feature dimensions must be the same, i.e. all but the first dimension&quot;</span>


            <span class="c1"># append to the dataset on the first dimension, keeping the</span>
            <span class="c1"># others the same, these must be feature vectors and therefore</span>
            <span class="c1"># must exist</span>
            <span class="n">field</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span> <span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">n_new_frames</span><span class="p">,</span> <span class="o">*</span><span class="n">field</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span> <span class="p">)</span>
            <span class="c1"># add the new data</span>
            <span class="n">field</span><span class="p">[</span><span class="o">-</span><span class="n">n_new_frames</span><span class="p">:,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">field_data</span>

    <span class="k">def</span> <span class="nf">_extend_sparse_traj_field</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run_idx</span><span class="p">,</span> <span class="n">traj_idx</span><span class="p">,</span> <span class="n">field_path</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">sparse_idxs</span><span class="p">):</span>

        <span class="n">field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">h5</span><span class="p">[</span><span class="s1">&#39;/runs/</span><span class="si">{}</span><span class="s1">/trajectories/</span><span class="si">{}</span><span class="s1">/</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">run_idx</span><span class="p">,</span> <span class="n">traj_idx</span><span class="p">,</span> <span class="n">field_path</span><span class="p">)]</span>

        <span class="n">field_data</span> <span class="o">=</span> <span class="n">field</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span>
        <span class="n">field_sparse_idxs</span> <span class="o">=</span> <span class="n">field</span><span class="p">[</span><span class="s1">&#39;_sparse_idxs&#39;</span><span class="p">]</span>

        <span class="c1"># number of new frames</span>
        <span class="n">n_new_frames</span> <span class="o">=</span> <span class="n">values</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># if this sparse_field has been initialized empty we need to resize</span>
        <span class="k">if</span> <span class="nb">all</span><span class="p">([</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">field_data</span><span class="o">.</span><span class="n">shape</span><span class="p">]):</span>


            <span class="c1"># check the feature shape against the maxshape which gives</span>
            <span class="c1"># the feature dimensions for an empty dataset</span>
            <span class="k">assert</span> <span class="n">values</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">==</span> <span class="n">field_data</span><span class="o">.</span><span class="n">maxshape</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> \
                <span class="s2">&quot;input value features have shape </span><span class="si">{}</span><span class="s2">, expected </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">values</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">field_data</span><span class="o">.</span><span class="n">maxshape</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>

            <span class="c1"># if it is empty resize it to make an array the size of</span>
            <span class="c1"># the new values with the maxshape for the feature</span>
            <span class="c1"># dimensions</span>
            <span class="n">feature_dims</span> <span class="o">=</span> <span class="n">field_data</span><span class="o">.</span><span class="n">maxshape</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
            <span class="n">field_data</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span> <span class="p">(</span><span class="n">n_new_frames</span><span class="p">,</span> <span class="o">*</span><span class="n">feature_dims</span><span class="p">)</span> <span class="p">)</span>

            <span class="c1"># set the new data to this</span>
            <span class="n">field_data</span><span class="p">[</span><span class="mi">0</span><span class="p">:,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">values</span>

        <span class="k">else</span><span class="p">:</span>

            <span class="c1"># make sure the new data has the right dimensions</span>
            <span class="k">assert</span> <span class="n">values</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">==</span> <span class="n">field_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> \
                <span class="s2">&quot;field feature dimensions must be the same, i.e. all but the first dimension&quot;</span>

            <span class="c1"># append to the dataset on the first dimension, keeping the</span>
            <span class="c1"># others the same, these must be feature vectors and therefore</span>
            <span class="c1"># must exist</span>
            <span class="n">field_data</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span> <span class="p">(</span><span class="n">field_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">n_new_frames</span><span class="p">,</span> <span class="o">*</span><span class="n">field_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span> <span class="p">)</span>
            <span class="c1"># add the new data</span>
            <span class="n">field_data</span><span class="p">[</span><span class="o">-</span><span class="n">n_new_frames</span><span class="p">:,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">values</span>

        <span class="c1"># add the sparse idxs in the same way</span>
        <span class="n">field_sparse_idxs</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span> <span class="p">(</span><span class="n">field_sparse_idxs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">n_new_frames</span><span class="p">,</span>
                                   <span class="o">*</span><span class="n">field_sparse_idxs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span> <span class="p">)</span>
        <span class="c1"># add the new data</span>
        <span class="n">field_sparse_idxs</span><span class="p">[</span><span class="o">-</span><span class="n">n_new_frames</span><span class="p">:,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">sparse_idxs</span>

<div class="viewcode-block" id="WepyHDF5.extend_traj"><a class="viewcode-back" href="../../api/wepy.html#wepy.hdf5.WepyHDF5.extend_traj">[docs]</a>    <span class="k">def</span> <span class="nf">extend_traj</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run_idx</span><span class="p">,</span> <span class="n">traj_idx</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wepy_mode</span> <span class="o">==</span> <span class="s1">&#39;c-&#39;</span><span class="p">:</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_append_flags</span><span class="p">[</span><span class="n">dataset_key</span><span class="p">],</span> <span class="s2">&quot;dataset is not available for appending to&quot;</span>

        <span class="c1"># convenient alias</span>
        <span class="n">traj_data</span> <span class="o">=</span> <span class="n">data</span>

        <span class="c1"># number of frames to add</span>
        <span class="n">n_new_frames</span> <span class="o">=</span> <span class="n">traj_data</span><span class="p">[</span><span class="n">POSITIONS</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">n_frames</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">traj_n_frames</span><span class="p">(</span><span class="n">run_idx</span><span class="p">,</span> <span class="n">traj_idx</span><span class="p">)</span>

        <span class="c1"># calculate the new sparse idxs for sparse fields that may be</span>
        <span class="c1"># being added</span>
        <span class="n">sparse_idxs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">n_frames</span><span class="p">,</span> <span class="n">n_frames</span> <span class="o">+</span> <span class="n">n_new_frames</span><span class="p">))</span>

        <span class="c1"># get the trajectory group</span>
        <span class="n">traj_grp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_h5</span><span class="p">[</span><span class="s1">&#39;runs/</span><span class="si">{}</span><span class="s1">/trajectories/</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">run_idx</span><span class="p">,</span> <span class="n">traj_idx</span><span class="p">)]</span>

        <span class="c1">## weights</span>

        <span class="c1"># if weights are None then we assume they are 1.0</span>
        <span class="k">if</span> <span class="n">weights</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">n_new_frames</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">),</span> <span class="s2">&quot;weights must be a numpy.ndarray&quot;</span>
            <span class="k">assert</span> <span class="n">weights</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">n_new_frames</span><span class="p">,</span>\
                <span class="s2">&quot;weights and the number of frames must be the same length&quot;</span>

        <span class="c1"># add the weights</span>
        <span class="n">weights_ds</span> <span class="o">=</span> <span class="n">traj_grp</span><span class="p">[</span><span class="n">WEIGHTS</span><span class="p">]</span>

        <span class="c1"># append to the dataset on the first dimension, keeping the</span>
        <span class="c1"># others the same, if they exist</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">weights_ds</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">weights_ds</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span> <span class="p">(</span><span class="n">weights_ds</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">n_new_frames</span><span class="p">,</span> <span class="o">*</span><span class="n">weights_ds</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span> <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">weights_ds</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span> <span class="p">(</span><span class="n">weights_ds</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">n_new_frames</span><span class="p">,</span> <span class="p">)</span> <span class="p">)</span>

        <span class="c1"># add the new data</span>
        <span class="n">weights_ds</span><span class="p">[</span><span class="o">-</span><span class="n">n_new_frames</span><span class="p">:,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">weights</span>


        <span class="c1"># add the other fields</span>
        <span class="k">for</span> <span class="n">field_path</span><span class="p">,</span> <span class="n">field_data</span> <span class="ow">in</span> <span class="n">traj_data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>

            <span class="c1"># if the field hasn&#39;t been initialized yet initialize it</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">field_path</span> <span class="ow">in</span> <span class="n">traj_grp</span><span class="p">:</span>
                <span class="n">feature_shape</span> <span class="o">=</span> <span class="n">field_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
                <span class="n">feature_dtype</span> <span class="o">=</span> <span class="n">field_data</span><span class="o">.</span><span class="n">dtype</span>

                <span class="c1"># not specified as sparse_field, no settings</span>
                <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">field_path</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">field_feature_shapes</span><span class="p">)</span> <span class="ow">and</span> \
                     <span class="p">(</span><span class="ow">not</span> <span class="n">field_path</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">field_feature_dtypes</span><span class="p">)</span> <span class="ow">and</span> \
                     <span class="ow">not</span> <span class="n">field_path</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sparse_fields</span><span class="p">:</span>
                    <span class="c1"># only save if it is an observable</span>
                    <span class="n">is_observable</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">if</span> <span class="s1">&#39;/&#39;</span> <span class="ow">in</span> <span class="n">field_path</span><span class="p">:</span>
                        <span class="n">group_name</span> <span class="o">=</span> <span class="n">field_path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">group_name</span> <span class="o">==</span> <span class="n">OBSERVABLES</span><span class="p">:</span>
                            <span class="n">is_observable</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">if</span> <span class="n">is_observable</span><span class="p">:</span>
                          <span class="n">warn</span><span class="p">(</span><span class="s2">&quot;the field &#39;</span><span class="si">{}</span><span class="s2">&#39; was received but not previously specified&quot;</span>
                               <span class="s2">&quot; but is being added because it is in observables.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">field_path</span><span class="p">))</span>
                          <span class="c1"># save sparse_field flag, shape, and dtype</span>
                          <span class="bp">self</span><span class="o">.</span><span class="n">_add_sparse_field_flag</span><span class="p">(</span><span class="n">field_path</span><span class="p">)</span>
                          <span class="bp">self</span><span class="o">.</span><span class="n">_set_field_feature_shape</span><span class="p">(</span><span class="n">field_path</span><span class="p">,</span> <span class="n">feature_shape</span><span class="p">)</span>
                          <span class="bp">self</span><span class="o">.</span><span class="n">_set_field_feature_dtype</span><span class="p">(</span><span class="n">field_path</span><span class="p">,</span> <span class="n">feature_dtype</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;the field &#39;</span><span class="si">{}</span><span class="s2">&#39; was received but not previously specified&quot;</span>
                            <span class="s2">&quot;it is being ignored because it is not an observable.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">field_path</span><span class="p">))</span>

                <span class="c1"># specified as sparse_field but no settings given</span>
                <span class="k">elif</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">field_feature_shapes</span><span class="p">[</span><span class="n">field_path</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span>
                   <span class="bp">self</span><span class="o">.</span><span class="n">field_feature_dtypes</span><span class="p">[</span><span class="n">field_path</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> \
                   <span class="n">field_path</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sparse_fields</span><span class="p">:</span>
                    <span class="c1"># set the feature shape and dtype since these</span>
                    <span class="c1"># should be 0 in the settings</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_set_field_feature_shape</span><span class="p">(</span><span class="n">field_path</span><span class="p">,</span> <span class="n">feature_shape</span><span class="p">)</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">_set_field_feature_dtype</span><span class="p">(</span><span class="n">field_path</span><span class="p">,</span> <span class="n">feature_dtype</span><span class="p">)</span>

                <span class="c1"># initialize</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_init_traj_field</span><span class="p">(</span><span class="n">run_idx</span><span class="p">,</span> <span class="n">traj_idx</span><span class="p">,</span> <span class="n">field_path</span><span class="p">,</span> <span class="n">feature_shape</span><span class="p">,</span> <span class="n">feature_dtype</span><span class="p">)</span>

            <span class="c1"># extend it either as a sparse field or a contiguous field</span>
            <span class="k">if</span> <span class="n">field_path</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sparse_fields</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_extend_sparse_traj_field</span><span class="p">(</span><span class="n">run_idx</span><span class="p">,</span> <span class="n">traj_idx</span><span class="p">,</span> <span class="n">field_path</span><span class="p">,</span> <span class="n">field_data</span><span class="p">,</span> <span class="n">sparse_idxs</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_extend_contiguous_traj_field</span><span class="p">(</span><span class="n">run_idx</span><span class="p">,</span> <span class="n">traj_idx</span><span class="p">,</span> <span class="n">field_path</span><span class="p">,</span> <span class="n">field_data</span><span class="p">)</span></div>


    <span class="k">def</span> <span class="nf">_add_sparse_field_flag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field_path</span><span class="p">):</span>

        <span class="n">sparse_fields_ds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_h5</span><span class="p">[</span><span class="s1">&#39;_settings/sparse_fields&#39;</span><span class="p">]</span>

        <span class="c1"># make sure it isn&#39;t already in the sparse_fields</span>
        <span class="k">if</span> <span class="n">field_path</span> <span class="ow">in</span> <span class="n">sparse_fields_ds</span><span class="p">[:]:</span>
            <span class="n">warn</span><span class="p">(</span><span class="s2">&quot;sparse field </span><span class="si">{}</span><span class="s2"> already a sparse field, ignoring&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">field_path</span><span class="p">))</span>

        <span class="n">sparse_fields_ds</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span> <span class="p">(</span><span class="n">sparse_fields_ds</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,)</span> <span class="p">)</span>
        <span class="n">sparse_fields_ds</span><span class="p">[</span><span class="n">sparse_fields_ds</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">field_path</span>

    <span class="k">def</span> <span class="nf">_add_field_feature_shape</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field_path</span><span class="p">,</span> <span class="n">field_feature_shape</span><span class="p">):</span>
        <span class="n">shapes_grp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_h5</span><span class="p">[</span><span class="s1">&#39;_settings/field_feature_shapes&#39;</span><span class="p">]</span>
        <span class="n">shapes_grp</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="n">field_path</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">field_feature_shape</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_add_field_feature_dtype</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field_path</span><span class="p">,</span> <span class="n">field_feature_dtype</span><span class="p">):</span>
        <span class="n">feature_dtype_str</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">field_feature_dtype</span><span class="o">.</span><span class="n">descr</span><span class="p">)</span>
        <span class="n">dtypes_grp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_h5</span><span class="p">[</span><span class="s1">&#39;_settings/field_feature_dtypes&#39;</span><span class="p">]</span>
        <span class="n">dtypes_grp</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="n">field_path</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">feature_dtype_str</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">_set_field_feature_shape</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field_path</span><span class="p">,</span> <span class="n">field_feature_shape</span><span class="p">):</span>
        <span class="c1"># check if the field_feature_shape is already set</span>
        <span class="k">if</span> <span class="n">field_path</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">field_feature_shapes</span><span class="p">:</span>
            <span class="c1"># check that the shape was previously saved as &quot;None&quot; as we</span>
            <span class="c1"># won&#39;t overwrite anything else</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">field_feature_shapes</span><span class="p">[</span><span class="n">field_path</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">full_path</span> <span class="o">=</span> <span class="s1">&#39;_settings/field_feature_shapes/</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">field_path</span><span class="p">)</span>
                <span class="c1"># we have to delete the old data and set new data</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">h5</span><span class="p">[</span><span class="n">full_path</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">h5</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="n">full_path</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">field_feature_shape</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span>
                    <span class="s2">&quot;Cannot overwrite feature shape for </span><span class="si">{}</span><span class="s2"> with </span><span class="si">{}</span><span class="s2"> because it is </span><span class="si">{}</span><span class="s2"> not &#39;None&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">field_path</span><span class="p">,</span> <span class="n">field_feature_shape</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">field_feature_shapes</span><span class="p">[</span><span class="n">field_path</span><span class="p">]))</span>
        <span class="c1"># it was not previously set so we must create then save it</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_add_field_feature_shape</span><span class="p">(</span><span class="n">field_path</span><span class="p">,</span> <span class="n">field_feature_shape</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_set_field_feature_dtype</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field_path</span><span class="p">,</span> <span class="n">field_feature_dtype</span><span class="p">):</span>
        <span class="n">feature_dtype_str</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">field_feature_dtype</span><span class="o">.</span><span class="n">descr</span><span class="p">)</span>
        <span class="c1"># check if the field_feature_dtype is already set</span>
        <span class="k">if</span> <span class="n">field_path</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">field_feature_dtypes</span><span class="p">:</span>
            <span class="c1"># check that the dtype was previously saved as &quot;None&quot; as we</span>
            <span class="c1"># won&#39;t overwrite anything else</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">field_feature_dtypes</span><span class="p">[</span><span class="n">field_path</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">full_path</span> <span class="o">=</span> <span class="s1">&#39;_settings/field_feature_dtypes/</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">field_path</span><span class="p">)</span>
                <span class="c1"># we have to delete the old data and set new data</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">h5</span><span class="p">[</span><span class="n">full_path</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">h5</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="n">full_path</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">feature_dtype_str</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span>
                    <span class="s2">&quot;Cannot overwrite feature dtype for </span><span class="si">{}</span><span class="s2"> with </span><span class="si">{}</span><span class="s2"> because it is </span><span class="si">{}</span><span class="s2"> not &#39;None&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">field_path</span><span class="p">,</span> <span class="n">field_feature_dtype</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">field_feature_dtypes</span><span class="p">[</span><span class="n">field_path</span><span class="p">]))</span>
        <span class="c1"># it was not previously set so we must create then save it</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_add_field_feature_dtype</span><span class="p">(</span><span class="n">field_path</span><span class="p">,</span> <span class="n">field_feature_dtype</span><span class="p">)</span>

<div class="viewcode-block" id="WepyHDF5.decision_grp"><a class="viewcode-back" href="../../api/wepy.html#wepy.hdf5.WepyHDF5.decision_grp">[docs]</a>    <span class="k">def</span> <span class="nf">decision_grp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run_idx</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">run_idx</span><span class="p">)[</span><span class="s1">&#39;decision&#39;</span><span class="p">]</span></div>

<div class="viewcode-block" id="WepyHDF5.decision_enum"><a class="viewcode-back" href="../../api/wepy.html#wepy.hdf5.WepyHDF5.decision_enum">[docs]</a>    <span class="k">def</span> <span class="nf">decision_enum</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run_idx</span><span class="p">):</span>

        <span class="n">enum_grp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">decision_grp</span><span class="p">(</span><span class="n">run_idx</span><span class="p">)</span>
        <span class="n">enum</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">decision_name</span><span class="p">,</span> <span class="n">dset</span> <span class="ow">in</span> <span class="n">enum_grp</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">enum</span><span class="p">[</span><span class="n">decision_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">dset</span><span class="p">[()]</span>

        <span class="k">return</span> <span class="n">enum</span></div>

<div class="viewcode-block" id="WepyHDF5.decision_value_names"><a class="viewcode-back" href="../../api/wepy.html#wepy.hdf5.WepyHDF5.decision_value_names">[docs]</a>    <span class="k">def</span> <span class="nf">decision_value_names</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run_idx</span><span class="p">):</span>
        <span class="n">enum_grp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">decision_grp</span><span class="p">(</span><span class="n">run_idx</span><span class="p">)</span>
        <span class="n">rev_enum</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">decision_name</span><span class="p">,</span> <span class="n">dset</span> <span class="ow">in</span> <span class="n">enum_grp</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">dset</span><span class="p">[()]</span>
            <span class="n">rev_enum</span><span class="p">[</span><span class="n">value</span><span class="p">]</span> <span class="o">=</span> <span class="n">decision_name</span>

        <span class="k">return</span> <span class="n">rev_enum</span></div>

    <span class="c1">## application level append methods for run records groups</span>

<div class="viewcode-block" id="WepyHDF5.extend_cycle_warping_records"><a class="viewcode-back" href="../../api/wepy.html#wepy.hdf5.WepyHDF5.extend_cycle_warping_records">[docs]</a>    <span class="k">def</span> <span class="nf">extend_cycle_warping_records</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run_idx</span><span class="p">,</span> <span class="n">cycle_idx</span><span class="p">,</span> <span class="n">warping_data</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">extend_cycle_run_group_records</span><span class="p">(</span><span class="n">run_idx</span><span class="p">,</span> <span class="n">WARPING</span><span class="p">,</span> <span class="n">cycle_idx</span><span class="p">,</span> <span class="n">warping_data</span><span class="p">)</span></div>

<div class="viewcode-block" id="WepyHDF5.extend_cycle_bc_records"><a class="viewcode-back" href="../../api/wepy.html#wepy.hdf5.WepyHDF5.extend_cycle_bc_records">[docs]</a>    <span class="k">def</span> <span class="nf">extend_cycle_bc_records</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run_idx</span><span class="p">,</span> <span class="n">cycle_idx</span><span class="p">,</span> <span class="n">bc_data</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">extend_cycle_run_group_records</span><span class="p">(</span><span class="n">run_idx</span><span class="p">,</span> <span class="n">BC</span><span class="p">,</span> <span class="n">cycle_idx</span><span class="p">,</span> <span class="n">bc_data</span><span class="p">)</span></div>

<div class="viewcode-block" id="WepyHDF5.extend_cycle_progress_records"><a class="viewcode-back" href="../../api/wepy.html#wepy.hdf5.WepyHDF5.extend_cycle_progress_records">[docs]</a>    <span class="k">def</span> <span class="nf">extend_cycle_progress_records</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run_idx</span><span class="p">,</span> <span class="n">cycle_idx</span><span class="p">,</span> <span class="n">progress_data</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">extend_cycle_run_group_records</span><span class="p">(</span><span class="n">run_idx</span><span class="p">,</span> <span class="n">PROGRESS</span><span class="p">,</span> <span class="n">cycle_idx</span><span class="p">,</span> <span class="n">progress_data</span><span class="p">)</span></div>

<div class="viewcode-block" id="WepyHDF5.extend_cycle_resampling_records"><a class="viewcode-back" href="../../api/wepy.html#wepy.hdf5.WepyHDF5.extend_cycle_resampling_records">[docs]</a>    <span class="k">def</span> <span class="nf">extend_cycle_resampling_records</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run_idx</span><span class="p">,</span> <span class="n">cycle_idx</span><span class="p">,</span> <span class="n">resampling_data</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">extend_cycle_run_group_records</span><span class="p">(</span><span class="n">run_idx</span><span class="p">,</span> <span class="n">RESAMPLING</span><span class="p">,</span> <span class="n">cycle_idx</span><span class="p">,</span> <span class="n">resampling_data</span><span class="p">)</span></div>

<div class="viewcode-block" id="WepyHDF5.extend_cycle_resampler_records"><a class="viewcode-back" href="../../api/wepy.html#wepy.hdf5.WepyHDF5.extend_cycle_resampler_records">[docs]</a>    <span class="k">def</span> <span class="nf">extend_cycle_resampler_records</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run_idx</span><span class="p">,</span> <span class="n">cycle_idx</span><span class="p">,</span> <span class="n">resampler_data</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">extend_cycle_run_group_records</span><span class="p">(</span><span class="n">run_idx</span><span class="p">,</span> <span class="n">RESAMPLER</span><span class="p">,</span> <span class="n">cycle_idx</span><span class="p">,</span> <span class="n">resampler_data</span><span class="p">)</span></div>

<div class="viewcode-block" id="WepyHDF5.extend_cycle_run_group_records"><a class="viewcode-back" href="../../api/wepy.html#wepy.hdf5.WepyHDF5.extend_cycle_run_group_records">[docs]</a>    <span class="k">def</span> <span class="nf">extend_cycle_run_group_records</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run_idx</span><span class="p">,</span> <span class="n">run_record_key</span><span class="p">,</span> <span class="n">cycle_idx</span><span class="p">,</span> <span class="n">fields_data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Append data for a whole records group, that is every field</span>
<span class="sd">        dataset. This must have the cycle index for the data it is</span>
<span class="sd">        appending as this is done for sporadic and continual datasets.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">record_grp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">records_grp</span><span class="p">(</span><span class="n">run_idx</span><span class="p">,</span> <span class="n">run_record_key</span><span class="p">)</span>

        <span class="c1"># if it is sporadic add the cycle idx</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_sporadic_records</span><span class="p">(</span><span class="n">run_record_key</span><span class="p">):</span>

            <span class="c1"># get the cycle idxs dataset</span>
            <span class="n">record_cycle_idxs_ds</span> <span class="o">=</span> <span class="n">record_grp</span><span class="p">[</span><span class="n">CYCLE_IDXS</span><span class="p">]</span>

            <span class="c1"># number of old and new records</span>
            <span class="n">n_new_records</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">fields_data</span><span class="p">)</span>
            <span class="n">n_existing_records</span> <span class="o">=</span> <span class="n">record_cycle_idxs_ds</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="c1"># make a new chunk for the new records</span>
            <span class="n">record_cycle_idxs_ds</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span> <span class="p">(</span><span class="n">n_existing_records</span> <span class="o">+</span> <span class="n">n_new_records</span><span class="p">,)</span> <span class="p">)</span>

            <span class="c1"># add an array of the cycle idx for each record</span>
            <span class="n">record_cycle_idxs_ds</span><span class="p">[</span><span class="n">n_existing_records</span><span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">n_new_records</span><span class="p">,),</span> <span class="n">cycle_idx</span><span class="p">)</span>

        <span class="c1"># then add all the data for the field</span>
        <span class="k">for</span> <span class="n">record_dict</span> <span class="ow">in</span> <span class="n">fields_data</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">field_name</span><span class="p">,</span> <span class="n">field_data</span> <span class="ow">in</span> <span class="n">record_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_extend_run_record_data_field</span><span class="p">(</span><span class="n">run_idx</span><span class="p">,</span> <span class="n">run_record_key</span><span class="p">,</span>
                                                   <span class="n">field_name</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">field_data</span><span class="p">]))</span></div>

    <span class="k">def</span> <span class="nf">_extend_run_record_data_field</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run_idx</span><span class="p">,</span> <span class="n">run_record_key</span><span class="p">,</span>
                                          <span class="n">field_name</span><span class="p">,</span> <span class="n">field_data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Adds data for a single field dataset in a run records group. This</span>
<span class="sd">        is done without paying attention to whether it is sporadic or</span>
<span class="sd">        continual and is supposed to be only the data write method.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">records_grp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">h5</span><span class="p">[</span><span class="s1">&#39;runs/</span><span class="si">{}</span><span class="s1">/</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">run_idx</span><span class="p">,</span> <span class="n">run_record_key</span><span class="p">)]</span>
        <span class="n">field</span> <span class="o">=</span> <span class="n">records_grp</span><span class="p">[</span><span class="n">field_name</span><span class="p">]</span>

        <span class="c1"># make sure this is a feature vector</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">field_data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">,</span> \
            <span class="s2">&quot;field_data must be a feature vector with the same number of dimensions as the number&quot;</span>

        <span class="c1"># of datase new frames</span>
        <span class="n">n_new_frames</span> <span class="o">=</span> <span class="n">field_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># check whether it is a variable length record, by getting the</span>
        <span class="c1"># record dataset dtype and using the checker to see if it is</span>
        <span class="c1"># the vlen special type in h5py</span>
        <span class="k">if</span> <span class="n">h5py</span><span class="o">.</span><span class="n">check_dtype</span><span class="p">(</span><span class="n">vlen</span><span class="o">=</span><span class="n">field</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

            <span class="c1"># if it is we have to treat it differently, since it</span>
            <span class="c1"># cannot be multidimensional</span>

            <span class="c1"># if the dataset has no data in it we need to reshape it</span>
            <span class="k">if</span> <span class="nb">all</span><span class="p">([</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">field</span><span class="o">.</span><span class="n">shape</span><span class="p">]):</span>
                <span class="c1"># initialize this array</span>
                <span class="c1"># if it is empty resize it to make an array the size of</span>
                <span class="c1"># the new field_data with the maxshape for the feature</span>
                <span class="c1"># dimensions</span>
                <span class="n">field</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span> <span class="p">(</span><span class="n">n_new_frames</span><span class="p">,)</span> <span class="p">)</span>

                <span class="c1"># set the new data to this</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">field_data</span><span class="p">):</span>
                    <span class="n">field</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span>

            <span class="c1"># otherwise just add the data</span>
            <span class="k">else</span><span class="p">:</span>

                <span class="c1"># resize the array but it is only of rank because</span>
                <span class="c1"># of variable length data</span>
                <span class="n">field</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span> <span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">n_new_frames</span><span class="p">,</span> <span class="p">)</span> <span class="p">)</span>

                <span class="c1"># add each row to the newly made space</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">field_data</span><span class="p">):</span>
                    <span class="n">field</span><span class="p">[(</span><span class="n">field</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span>

        <span class="c1"># if it is not variable length we don&#39;t have to treat it</span>
        <span class="c1"># differently</span>
        <span class="k">else</span><span class="p">:</span>

            <span class="c1"># if this is empty we need to reshape the dataset to accomodate data</span>
            <span class="k">if</span> <span class="nb">all</span><span class="p">([</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">field</span><span class="o">.</span><span class="n">shape</span><span class="p">]):</span>

                <span class="c1"># check the feature shape against the maxshape which gives</span>
                <span class="c1"># the feature dimensions for an empty dataset</span>
                <span class="k">assert</span> <span class="n">field_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">==</span> <span class="n">field</span><span class="o">.</span><span class="n">maxshape</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> \
                    <span class="s2">&quot;field feature dimensions must be the same, i.e. all but the first dimension&quot;</span>

                <span class="c1"># if it is empty resize it to make an array the size of</span>
                <span class="c1"># the new field_data with the maxshape for the feature</span>
                <span class="c1"># dimensions</span>
                <span class="n">feature_dims</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">maxshape</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
                <span class="n">field</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span> <span class="p">(</span><span class="n">n_new_frames</span><span class="p">,</span> <span class="o">*</span><span class="n">feature_dims</span><span class="p">)</span> <span class="p">)</span>

                <span class="c1"># set the new data to this</span>
                <span class="n">field</span><span class="p">[</span><span class="mi">0</span><span class="p">:,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">field_data</span>

            <span class="c1"># otherwise just add the data</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># append to the dataset on the first dimension, keeping the</span>
                <span class="c1"># others the same, these must be feature vectors and therefore</span>
                <span class="c1"># must exist</span>
                <span class="n">field</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span> <span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">n_new_frames</span><span class="p">,</span> <span class="o">*</span><span class="n">field</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span> <span class="p">)</span>
                <span class="c1"># add the new data</span>
                <span class="n">field</span><span class="p">[</span><span class="o">-</span><span class="n">n_new_frames</span><span class="p">:,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">field_data</span>

<div class="viewcode-block" id="WepyHDF5.get_traj_field_cycle_idxs"><a class="viewcode-back" href="../../api/wepy.html#wepy.hdf5.WepyHDF5.get_traj_field_cycle_idxs">[docs]</a>    <span class="k">def</span> <span class="nf">get_traj_field_cycle_idxs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run_idx</span><span class="p">,</span> <span class="n">traj_idx</span><span class="p">,</span> <span class="n">field_path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Returns the sparse indices for a field&quot;&quot;&quot;</span>

        <span class="n">traj_path</span> <span class="o">=</span> <span class="s2">&quot;/runs/</span><span class="si">{}</span><span class="s2">/trajectories/</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">run_idx</span><span class="p">,</span> <span class="n">traj_idx</span><span class="p">)</span>

        <span class="c1"># if the field doesn&#39;t exist return None</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">field_path</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_h5</span><span class="p">[</span><span class="n">traj_path</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s2">&quot;key for field </span><span class="si">{}</span><span class="s2"> not found&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">field_path</span><span class="p">))</span>
            <span class="c1"># return None</span>

        <span class="c1"># if the field is not sparse just return the cycle indices for</span>
        <span class="c1"># that run</span>
        <span class="k">if</span> <span class="n">field_path</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sparse_fields</span><span class="p">:</span>
            <span class="n">cycle_idxs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">run_n_cycles</span><span class="p">(</span><span class="n">run_idx</span><span class="p">)))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cycle_idxs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_h5</span><span class="p">[</span><span class="n">traj_path</span><span class="p">][</span><span class="n">field_path</span><span class="p">][</span><span class="s1">&#39;_sparse_idxs&#39;</span><span class="p">][:]</span>

        <span class="k">return</span> <span class="n">cycle_idxs</span></div>

<div class="viewcode-block" id="WepyHDF5.get_traj_field"><a class="viewcode-back" href="../../api/wepy.html#wepy.hdf5.WepyHDF5.get_traj_field">[docs]</a>    <span class="k">def</span> <span class="nf">get_traj_field</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run_idx</span><span class="p">,</span> <span class="n">traj_idx</span><span class="p">,</span> <span class="n">field_path</span><span class="p">,</span> <span class="n">frames</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">masked</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns a numpy array for the given field.</span>

<span class="sd">        You can control how sparse fields are returned using the</span>
<span class="sd">        `masked` option. When True (default) a masked numpy array will</span>
<span class="sd">        be returned such that you can get which cycles it is from,</span>
<span class="sd">        when False an unmasked array of the data will be returned</span>
<span class="sd">        which has no cycle information.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">traj_path</span> <span class="o">=</span> <span class="s2">&quot;/runs/</span><span class="si">{}</span><span class="s2">/trajectories/</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">run_idx</span><span class="p">,</span> <span class="n">traj_idx</span><span class="p">)</span>

        <span class="c1"># if the field doesn&#39;t exist return None</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">field_path</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_h5</span><span class="p">[</span><span class="n">traj_path</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s2">&quot;key for field </span><span class="si">{}</span><span class="s2"> not found&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">field_path</span><span class="p">))</span>
            <span class="c1"># return None</span>

        <span class="c1"># get the field depending on whether it is sparse or not</span>
        <span class="k">if</span> <span class="n">field_path</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sparse_fields</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_sparse_traj_field</span><span class="p">(</span><span class="n">run_idx</span><span class="p">,</span> <span class="n">traj_idx</span><span class="p">,</span> <span class="n">field_path</span><span class="p">,</span>
                                               <span class="n">frames</span><span class="o">=</span><span class="n">frames</span><span class="p">,</span> <span class="n">masked</span><span class="o">=</span><span class="n">masked</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_contiguous_traj_field</span><span class="p">(</span><span class="n">run_idx</span><span class="p">,</span> <span class="n">traj_idx</span><span class="p">,</span> <span class="n">field_path</span><span class="p">,</span>
                                                   <span class="n">frames</span><span class="o">=</span><span class="n">frames</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_get_contiguous_traj_field</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run_idx</span><span class="p">,</span> <span class="n">traj_idx</span><span class="p">,</span> <span class="n">field_path</span><span class="p">,</span> <span class="n">frames</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="n">full_path</span> <span class="o">=</span> <span class="s2">&quot;/runs/</span><span class="si">{}</span><span class="s2">/trajectories/</span><span class="si">{}</span><span class="s2">/</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">run_idx</span><span class="p">,</span> <span class="n">traj_idx</span><span class="p">,</span> <span class="n">field_path</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">frames</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_h5</span><span class="p">[</span><span class="n">full_path</span><span class="p">][:]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_h5</span><span class="p">[</span><span class="n">full_path</span><span class="p">][</span><span class="nb">list</span><span class="p">(</span><span class="n">frames</span><span class="p">)]</span>

        <span class="k">return</span> <span class="n">field</span>

    <span class="k">def</span> <span class="nf">_get_sparse_traj_field</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run_idx</span><span class="p">,</span> <span class="n">traj_idx</span><span class="p">,</span> <span class="n">field_path</span><span class="p">,</span> <span class="n">frames</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">masked</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>

        <span class="n">traj_path</span> <span class="o">=</span> <span class="s2">&quot;/runs/</span><span class="si">{}</span><span class="s2">/trajectories/</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">run_idx</span><span class="p">,</span> <span class="n">traj_idx</span><span class="p">)</span>
        <span class="n">traj_grp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">h5</span><span class="p">[</span><span class="n">traj_path</span><span class="p">]</span>
        <span class="n">field</span> <span class="o">=</span> <span class="n">traj_grp</span><span class="p">[</span><span class="n">field_path</span><span class="p">]</span>

        <span class="n">n_frames</span> <span class="o">=</span> <span class="n">traj_grp</span><span class="p">[</span><span class="n">POSITIONS</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">frames</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">field</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][:]</span>

            <span class="c1"># if it is to be masked make the masked array</span>
            <span class="k">if</span> <span class="n">masked</span><span class="p">:</span>
                <span class="n">sparse_idxs</span> <span class="o">=</span> <span class="n">field</span><span class="p">[</span><span class="s1">&#39;_sparse_idxs&#39;</span><span class="p">][:]</span>

                <span class="n">filled_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span> <span class="p">(</span><span class="n">n_frames</span><span class="p">,</span> <span class="o">*</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:]),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
                <span class="n">filled_data</span><span class="p">[</span><span class="n">sparse_idxs</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span>

                <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span> <span class="p">(</span><span class="n">n_frames</span><span class="p">,</span> <span class="o">*</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:]),</span> <span class="kc">True</span><span class="p">)</span>
                <span class="n">mask</span><span class="p">[</span><span class="n">sparse_idxs</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

                <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_array</span><span class="p">(</span><span class="n">filled_data</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>

            <span class="c1"># get the sparse idxs and the frames to slice from the</span>
            <span class="c1"># data</span>
            <span class="n">sparse_idxs</span> <span class="o">=</span> <span class="n">field</span><span class="p">[</span><span class="s1">&#39;_sparse_idxs&#39;</span><span class="p">][:]</span>

            <span class="c1"># we get a boolean array of the rows of the data table</span>
            <span class="c1"># that we are to slice from</span>
            <span class="n">sparse_frame_idxs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">sparse_idxs</span><span class="p">,</span> <span class="n">frames</span><span class="p">))</span>

            <span class="n">data</span> <span class="o">=</span> <span class="n">field</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="nb">list</span><span class="p">(</span><span class="n">sparse_frame_idxs</span><span class="p">)]</span>

            <span class="c1"># if it is to be masked make the masked array</span>
            <span class="k">if</span> <span class="n">masked</span><span class="p">:</span>
                <span class="c1"># the empty arrays the size of the number of requested frames</span>
                <span class="n">filled_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">frames</span><span class="p">),</span> <span class="o">*</span><span class="n">field</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:]),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
                <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">frames</span><span class="p">),</span> <span class="o">*</span><span class="n">field</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:]),</span> <span class="kc">True</span> <span class="p">)</span>

                <span class="c1"># take the data which exists and is part of the frames</span>
                <span class="c1"># selection, and put it into the filled data where it is</span>
                <span class="c1"># supposed to be</span>
                <span class="n">filled_data</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">frames</span><span class="p">,</span> <span class="n">sparse_idxs</span><span class="p">)]</span> <span class="o">=</span> <span class="n">data</span>

                <span class="c1"># unmask the present values</span>
                <span class="n">mask</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">frames</span><span class="p">,</span> <span class="n">sparse_idxs</span><span class="p">)]</span> <span class="o">=</span> <span class="kc">False</span>

                <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_array</span><span class="p">(</span><span class="n">filled_data</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">data</span>


<div class="viewcode-block" id="WepyHDF5.get_trace_fields"><a class="viewcode-back" href="../../api/wepy.html#wepy.hdf5.WepyHDF5.get_trace_fields">[docs]</a>    <span class="k">def</span> <span class="nf">get_trace_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frame_tups</span><span class="p">,</span> <span class="n">fields</span><span class="p">):</span>
        <span class="n">frame_fields</span> <span class="o">=</span> <span class="p">{</span><span class="n">field</span> <span class="p">:</span> <span class="p">[]</span> <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">}</span>
        <span class="k">for</span> <span class="n">run_idx</span><span class="p">,</span> <span class="n">traj_idx</span><span class="p">,</span> <span class="n">cycle_idx</span> <span class="ow">in</span> <span class="n">frame_tups</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">:</span>
                <span class="n">frame_field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_traj_field</span><span class="p">(</span><span class="n">run_idx</span><span class="p">,</span> <span class="n">traj_idx</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">frames</span><span class="o">=</span><span class="p">[</span><span class="n">cycle_idx</span><span class="p">])</span>
                <span class="c1"># the first dimension doesn&#39;t matter here since we</span>
                <span class="c1"># only get one frame at a time.</span>
                <span class="n">frame_fields</span><span class="p">[</span><span class="n">field</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">frame_field</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="c1"># combine all the parts of each field into single arrays</span>
        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">:</span>
            <span class="n">frame_fields</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">frame_fields</span><span class="p">[</span><span class="n">field</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">frame_fields</span></div>

<div class="viewcode-block" id="WepyHDF5.get_run_trace_fields"><a class="viewcode-back" href="../../api/wepy.html#wepy.hdf5.WepyHDF5.get_run_trace_fields">[docs]</a>    <span class="k">def</span> <span class="nf">get_run_trace_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run_idx</span><span class="p">,</span> <span class="n">frame_tups</span><span class="p">,</span> <span class="n">fields</span><span class="p">):</span>
        <span class="n">frame_fields</span> <span class="o">=</span> <span class="p">{</span><span class="n">field</span> <span class="p">:</span> <span class="p">[]</span> <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">}</span>
        <span class="k">for</span> <span class="n">traj_idx</span><span class="p">,</span> <span class="n">cycle_idx</span> <span class="ow">in</span> <span class="n">frame_tups</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">:</span>
                <span class="n">frame_field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_traj_field</span><span class="p">(</span><span class="n">run_idx</span><span class="p">,</span> <span class="n">traj_idx</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">frames</span><span class="o">=</span><span class="p">[</span><span class="n">cycle_idx</span><span class="p">])</span>
                <span class="c1"># the first dimension doesn&#39;t matter here since we</span>
                <span class="c1"># only get one frame at a time.</span>
                <span class="n">frame_fields</span><span class="p">[</span><span class="n">field</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">frame_field</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="c1"># combine all the parts of each field into single arrays</span>
        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">:</span>
            <span class="n">frame_fields</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">frame_fields</span><span class="p">[</span><span class="n">field</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">frame_fields</span></div>


<div class="viewcode-block" id="WepyHDF5.get_contig_trace_fields"><a class="viewcode-back" href="../../api/wepy.html#wepy.hdf5.WepyHDF5.get_contig_trace_fields">[docs]</a>    <span class="k">def</span> <span class="nf">get_contig_trace_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">contig_trace</span><span class="p">,</span> <span class="n">fields</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Given a contig trace (run_idx, cycle_idx) returns a dictionary for</span>
<span class="sd">        each field where each value is an array of the values</span>
<span class="sd">        (N_cycles, N_trajs, *field_dims)</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># to be efficient we want to group our grabbing of fields by run</span>

        <span class="c1"># so we group them by run</span>
        <span class="n">runs_frames</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
        <span class="c1"># and we get the runs in the order to fetch them</span>
        <span class="n">run_idxs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">run_idx</span><span class="p">,</span> <span class="n">cycle_idx</span> <span class="ow">in</span> <span class="n">contig_trace</span><span class="p">:</span>
            <span class="n">runs_frames</span><span class="p">[</span><span class="n">run_idx</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cycle_idx</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">run_idx</span> <span class="ow">in</span> <span class="n">run_idxs</span><span class="p">:</span>
                <span class="n">run_idxs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">run_idx</span><span class="p">)</span>


        <span class="c1"># (there must be the same number of trajectories in each run)</span>
        <span class="n">n_trajs_test</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_run_trajs</span><span class="p">(</span><span class="n">run_idxs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">assert</span> <span class="nb">all</span><span class="p">([</span><span class="kc">True</span> <span class="k">if</span> <span class="n">n_trajs_test</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_run_trajs</span><span class="p">(</span><span class="n">run_idx</span><span class="p">)</span> <span class="k">else</span> <span class="kc">False</span>
                    <span class="k">for</span> <span class="n">run_idx</span> <span class="ow">in</span> <span class="n">run_idxs</span><span class="p">])</span>

        <span class="c1"># then using this we go run by run and get all the</span>
        <span class="c1"># trajectories</span>
        <span class="n">field_values</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">:</span>

            <span class="c1"># we gather trajectories in &quot;bundles&quot; (think sticks</span>
            <span class="c1"># strapped together) and each bundle represents a run, we</span>
            <span class="c1"># will concatenate the ends of the bundles together to get</span>
            <span class="c1"># the full array at the end</span>
            <span class="n">bundles</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">run_idx</span> <span class="ow">in</span> <span class="n">run_idxs</span><span class="p">:</span>

                <span class="n">run_bundle</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">traj_idx</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_traj_idxs</span><span class="p">(</span><span class="n">run_idx</span><span class="p">):</span>

                    <span class="c1"># get the values for this (field, run, trajectory)</span>
                    <span class="n">traj_field_vals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_traj_field</span><span class="p">(</span><span class="n">run_idx</span><span class="p">,</span> <span class="n">traj_idx</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span>
                                                          <span class="n">frames</span><span class="o">=</span><span class="n">runs_frames</span><span class="p">[</span><span class="n">run_idx</span><span class="p">],</span>
                                                          <span class="n">masked</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

                    <span class="n">run_bundle</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">traj_field_vals</span><span class="p">)</span>

                <span class="c1"># convert this &quot;bundle&quot; of trajectory values (think</span>
                <span class="c1"># sticks side by side) into an array</span>
                <span class="n">run_bundle</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">run_bundle</span><span class="p">)</span>
                <span class="n">bundles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">run_bundle</span><span class="p">)</span>

            <span class="c1"># stick the bundles together end to end to make the value</span>
            <span class="c1"># for this field , the first dimension currently is the</span>
            <span class="c1"># trajectory_index, but we want to make the cycles the</span>
            <span class="c1"># first dimension. So we stack them along that axis then</span>
            <span class="c1"># transpose the first two axes (not the rest of them which</span>
            <span class="c1"># should stay the same). Pardon the log terminology, but I</span>
            <span class="c1"># don&#39;t know a name for a bunch of bundles taped together.</span>
            <span class="n">field_log</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">bundles</span><span class="p">))</span>
            <span class="n">field_log</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="n">field_log</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

            <span class="n">field_values</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="n">field_log</span>


        <span class="k">return</span> <span class="n">field_values</span></div>

    <span class="k">def</span> <span class="nf">_add_run_field</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run_idx</span><span class="p">,</span> <span class="n">field_path</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">sparse_idxs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Add a field to your trajectories runs&quot;&quot;&quot;</span>

        <span class="c1"># check that the data has the correct number of trajectories</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_run_trajs</span><span class="p">(</span><span class="n">run_idx</span><span class="p">),</span>\
            <span class="s2">&quot;The number of trajectories in data, </span><span class="si">{}</span><span class="s2">, is different than the number&quot;</span>\
            <span class="s2">&quot;of trajectories in the run, </span><span class="si">{}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_run_trajs</span><span class="p">(</span><span class="n">run_idx</span><span class="p">))</span>

        <span class="c1"># for each trajectory check that the data is compliant</span>
        <span class="k">for</span> <span class="n">traj_idx</span><span class="p">,</span> <span class="n">traj_data</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
            <span class="c1"># check that the number of frames is not larger than that for the run</span>
            <span class="k">if</span> <span class="n">traj_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_n_frames</span><span class="p">(</span><span class="n">run_idx</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The number of frames in data for traj </span><span class="si">{}</span><span class="s2"> , </span><span class="si">{}</span><span class="s2">,&quot;</span>
                                  <span class="s2">&quot;is larger than the number of frames&quot;</span>
                                  <span class="s2">&quot;for this run, </span><span class="si">{}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                          <span class="n">traj_idx</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_n_frames</span><span class="p">(</span><span class="n">run_idx</span><span class="p">)))</span>


            <span class="c1"># if the number of frames given is the same or less than</span>
            <span class="c1"># the number of frames in the run</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">traj_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_n_frames</span><span class="p">(</span><span class="n">run_idx</span><span class="p">)):</span>

                <span class="c1"># if sparse idxs were given we check to see there is</span>
                <span class="c1"># the right number of them</span>
                <span class="k">if</span> <span class="n">sparse_idxs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="c1">#  and that they match the number of frames given</span>
                    <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sparse_idxs</span><span class="p">[</span><span class="n">traj_idx</span><span class="p">]):</span>

                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The number of frames provided for traj </span><span class="si">{}</span><span class="s2">, </span><span class="si">{}</span><span class="s2">,&quot;</span>
                                          <span class="s2">&quot;was less than the total number of frames, </span><span class="si">{}</span><span class="s2">,&quot;</span>
                                          <span class="s2">&quot;but an incorrect number of sparse idxs were supplied, </span><span class="si">{}</span><span class="s2">.&quot;</span>\
                                         <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">traj_idx</span><span class="p">,</span> <span class="n">traj_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                            <span class="bp">self</span><span class="o">.</span><span class="n">run_n_frames</span><span class="p">(</span><span class="n">run_idx</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">sparse_idxs</span><span class="p">[</span><span class="n">traj_idx</span><span class="p">])))</span>


                <span class="c1"># if there were strictly fewer frames given and the</span>
                <span class="c1"># sparse idxs were not given we need to raise an error</span>
                <span class="k">elif</span> <span class="p">(</span><span class="n">traj_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_n_frames</span><span class="p">(</span><span class="n">run_idx</span><span class="p">)):</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The number of frames provided for traj </span><span class="si">{}</span><span class="s2">, </span><span class="si">{}</span><span class="s2">,&quot;</span>
                                      <span class="s2">&quot;was less than the total number of frames, </span><span class="si">{}</span><span class="s2">,&quot;</span>
                                      <span class="s2">&quot;but sparse_idxs were not supplied.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                              <span class="n">traj_idx</span><span class="p">,</span> <span class="n">traj_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                              <span class="bp">self</span><span class="o">.</span><span class="n">run_n_frames</span><span class="p">(</span><span class="n">run_idx</span><span class="p">)))</span>

        <span class="c1"># add it to each traj</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">idx_tup</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">run_traj_idx_tuples</span><span class="p">([</span><span class="n">run_idx</span><span class="p">])):</span>
            <span class="k">if</span> <span class="n">sparse_idxs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_add_traj_field_data</span><span class="p">(</span><span class="o">*</span><span class="n">idx_tup</span><span class="p">,</span> <span class="n">field_path</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_add_traj_field_data</span><span class="p">(</span><span class="o">*</span><span class="n">idx_tup</span><span class="p">,</span> <span class="n">field_path</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                                          <span class="n">sparse_idxs</span><span class="o">=</span><span class="n">sparse_idxs</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">_add_field</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field_path</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">sparse_idxs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">run_idx</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">run_idxs</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">sparse_idxs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_add_run_field</span><span class="p">(</span><span class="n">run_idx</span><span class="p">,</span> <span class="n">field_path</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">sparse_idxs</span><span class="o">=</span><span class="n">sparse_idxs</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_add_run_field</span><span class="p">(</span><span class="n">run_idx</span><span class="p">,</span> <span class="n">field_path</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

<div class="viewcode-block" id="WepyHDF5.iter_runs"><a class="viewcode-back" href="../../api/wepy.html#wepy.hdf5.WepyHDF5.iter_runs">[docs]</a>    <span class="k">def</span> <span class="nf">iter_runs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idxs</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">run_sel</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Iterate through runs.</span>

<span class="sd">        idxs : if True returns `(run_idx, run_group)`, False just `run_group`</span>

<span class="sd">        run_sel : if True will iterate over a subset of runs. Possible</span>
<span class="sd">        values are an iterable of indices of runs to iterate over.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">run_sel</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">run_sel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_idxs</span>

        <span class="k">for</span> <span class="n">run_idx</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_idxs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">run_idx</span> <span class="ow">in</span> <span class="n">run_sel</span><span class="p">:</span>
                <span class="n">run</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">run_idx</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">idxs</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="n">run_idx</span><span class="p">,</span> <span class="n">run</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="n">run</span></div>

<div class="viewcode-block" id="WepyHDF5.iter_trajs"><a class="viewcode-back" href="../../api/wepy.html#wepy.hdf5.WepyHDF5.iter_trajs">[docs]</a>    <span class="k">def</span> <span class="nf">iter_trajs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idxs</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">traj_sel</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Generator for all of the trajectories in the dataset across all</span>
<span class="sd">        runs. If idxs=True will return a tuple of (run_idx, traj_idx).</span>

<span class="sd">        run_sel : if True will iterate over a subset of</span>
<span class="sd">        trajectories. Possible values are an iterable of `(run_idx,</span>
<span class="sd">        traj_idx)` tuples.</span>

<span class="sd">        &quot;&quot;&quot;</span>


        <span class="c1"># set the selection of trajectories to iterate over</span>
        <span class="k">if</span> <span class="n">traj_sel</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">idx_tups</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_traj_idx_tuples</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">idx_tups</span> <span class="o">=</span> <span class="n">traj_sel</span>

        <span class="c1"># get each traj for each idx_tup and yield them for the generator</span>
        <span class="k">for</span> <span class="n">run_idx</span><span class="p">,</span> <span class="n">traj_idx</span> <span class="ow">in</span> <span class="n">idx_tups</span><span class="p">:</span>
            <span class="n">traj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">traj</span><span class="p">(</span><span class="n">run_idx</span><span class="p">,</span> <span class="n">traj_idx</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">idxs</span><span class="p">:</span>
                <span class="k">yield</span> <span class="p">(</span><span class="n">run_idx</span><span class="p">,</span> <span class="n">traj_idx</span><span class="p">),</span> <span class="n">traj</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">traj</span></div>

<div class="viewcode-block" id="WepyHDF5.iter_run_trajs"><a class="viewcode-back" href="../../api/wepy.html#wepy.hdf5.WepyHDF5.iter_run_trajs">[docs]</a>    <span class="k">def</span> <span class="nf">iter_run_trajs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run_idx</span><span class="p">,</span> <span class="n">idxs</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">run_sel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_traj_idx_tuples</span><span class="p">([</span><span class="n">run_idx</span><span class="p">])</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">iter_trajs</span><span class="p">(</span><span class="n">idxs</span><span class="o">=</span><span class="n">idxs</span><span class="p">,</span> <span class="n">traj_sel</span><span class="o">=</span><span class="n">run_sel</span><span class="p">)</span></div>

<div class="viewcode-block" id="WepyHDF5.iter_trajs_fields"><a class="viewcode-back" href="../../api/wepy.html#wepy.hdf5.WepyHDF5.iter_trajs_fields">[docs]</a>    <span class="k">def</span> <span class="nf">iter_trajs_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">idxs</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">traj_sel</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Generator for all of the specified non-compound fields</span>
<span class="sd">        h5py.Datasets for all trajectories in the dataset across all</span>
<span class="sd">        runs. Fields is a list of valid relative paths to datasets in</span>
<span class="sd">        the trajectory groups.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">for</span> <span class="n">idx_tup</span><span class="p">,</span> <span class="n">traj</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">iter_trajs</span><span class="p">(</span><span class="n">idxs</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">traj_sel</span><span class="o">=</span><span class="n">traj_sel</span><span class="p">):</span>
            <span class="n">run_idx</span><span class="p">,</span> <span class="n">traj_idx</span> <span class="o">=</span> <span class="n">idx_tup</span>

            <span class="n">dsets</span> <span class="o">=</span> <span class="p">{}</span>

            <span class="c1"># DEBUG if we ask for debug prints send in the run and</span>
            <span class="c1"># traj index so the function can print this out</span>
            <span class="n">dsets</span><span class="p">[</span><span class="s1">&#39;run_idx&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">run_idx</span>
            <span class="n">dsets</span><span class="p">[</span><span class="s1">&#39;traj_idx&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">traj_idx</span>

            <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">dset</span> <span class="o">=</span> <span class="n">traj</span><span class="p">[</span><span class="n">field</span><span class="p">][:]</span>
                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                    <span class="n">warn</span><span class="p">(</span><span class="s2">&quot;field </span><span class="se">\&quot;</span><span class="si">{}</span><span class="se">\&quot;</span><span class="s2"> not found in </span><span class="se">\&quot;</span><span class="si">{}</span><span class="se">\&quot;</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">traj</span><span class="o">.</span><span class="n">name</span><span class="p">),</span> <span class="ne">RuntimeWarning</span><span class="p">)</span>
                    <span class="n">dset</span> <span class="o">=</span> <span class="kc">None</span>

                <span class="n">dsets</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="n">dset</span>

            <span class="k">if</span> <span class="n">idxs</span><span class="p">:</span>
                <span class="k">yield</span> <span class="p">(</span><span class="n">run_idx</span><span class="p">,</span> <span class="n">traj_idx</span><span class="p">),</span> <span class="n">dsets</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">dsets</span></div>

<div class="viewcode-block" id="WepyHDF5.run_map"><a class="viewcode-back" href="../../api/wepy.html#wepy.hdf5.WepyHDF5.run_map">[docs]</a>    <span class="k">def</span> <span class="nf">run_map</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">map_func</span><span class="o">=</span><span class="nb">map</span><span class="p">,</span> <span class="n">idxs</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">run_sel</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Function for mapping work onto trajectories in the WepyHDF5 file</span>
<span class="sd">           object. The call to iter_runs is run with `idxs=False`.</span>

<span class="sd">        func : the function that will be mapped to trajectory groups</span>

<span class="sd">        map_func : the function that maps the function. This is where</span>
<span class="sd">                        parallelization occurs if desired.  Defaults to</span>
<span class="sd">                        the serial python map function.</span>

<span class="sd">        traj_sel : a trajectory selection. This is a valid `traj_sel`</span>
<span class="sd">        argument for the `iter_trajs` function.</span>

<span class="sd">        idxs : if True results contain [(run_idx, result),...], if False</span>
<span class="sd">        returns [result,...]</span>

<span class="sd">        *args : additional arguments to the function. If this is an</span>
<span class="sd">                 iterable it will be assumed that it is the appropriate</span>
<span class="sd">                 length for the number of trajectories, WARNING: this will</span>
<span class="sd">                 not be checked and could result in a run time</span>
<span class="sd">                 error. Otherwise single values will be automatically</span>
<span class="sd">                 mapped to all trajectories.</span>

<span class="sd">        **kwargs : same as *args, but will pass all kwargs to the func.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># check the args and kwargs to see if they need expanded for</span>
        <span class="c1"># mapping inputs</span>
        <span class="n">mapped_args</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
            <span class="c1"># if it is a sequence or generator we keep just pass it to the mapper</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_runs</span><span class="p">,</span> \
                    <span class="s2">&quot;argument Sequence has fewer number of args then trajectories&quot;</span>
                <span class="n">mapped_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
            <span class="c1"># if it is not a sequence or generator we make a generator out</span>
            <span class="c1"># of it to map as inputs</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">mapped_arg</span> <span class="o">=</span> <span class="p">(</span><span class="n">arg</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_runs</span><span class="p">))</span>
                <span class="n">mapped_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mapped_arg</span><span class="p">)</span>


        <span class="n">results</span> <span class="o">=</span> <span class="n">map_func</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">iter_runs</span><span class="p">(</span><span class="n">idxs</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">run_sel</span><span class="o">=</span><span class="n">run_sel</span><span class="p">),</span>
                           <span class="o">*</span><span class="n">mapped_args</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">idxs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">run_sel</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">run_sel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_idxs</span>
            <span class="k">return</span> <span class="nb">zip</span><span class="p">(</span><span class="n">run_sel</span><span class="p">,</span> <span class="n">results</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">results</span></div>


<div class="viewcode-block" id="WepyHDF5.traj_map"><a class="viewcode-back" href="../../api/wepy.html#wepy.hdf5.WepyHDF5.traj_map">[docs]</a>    <span class="k">def</span> <span class="nf">traj_map</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">map_func</span><span class="o">=</span><span class="nb">map</span><span class="p">,</span> <span class="n">idxs</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">traj_sel</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Function for mapping work onto trajectories in the WepyHDF5 file object.</span>

<span class="sd">        func : the function that will be mapped to trajectory groups</span>

<span class="sd">        map_func : the function that maps the function. This is where</span>
<span class="sd">                        parallelization occurs if desired.  Defaults to</span>
<span class="sd">                        the serial python map function.</span>

<span class="sd">        traj_sel : a trajectory selection. This is a valid `traj_sel`</span>
<span class="sd">        argument for the `iter_trajs` function.</span>

<span class="sd">        *args : additional arguments to the function. If this is an</span>
<span class="sd">                 iterable it will be assumed that it is the appropriate</span>
<span class="sd">                 length for the number of trajectories, WARNING: this will</span>
<span class="sd">                 not be checked and could result in a run time</span>
<span class="sd">                 error. Otherwise single values will be automatically</span>
<span class="sd">                 mapped to all trajectories.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># check the args and kwargs to see if they need expanded for</span>
        <span class="c1"># mapping inputs</span>
        <span class="n">mapped_args</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
            <span class="c1"># if it is a sequence or generator we keep just pass it to the mapper</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_trajs</span><span class="p">,</span> <span class="s2">&quot;Sequence has fewer&quot;</span>
                <span class="n">mapped_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
            <span class="c1"># if it is not a sequence or generator we make a generator out</span>
            <span class="c1"># of it to map as inputs</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">mapped_arg</span> <span class="o">=</span> <span class="p">(</span><span class="n">arg</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_trajs</span><span class="p">))</span>
                <span class="n">mapped_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mapped_arg</span><span class="p">)</span>

        <span class="n">results</span> <span class="o">=</span> <span class="n">map_func</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">iter_trajs</span><span class="p">(</span><span class="n">traj_sel</span><span class="o">=</span><span class="n">traj_sel</span><span class="p">),</span> <span class="o">*</span><span class="n">mapped_args</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">idxs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">traj_sel</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">traj_sel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_traj_idx_tuples</span><span class="p">()</span>
            <span class="k">return</span> <span class="nb">zip</span><span class="p">(</span><span class="n">traj_sel</span><span class="p">,</span> <span class="n">results</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">results</span></div>

<div class="viewcode-block" id="WepyHDF5.traj_fields_map"><a class="viewcode-back" href="../../api/wepy.html#wepy.hdf5.WepyHDF5.traj_fields_map">[docs]</a>    <span class="k">def</span> <span class="nf">traj_fields_map</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">map_func</span><span class="o">=</span><span class="nb">map</span><span class="p">,</span> <span class="n">idxs</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">traj_sel</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Function for mapping work onto field of trajectories in the</span>
<span class="sd">        WepyHDF5 file object. Similar to traj_map, except `h5py.Group`</span>
<span class="sd">        objects cannot be pickled for message passing. So we select</span>
<span class="sd">        the fields to serialize instead and pass the `numpy.ndarray`s</span>
<span class="sd">        to have the work mapped to them.</span>

<span class="sd">        func : the function that will be mapped to trajectory groups</span>

<span class="sd">        fields : list of fields that will be serialized into a dictionary</span>
<span class="sd">                 and passed to the map function. These must be valid</span>
<span class="sd">                 `h5py` path strings relative to the trajectory</span>
<span class="sd">                 group. These include the standard fields like</span>
<span class="sd">                 &#39;positions&#39; and &#39;weights&#39;, as well as compound paths</span>
<span class="sd">                 e.g. &#39;observables/sasa&#39;.</span>

<span class="sd">        map_func : the function that maps the function. This is where</span>
<span class="sd">                        parallelization occurs if desired.  Defaults to</span>
<span class="sd">                        the serial python map function.</span>

<span class="sd">        traj_sel : a trajectory selection. This is a valid `traj_sel`</span>
<span class="sd">        argument for the `iter_trajs` function.</span>

<span class="sd">        *args : additional arguments to the function. If this is an</span>
<span class="sd">                 iterable it will be assumed that it is the appropriate</span>
<span class="sd">                 length for the number of trajectories, WARNING: this will</span>
<span class="sd">                 not be checked and could result in a run time</span>
<span class="sd">                 error. Otherwise single values will be automatically</span>
<span class="sd">                 mapped to all trajectories.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># check the args and kwargs to see if they need expanded for</span>
        <span class="c1"># mapping inputs</span>
        <span class="c1">#first go through each run and get the number of cycles</span>
        <span class="n">n_cycles</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">run_idx</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_idxs</span><span class="p">:</span>
            <span class="n">n_cycles</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_n_cycles</span><span class="p">(</span><span class="n">run_idx</span><span class="p">)</span>

        <span class="n">mapped_args</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
            <span class="c1"># if it is a sequence or generator we keep just pass it to the mapper</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">n_cycles</span><span class="p">),</span> <span class="s2">&quot;Sequence has fewer&quot;</span>
                <span class="n">mapped_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
            <span class="c1"># if it is not a sequence or generator we make a generator out</span>
            <span class="c1"># of it to map as inputs</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">mapped_arg</span> <span class="o">=</span> <span class="p">(</span><span class="n">arg</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_cycles</span><span class="p">))</span>
                <span class="n">mapped_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mapped_arg</span><span class="p">)</span>


        <span class="n">results</span> <span class="o">=</span> <span class="n">map_func</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">iter_trajs_fields</span><span class="p">(</span><span class="n">fields</span><span class="p">,</span> <span class="n">traj_sel</span><span class="o">=</span><span class="n">traj_sel</span><span class="p">,</span> <span class="n">idxs</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
                           <span class="o">*</span><span class="n">mapped_args</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">idxs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">traj_sel</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">traj_sel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_traj_idx_tuples</span><span class="p">()</span>
            <span class="k">return</span> <span class="nb">zip</span><span class="p">(</span><span class="n">traj_sel</span><span class="p">,</span> <span class="n">results</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">results</span></div>

<div class="viewcode-block" id="WepyHDF5.add_run_observable"><a class="viewcode-back" href="../../api/wepy.html#wepy.hdf5.WepyHDF5.add_run_observable">[docs]</a>    <span class="k">def</span> <span class="nf">add_run_observable</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run_idx</span><span class="p">,</span> <span class="n">observable_name</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">sparse_idxs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">obs_path</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">/</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">OBSERVABLES</span><span class="p">,</span> <span class="n">observable_name</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_add_run_field</span><span class="p">(</span><span class="n">run_idx</span><span class="p">,</span> <span class="n">obs_path</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">sparse_idxs</span><span class="o">=</span><span class="n">sparse_idxs</span><span class="p">)</span></div>


<div class="viewcode-block" id="WepyHDF5.add_observable"><a class="viewcode-back" href="../../api/wepy.html#wepy.hdf5.WepyHDF5.add_observable">[docs]</a>    <span class="k">def</span> <span class="nf">add_observable</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">observable_name</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">sparse_idxs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">obs_path</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">/</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">OBSERVABLES</span><span class="p">,</span> <span class="n">observable_name</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_add_field</span><span class="p">(</span><span class="n">obs_path</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">sparse_idxs</span><span class="o">=</span><span class="n">sparse_idxs</span><span class="p">)</span></div>

<div class="viewcode-block" id="WepyHDF5.compute_observable"><a class="viewcode-back" href="../../api/wepy.html#wepy.hdf5.WepyHDF5.compute_observable">[docs]</a>    <span class="k">def</span> <span class="nf">compute_observable</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span>
                           <span class="n">map_func</span><span class="o">=</span><span class="nb">map</span><span class="p">,</span>
                           <span class="n">traj_sel</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                           <span class="n">save_to_hdf5</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">idxs</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">return_results</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Compute an observable on the trajectory data according to a</span>
<span class="sd">        function. Optionally save that data in the observables data group for</span>
<span class="sd">        the trajectory.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">save_to_hdf5</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="s1">&#39;w-&#39;</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;r+&#39;</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="s1">&#39;c-&#39;</span><span class="p">],</span>\
                <span class="s2">&quot;File must be in a write mode&quot;</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">save_to_hdf5</span><span class="p">,</span> <span class="nb">str</span><span class="p">),</span>\
                <span class="s2">&quot;`save_to_hdf5` should be the field name to save the data in the `observables`&quot;</span>\
                <span class="s2">&quot; group in each trajectory&quot;</span>
            <span class="n">field_name</span><span class="o">=</span><span class="n">save_to_hdf5</span>

            <span class="c1"># DEBUG enforce this until sparse trajectories are implemented</span>
            <span class="c1"># assert traj_sel is None, &quot;no selections until sparse trajectory data is implemented&quot;</span>

        <span class="k">if</span> <span class="n">return_results</span><span class="p">:</span>
            <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">traj_fields_map</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span>
                                           <span class="n">map_func</span><span class="o">=</span><span class="n">map_func</span><span class="p">,</span> <span class="n">traj_sel</span><span class="o">=</span><span class="n">traj_sel</span><span class="p">,</span> <span class="n">idxs</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>

            <span class="n">idx_tup</span><span class="p">,</span> <span class="n">obs_features</span> <span class="o">=</span> <span class="n">result</span>
            <span class="n">run_idx</span><span class="p">,</span> <span class="n">traj_idx</span> <span class="o">=</span> <span class="n">idx_tup</span>

            <span class="c1"># if we are saving this to the trajectories observables add it as a dataset</span>
            <span class="k">if</span> <span class="n">save_to_hdf5</span><span class="p">:</span>

                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Saving run </span><span class="si">{}</span><span class="s2"> traj </span><span class="si">{}</span><span class="s2"> observables/</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">run_idx</span><span class="p">,</span> <span class="n">traj_idx</span><span class="p">,</span> <span class="n">field_name</span><span class="p">))</span>

                <span class="c1"># try to get the observables group or make it if it doesn&#39;t exist</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">obs_grp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">traj</span><span class="p">(</span><span class="n">run_idx</span><span class="p">,</span> <span class="n">traj_idx</span><span class="p">)[</span><span class="n">OBSERVABLES</span><span class="p">]</span>
                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>

                    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Group uninitialized. Initializing.&quot;</span><span class="p">)</span>

                    <span class="n">obs_grp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">traj</span><span class="p">(</span><span class="n">run_idx</span><span class="p">,</span> <span class="n">traj_idx</span><span class="p">)</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="n">OBSERVABLES</span><span class="p">)</span>

                <span class="c1"># try to create the dataset</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">obs_grp</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="n">field_name</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">obs_features</span><span class="p">)</span>
                <span class="c1"># if it fails we either overwrite or raise an error</span>
                <span class="k">except</span> <span class="ne">RuntimeError</span><span class="p">:</span>
                    <span class="c1"># if we are in a permissive write mode we delete the</span>
                    <span class="c1"># old dataset and add the new one, overwriting old data</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="s1">&#39;w-&#39;</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;r+&#39;</span><span class="p">]:</span>

                        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Dataset already present. Overwriting.&quot;</span><span class="p">)</span>

                        <span class="k">del</span> <span class="n">obs_grp</span><span class="p">[</span><span class="n">field_name</span><span class="p">]</span>
                        <span class="n">obs_grp</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="n">field_name</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">obs_features</span><span class="p">)</span>
                    <span class="c1"># this will happen in &#39;c&#39; and &#39;c-&#39; modes</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                            <span class="s2">&quot;Dataset already exists and file is in concatenate mode (&#39;c&#39; or &#39;c-&#39;)&quot;</span><span class="p">)</span>

            <span class="c1"># also return it if requested</span>
            <span class="k">if</span> <span class="n">return_results</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">idxs</span><span class="p">:</span>
                    <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">((</span> <span class="n">idx_tup</span><span class="p">,</span> <span class="n">obs_features</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">obs_features</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">return_results</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">results</span></div>



<div class="viewcode-block" id="WepyHDF5.records_grp"><a class="viewcode-back" href="../../api/wepy.html#wepy.hdf5.WepyHDF5.records_grp">[docs]</a>    <span class="k">def</span> <span class="nf">records_grp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run_idx</span><span class="p">,</span> <span class="n">run_record_key</span><span class="p">):</span>
        <span class="n">path</span> <span class="o">=</span> <span class="s2">&quot;runs/</span><span class="si">{}</span><span class="s2">/</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">run_idx</span><span class="p">,</span> <span class="n">run_record_key</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">h5</span><span class="p">[</span><span class="n">path</span><span class="p">]</span></div>

<div class="viewcode-block" id="WepyHDF5.resampling_grp"><a class="viewcode-back" href="../../api/wepy.html#wepy.hdf5.WepyHDF5.resampling_grp">[docs]</a>    <span class="k">def</span> <span class="nf">resampling_grp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run_idx</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">records_grp</span><span class="p">(</span><span class="n">run_idx</span><span class="p">,</span> <span class="n">RESAMPLING</span><span class="p">)</span></div>

<div class="viewcode-block" id="WepyHDF5.resampler_grp"><a class="viewcode-back" href="../../api/wepy.html#wepy.hdf5.WepyHDF5.resampler_grp">[docs]</a>    <span class="k">def</span> <span class="nf">resampler_grp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run_idx</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">records_grp</span><span class="p">(</span><span class="n">run_idx</span><span class="p">,</span> <span class="n">RESAMPLER</span><span class="p">)</span></div>

<div class="viewcode-block" id="WepyHDF5.warping_grp"><a class="viewcode-back" href="../../api/wepy.html#wepy.hdf5.WepyHDF5.warping_grp">[docs]</a>    <span class="k">def</span> <span class="nf">warping_grp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run_idx</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">records_grp</span><span class="p">(</span><span class="n">run_idx</span><span class="p">,</span> <span class="n">WARPING</span><span class="p">)</span></div>

<div class="viewcode-block" id="WepyHDF5.bc_grp"><a class="viewcode-back" href="../../api/wepy.html#wepy.hdf5.WepyHDF5.bc_grp">[docs]</a>    <span class="k">def</span> <span class="nf">bc_grp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run_idx</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">records_grp</span><span class="p">(</span><span class="n">run_idx</span><span class="p">,</span> <span class="n">BC</span><span class="p">)</span></div>

<div class="viewcode-block" id="WepyHDF5.progress_grp"><a class="viewcode-back" href="../../api/wepy.html#wepy.hdf5.WepyHDF5.progress_grp">[docs]</a>    <span class="k">def</span> <span class="nf">progress_grp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run_idx</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">records_grp</span><span class="p">(</span><span class="n">run_idx</span><span class="p">,</span> <span class="n">PROGRESS</span><span class="p">)</span></div>

<div class="viewcode-block" id="WepyHDF5.run_records"><a class="viewcode-back" href="../../api/wepy.html#wepy.hdf5.WepyHDF5.run_records">[docs]</a>    <span class="k">def</span> <span class="nf">run_records</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run_idx</span><span class="p">,</span> <span class="n">run_record_key</span><span class="p">):</span>

        <span class="c1"># wrap this in a list since the underlying functions accept a</span>
        <span class="c1"># list of records</span>
        <span class="n">run_idxs</span> <span class="o">=</span> <span class="p">[</span><span class="n">run_idx</span><span class="p">]</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">contig_records</span><span class="p">(</span><span class="n">run_idxs</span><span class="p">,</span> <span class="n">run_record_key</span><span class="p">)</span></div>

<div class="viewcode-block" id="WepyHDF5.contig_records"><a class="viewcode-back" href="../../api/wepy.html#wepy.hdf5.WepyHDF5.contig_records">[docs]</a>    <span class="k">def</span> <span class="nf">contig_records</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run_idxs</span><span class="p">,</span> <span class="n">run_record_key</span><span class="p">):</span>

        <span class="c1"># if there are no fields return an empty list</span>
        <span class="n">record_fields</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">record_fields</span><span class="p">[</span><span class="n">run_record_key</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">record_fields</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>

        <span class="c1"># get the iterator for the record idxs, if the group is</span>
        <span class="c1"># sporadic then we just use the cycle idxs</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_sporadic_records</span><span class="p">(</span><span class="n">run_record_key</span><span class="p">):</span>
            <span class="n">records</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_records_sporadic</span><span class="p">(</span><span class="n">run_idxs</span><span class="p">,</span> <span class="n">run_record_key</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">records</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_records_continual</span><span class="p">(</span><span class="n">run_idxs</span><span class="p">,</span> <span class="n">run_record_key</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">records</span></div>


    <span class="k">def</span> <span class="nf">_run_record_namedtuple</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run_record_key</span><span class="p">):</span>

        <span class="n">Record</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_Record&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">run_record_key</span><span class="p">),</span>
                            <span class="p">[</span><span class="s1">&#39;cycle_idx&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">record_fields</span><span class="p">[</span><span class="n">run_record_key</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">Record</span>

    <span class="k">def</span> <span class="nf">_convert_record_field_to_table_column</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run_idx</span><span class="p">,</span> <span class="n">run_record_key</span><span class="p">,</span> <span class="n">record_field</span><span class="p">):</span>

        <span class="c1"># get the field dataset</span>
        <span class="n">rec_grp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">records_grp</span><span class="p">(</span><span class="n">run_idx</span><span class="p">,</span> <span class="n">run_record_key</span><span class="p">)</span>
        <span class="n">dset</span> <span class="o">=</span> <span class="n">rec_grp</span><span class="p">[</span><span class="n">record_field</span><span class="p">]</span>

        <span class="c1"># if it is variable length or if it has more than one element</span>
        <span class="c1"># cast all elements to tuples</span>
        <span class="k">if</span> <span class="n">h5py</span><span class="o">.</span><span class="n">check_dtype</span><span class="p">(</span><span class="n">vlen</span><span class="o">=</span><span class="n">dset</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">rec_dset</span> <span class="o">=</span> <span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">dset</span><span class="p">[:]]</span>

        <span class="c1"># if it is not variable length make sure it is not more than a</span>
        <span class="c1"># 1D feature vector</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">dset</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                <span class="s2">&quot;cannot convert fields with feature vectors more than 1 dimension,&quot;</span>
                <span class="s2">&quot; was given </span><span class="si">{}</span><span class="s2"> for </span><span class="si">{}</span><span class="s2">/</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">dset</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">run_record_key</span><span class="p">,</span> <span class="n">record_field</span><span class="p">))</span>

        <span class="c1"># if it is only a rank 1 feature vector and it has more than</span>
        <span class="c1"># one element make a tuple out of it</span>
        <span class="k">elif</span> <span class="n">dset</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">rec_dset</span> <span class="o">=</span> <span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">dset</span><span class="p">[:]]</span>

        <span class="c1"># otherwise just get the single value instead of keeping it as</span>
        <span class="c1"># a single valued feature vector</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">rec_dset</span> <span class="o">=</span> <span class="p">[</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">dset</span><span class="p">[:]]</span>

        <span class="k">return</span> <span class="n">rec_dset</span>

    <span class="k">def</span> <span class="nf">_convert_record_fields_to_table_columns</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run_idx</span><span class="p">,</span> <span class="n">run_record_key</span><span class="p">):</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">record_field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">record_fields</span><span class="p">[</span><span class="n">run_record_key</span><span class="p">]:</span>
            <span class="n">fields</span><span class="p">[</span><span class="n">record_field</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_convert_record_field_to_table_column</span><span class="p">(</span>
                                           <span class="n">run_idx</span><span class="p">,</span> <span class="n">run_record_key</span><span class="p">,</span> <span class="n">record_field</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">fields</span>

    <span class="k">def</span> <span class="nf">_make_records</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run_record_key</span><span class="p">,</span> <span class="n">cycle_idxs</span><span class="p">,</span> <span class="n">fields</span><span class="p">):</span>
        <span class="n">Record</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_record_namedtuple</span><span class="p">(</span><span class="n">run_record_key</span><span class="p">)</span>

        <span class="c1"># for each record we make a tuple and yield it</span>
        <span class="n">records</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">record_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cycle_idxs</span><span class="p">)):</span>

            <span class="c1"># make a record for this cycle</span>
            <span class="n">record_d</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;cycle_idx&#39;</span> <span class="p">:</span> <span class="n">cycle_idxs</span><span class="p">[</span><span class="n">record_idx</span><span class="p">]}</span>
            <span class="k">for</span> <span class="n">record_field</span><span class="p">,</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">fields</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">datum</span> <span class="o">=</span> <span class="n">column</span><span class="p">[</span><span class="n">record_idx</span><span class="p">]</span>
                <span class="n">record_d</span><span class="p">[</span><span class="n">record_field</span><span class="p">]</span> <span class="o">=</span> <span class="n">datum</span>

            <span class="n">record</span> <span class="o">=</span> <span class="n">Record</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">record_d</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">Record</span><span class="o">.</span><span class="n">_fields</span><span class="p">))</span>

            <span class="n">records</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">record</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">records</span>

    <span class="k">def</span> <span class="nf">_run_records_sporadic</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run_idxs</span><span class="p">,</span> <span class="n">run_record_key</span><span class="p">):</span>

        <span class="c1"># we loop over the run_idxs in the contig and get the fields</span>
        <span class="c1"># and cycle idxs for the whole contig</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">cycle_idxs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
        <span class="c1"># keep a cumulative total of the runs cycle idxs</span>
        <span class="n">prev_run_cycle_total</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">run_idx</span> <span class="ow">in</span> <span class="n">run_idxs</span><span class="p">:</span>

            <span class="c1"># get all the value columns from the datasets, and convert</span>
            <span class="c1"># them to something amenable to a table</span>
            <span class="n">run_fields</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_convert_record_fields_to_table_columns</span><span class="p">(</span><span class="n">run_idx</span><span class="p">,</span> <span class="n">run_record_key</span><span class="p">)</span>

            <span class="c1"># we need to concatenate each field to the end of the</span>
            <span class="c1"># field in the master dictionary, first we need to</span>
            <span class="c1"># initialize it if it isn&#39;t already made</span>
            <span class="k">if</span> <span class="n">fields</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># if it isn&#39;t initialized we just set it as this first</span>
                <span class="c1"># run fields dictionary</span>
                <span class="n">fields</span> <span class="o">=</span> <span class="n">run_fields</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># if it is already initialized we need to go through</span>
                <span class="c1"># each field and concatenate</span>
                <span class="k">for</span> <span class="n">field_name</span><span class="p">,</span> <span class="n">field_data</span> <span class="ow">in</span> <span class="n">run_fields</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="c1"># just add it to the list of fields that will be concatenated later</span>
                    <span class="n">fields</span><span class="p">[</span><span class="n">field_name</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">field_data</span><span class="p">)</span>

            <span class="c1"># get the cycle idxs for this run</span>
            <span class="n">rec_grp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">records_grp</span><span class="p">(</span><span class="n">run_idx</span><span class="p">,</span> <span class="n">run_record_key</span><span class="p">)</span>
            <span class="n">run_cycle_idxs</span> <span class="o">=</span> <span class="n">rec_grp</span><span class="p">[</span><span class="n">CYCLE_IDXS</span><span class="p">][:]</span>

            <span class="c1"># add the total number of cycles that came before this run</span>
            <span class="c1"># to each of the cycle idxs to get the cycle_idxs in terms</span>
            <span class="c1"># of the full contig</span>
            <span class="n">run_contig_cycle_idxs</span> <span class="o">=</span> <span class="n">run_cycle_idxs</span> <span class="o">+</span> <span class="n">prev_run_cycle_total</span>

            <span class="c1"># add these cycle indices to the records for the whole contig</span>
            <span class="n">cycle_idxs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">(</span> <span class="p">(</span><span class="n">cycle_idxs</span><span class="p">,</span> <span class="n">run_contig_cycle_idxs</span><span class="p">)</span> <span class="p">)</span>

            <span class="c1"># add the total number of cycle_idxs from this run to the</span>
            <span class="c1"># running total</span>
            <span class="n">prev_run_cycle_total</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_n_cycles</span><span class="p">(</span><span class="n">run_idx</span><span class="p">)</span>

        <span class="c1"># then make the records from the fields</span>
        <span class="n">records</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_records</span><span class="p">(</span><span class="n">run_record_key</span><span class="p">,</span> <span class="n">cycle_idxs</span><span class="p">,</span> <span class="n">fields</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">records</span>

    <span class="k">def</span> <span class="nf">_run_records_continual</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run_idxs</span><span class="p">,</span> <span class="n">run_record_key</span><span class="p">):</span>

        <span class="n">cycle_idxs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">prev_run_cycle_total</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">run_idx</span> <span class="ow">in</span> <span class="n">run_idxs</span><span class="p">:</span>
            <span class="c1"># get all the value columns from the datasets, and convert</span>
            <span class="c1"># them to something amenable to a table</span>
            <span class="n">run_fields</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_convert_record_fields_to_table_columns</span><span class="p">(</span><span class="n">run_idx</span><span class="p">,</span> <span class="n">run_record_key</span><span class="p">)</span>

            <span class="c1"># we need to concatenate each field to the end of the</span>
            <span class="c1"># field in the master dictionary, first we need to</span>
            <span class="c1"># initialize it if it isn&#39;t already made</span>
            <span class="k">if</span> <span class="n">fields</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># if it isn&#39;t initialized we just set it as this first</span>
                <span class="c1"># run fields dictionary</span>
                <span class="n">fields</span> <span class="o">=</span> <span class="n">run_fields</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># if it is already initialized we need to go through</span>
                <span class="c1"># each field and concatenate</span>
                <span class="k">for</span> <span class="n">field_name</span><span class="p">,</span> <span class="n">field_data</span> <span class="ow">in</span> <span class="n">run_fields</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="c1"># just add it to the list of fields that will be concatenated later</span>
                    <span class="n">fields</span><span class="p">[</span><span class="n">field_name</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">field_data</span><span class="p">)</span>

            <span class="c1"># get one of the fields (if any to iterate over)</span>
            <span class="n">record_fields</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">record_fields</span><span class="p">[</span><span class="n">run_record_key</span><span class="p">]</span>
            <span class="n">main_record_field</span> <span class="o">=</span> <span class="n">record_fields</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="c1"># make the cycle idxs from that</span>
            <span class="n">run_rec_grp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">records_grp</span><span class="p">(</span><span class="n">run_idx</span><span class="p">,</span> <span class="n">run_record_key</span><span class="p">)</span>
            <span class="n">run_cycle_idxs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">run_rec_grp</span><span class="p">[</span><span class="n">main_record_field</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>

            <span class="c1"># add the total number of cycles that came before this run</span>
            <span class="c1"># to each of the cycle idxs to get the cycle_idxs in terms</span>
            <span class="c1"># of the full contig</span>
            <span class="n">run_contig_cycle_indices</span> <span class="o">=</span> <span class="n">run_cycle_idxs</span> <span class="o">+</span> <span class="n">prev_run_cycle_total</span>

            <span class="c1"># add these cycle indices to the records for the whole contig</span>
            <span class="n">cycle_idxs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">(</span> <span class="p">(</span><span class="n">cycle_idxs</span><span class="p">,</span> <span class="n">run_contig_cycle_idxs</span><span class="p">)</span> <span class="p">)</span>

            <span class="c1"># add the total number of cycle_idxs from this run to the</span>
            <span class="c1"># running total</span>
            <span class="n">prev_run_cycle_total</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_n_cycles</span><span class="p">(</span><span class="n">run_idx</span><span class="p">)</span>


        <span class="c1"># then make the records from the fields</span>
        <span class="n">records</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_records</span><span class="p">(</span><span class="n">run_record_key</span><span class="p">,</span> <span class="n">cycle_idxs</span><span class="p">,</span> <span class="n">fields</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">records</span>

<div class="viewcode-block" id="WepyHDF5.run_records_dataframe"><a class="viewcode-back" href="../../api/wepy.html#wepy.hdf5.WepyHDF5.run_records_dataframe">[docs]</a>    <span class="k">def</span> <span class="nf">run_records_dataframe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run_idx</span><span class="p">,</span> <span class="n">run_record_key</span><span class="p">):</span>
        <span class="n">records</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_records</span><span class="p">(</span><span class="n">run_idx</span><span class="p">,</span> <span class="n">run_record_key</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">records</span><span class="p">)</span></div>

<div class="viewcode-block" id="WepyHDF5.contig_records_dataframe"><a class="viewcode-back" href="../../api/wepy.html#wepy.hdf5.WepyHDF5.contig_records_dataframe">[docs]</a>    <span class="k">def</span> <span class="nf">contig_records_dataframe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run_idxs</span><span class="p">,</span> <span class="n">run_record_key</span><span class="p">):</span>
        <span class="n">records</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">contig_records</span><span class="p">(</span><span class="n">run_idxs</span><span class="p">,</span> <span class="n">run_record_key</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">records</span><span class="p">)</span></div>

    <span class="c1"># application level specific methods for each main group</span>

    <span class="c1"># resampling</span>
<div class="viewcode-block" id="WepyHDF5.resampling_records"><a class="viewcode-back" href="../../api/wepy.html#wepy.hdf5.WepyHDF5.resampling_records">[docs]</a>    <span class="k">def</span> <span class="nf">resampling_records</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run_idxs</span><span class="p">):</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">contig_records</span><span class="p">(</span><span class="n">run_idxs</span><span class="p">,</span> <span class="n">RESAMPLING</span><span class="p">)</span></div>

<div class="viewcode-block" id="WepyHDF5.resampling_records_dataframe"><a class="viewcode-back" href="../../api/wepy.html#wepy.hdf5.WepyHDF5.resampling_records_dataframe">[docs]</a>    <span class="k">def</span> <span class="nf">resampling_records_dataframe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run_idxs</span><span class="p">):</span>

        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">resampling_records</span><span class="p">(</span><span class="n">run_idxs</span><span class="p">))</span></div>

    <span class="c1"># resampler records</span>
<div class="viewcode-block" id="WepyHDF5.resampler_records"><a class="viewcode-back" href="../../api/wepy.html#wepy.hdf5.WepyHDF5.resampler_records">[docs]</a>    <span class="k">def</span> <span class="nf">resampler_records</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run_idxs</span><span class="p">):</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">contig_records</span><span class="p">(</span><span class="n">run_idxs</span><span class="p">,</span> <span class="n">RESAMPLER</span><span class="p">)</span></div>

<div class="viewcode-block" id="WepyHDF5.resampler_records_dataframe"><a class="viewcode-back" href="../../api/wepy.html#wepy.hdf5.WepyHDF5.resampler_records_dataframe">[docs]</a>    <span class="k">def</span> <span class="nf">resampler_records_dataframe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run_idxs</span><span class="p">):</span>

        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">resampler_records</span><span class="p">(</span><span class="n">run_idxs</span><span class="p">))</span></div>

    <span class="c1"># warping</span>
<div class="viewcode-block" id="WepyHDF5.warping_records"><a class="viewcode-back" href="../../api/wepy.html#wepy.hdf5.WepyHDF5.warping_records">[docs]</a>    <span class="k">def</span> <span class="nf">warping_records</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run_idxs</span><span class="p">):</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">contig_records</span><span class="p">(</span><span class="n">run_idxs</span><span class="p">,</span> <span class="n">WARPING</span><span class="p">)</span></div>

<div class="viewcode-block" id="WepyHDF5.warping_records_dataframe"><a class="viewcode-back" href="../../api/wepy.html#wepy.hdf5.WepyHDF5.warping_records_dataframe">[docs]</a>    <span class="k">def</span> <span class="nf">warping_records_dataframe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run_idxs</span><span class="p">):</span>

        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">warping_records</span><span class="p">(</span><span class="n">run_idxs</span><span class="p">))</span></div>

    <span class="c1"># boundary conditions</span>
<div class="viewcode-block" id="WepyHDF5.bc_records"><a class="viewcode-back" href="../../api/wepy.html#wepy.hdf5.WepyHDF5.bc_records">[docs]</a>    <span class="k">def</span> <span class="nf">bc_records</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run_idxs</span><span class="p">):</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">contig_records</span><span class="p">(</span><span class="n">run_idxs</span><span class="p">,</span> <span class="n">BC</span><span class="p">)</span></div>

<div class="viewcode-block" id="WepyHDF5.bc_records_dataframe"><a class="viewcode-back" href="../../api/wepy.html#wepy.hdf5.WepyHDF5.bc_records_dataframe">[docs]</a>    <span class="k">def</span> <span class="nf">bc_records_dataframe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run_idxs</span><span class="p">):</span>

        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bc_records</span><span class="p">(</span><span class="n">run_idxs</span><span class="p">))</span></div>

    <span class="c1"># progress</span>
<div class="viewcode-block" id="WepyHDF5.progress_records"><a class="viewcode-back" href="../../api/wepy.html#wepy.hdf5.WepyHDF5.progress_records">[docs]</a>    <span class="k">def</span> <span class="nf">progress_records</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run_idxs</span><span class="p">):</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">contig_records</span><span class="p">(</span><span class="n">run_idxs</span><span class="p">,</span> <span class="n">PROGRESS</span><span class="p">)</span></div>

<div class="viewcode-block" id="WepyHDF5.progress_records_dataframe"><a class="viewcode-back" href="../../api/wepy.html#wepy.hdf5.WepyHDF5.progress_records_dataframe">[docs]</a>    <span class="k">def</span> <span class="nf">progress_records_dataframe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run_idxs</span><span class="p">):</span>

        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">progress_records</span><span class="p">(</span><span class="n">run_idxs</span><span class="p">))</span></div>

<div class="viewcode-block" id="WepyHDF5.is_contig"><a class="viewcode-back" href="../../api/wepy.html#wepy.hdf5.WepyHDF5.is_contig">[docs]</a>    <span class="k">def</span> <span class="nf">is_contig</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run_idxs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This method checks that if a given list of run indices is a valid</span>
<span class="sd">        contig or not.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">run_idx_continuations</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">run_idxs</span><span class="p">[</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="n">run_idxs</span><span class="p">[</span><span class="n">idx</span><span class="p">]])</span>
                            <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">run_idxs</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)]</span>
        <span class="c1">#gets the contigs array</span>
        <span class="n">continuations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings_grp</span><span class="p">[</span><span class="s1">&#39;continuations&#39;</span><span class="p">][:]</span>

        <span class="c1"># checks if sub contigs are in contigs list or not.</span>
        <span class="k">for</span> <span class="n">run_continuous</span> <span class="ow">in</span> <span class="n">run_idx_continuations</span><span class="p">:</span>
            <span class="n">contig</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">for</span> <span class="n">continuous</span> <span class="ow">in</span> <span class="n">continuations</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="n">run_continuous</span><span class="p">,</span> <span class="n">continuous</span><span class="p">):</span>
                    <span class="n">contig</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">contig</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>

        <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="WepyHDF5.run_resampling_panel"><a class="viewcode-back" href="../../api/wepy.html#wepy.hdf5.WepyHDF5.run_resampling_panel">[docs]</a>    <span class="k">def</span> <span class="nf">run_resampling_panel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run_idx</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">contig_resampling_panel</span><span class="p">([</span><span class="n">run_idx</span><span class="p">])</span></div>

<div class="viewcode-block" id="WepyHDF5.contig_resampling_panel"><a class="viewcode-back" href="../../api/wepy.html#wepy.hdf5.WepyHDF5.contig_resampling_panel">[docs]</a>    <span class="k">def</span> <span class="nf">contig_resampling_panel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run_idxs</span><span class="p">):</span>
        <span class="c1"># check the contig to make sure it is a valid contig</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_contig</span><span class="p">(</span><span class="n">run_idxs</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The run_idxs provided are not a valid contig, </span><span class="si">{}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">run_idxs</span><span class="p">))</span>

        <span class="c1"># make the resampling panel from the resampling records for the contig</span>
        <span class="n">contig_resampling_panel</span> <span class="o">=</span> <span class="n">resampling_panel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">resampling_records</span><span class="p">(</span><span class="n">run_idxs</span><span class="p">),</span>
                                                   <span class="n">is_sorted</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">contig_resampling_panel</span></div>

<div class="viewcode-block" id="WepyHDF5.join"><a class="viewcode-back" href="../../api/wepy.html#wepy.hdf5.WepyHDF5.join">[docs]</a>    <span class="k">def</span> <span class="nf">join</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other_h5</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Given another WepyHDF5 file object does a left join on this</span>
<span class="sd">        file. Renumbering the runs starting from this file.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">with</span> <span class="n">other_h5</span> <span class="k">as</span> <span class="n">h5</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">run_idx</span> <span class="ow">in</span> <span class="n">h5</span><span class="o">.</span><span class="n">run_idxs</span><span class="p">:</span>
                <span class="c1"># the other run group handle</span>
                <span class="n">other_run</span> <span class="o">=</span> <span class="n">h5</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">run_idx</span><span class="p">)</span>
                <span class="c1"># copy this run to this file in the next run_idx group</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">h5</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">other_run</span><span class="p">,</span> <span class="s1">&#39;runs/</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">next_run_idx</span><span class="p">()))</span></div>

<div class="viewcode-block" id="WepyHDF5.to_mdtraj"><a class="viewcode-back" href="../../api/wepy.html#wepy.hdf5.WepyHDF5.to_mdtraj">[docs]</a>    <span class="k">def</span> <span class="nf">to_mdtraj</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run_idx</span><span class="p">,</span> <span class="n">traj_idx</span><span class="p">,</span> <span class="n">frames</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">alt_rep</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="n">traj_grp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">traj</span><span class="p">(</span><span class="n">run_idx</span><span class="p">,</span> <span class="n">traj_idx</span><span class="p">)</span>

        <span class="c1"># the default for alt_rep is the main rep</span>
        <span class="k">if</span> <span class="n">alt_rep</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">rep_key</span> <span class="o">=</span> <span class="n">POSITIONS</span>
            <span class="n">rep_path</span> <span class="o">=</span> <span class="n">rep_key</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">rep_key</span> <span class="o">=</span> <span class="n">alt_rep</span>
            <span class="n">rep_path</span> <span class="o">=</span> <span class="s1">&#39;alt_reps/</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">alt_rep</span><span class="p">)</span>

        <span class="n">topology</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_mdtraj_topology</span><span class="p">(</span><span class="n">alt_rep</span><span class="o">=</span><span class="n">rep_key</span><span class="p">)</span>

        <span class="n">frames</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_traj_field_cycle_idxs</span><span class="p">(</span><span class="n">run_idx</span><span class="p">,</span> <span class="n">traj_idx</span><span class="p">,</span> <span class="n">rep_path</span><span class="p">)</span>

        <span class="c1"># get the data for all or for the frames specified</span>
        <span class="n">positions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_traj_field</span><span class="p">(</span><span class="n">run_idx</span><span class="p">,</span> <span class="n">traj_idx</span><span class="p">,</span> <span class="n">rep_path</span><span class="p">,</span>
                                        <span class="n">frames</span><span class="o">=</span><span class="n">frames</span><span class="p">,</span> <span class="n">masked</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_traj_field</span><span class="p">(</span><span class="n">run_idx</span><span class="p">,</span> <span class="n">traj_idx</span><span class="p">,</span> <span class="n">TIME</span><span class="p">,</span>
                                       <span class="n">frames</span><span class="o">=</span><span class="n">frames</span><span class="p">,</span> <span class="n">masked</span><span class="o">=</span><span class="kc">False</span><span class="p">)[:,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="n">warn</span><span class="p">(</span><span class="s2">&quot;time not in this trajectory, ignoring&quot;</span><span class="p">)</span>
            <span class="n">time</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">box_vectors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_traj_field</span><span class="p">(</span><span class="n">run_idx</span><span class="p">,</span> <span class="n">traj_idx</span><span class="p">,</span> <span class="n">BOX_VECTORS</span><span class="p">,</span>
                                              <span class="n">frames</span><span class="o">=</span><span class="n">frames</span><span class="p">,</span> <span class="n">masked</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="n">warn</span><span class="p">(</span><span class="s2">&quot;box_vectors not in this trajectory, ignoring&quot;</span><span class="p">)</span>
            <span class="n">box_vectors</span> <span class="o">=</span> <span class="kc">None</span>


        <span class="k">if</span> <span class="n">box_vectors</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">unitcell_lengths</span><span class="p">,</span> <span class="n">unitcell_angles</span> <span class="o">=</span> <span class="n">traj_box_vectors_to_lengths_angles</span><span class="p">(</span><span class="n">box_vectors</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">box_vectors</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">time</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">traj</span> <span class="o">=</span> <span class="n">mdj</span><span class="o">.</span><span class="n">Trajectory</span><span class="p">(</span><span class="n">positions</span><span class="p">,</span> <span class="n">topology</span><span class="p">,</span>
                           <span class="n">time</span><span class="o">=</span><span class="n">time</span><span class="p">,</span>
                           <span class="n">unitcell_lengths</span><span class="o">=</span><span class="n">unitcell_lengths</span><span class="p">,</span> <span class="n">unitcell_angles</span><span class="o">=</span><span class="n">unitcell_angles</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">box_vectors</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">traj</span> <span class="o">=</span> <span class="n">mdj</span><span class="o">.</span><span class="n">Trajectory</span><span class="p">(</span><span class="n">positions</span><span class="p">,</span> <span class="n">topology</span><span class="p">,</span>
                           <span class="n">unitcell_lengths</span><span class="o">=</span><span class="n">unitcell_lengths</span><span class="p">,</span> <span class="n">unitcell_angles</span><span class="o">=</span><span class="n">unitcell_angles</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">time</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">traj</span> <span class="o">=</span> <span class="n">mdj</span><span class="o">.</span><span class="n">Trajectory</span><span class="p">(</span><span class="n">positions</span><span class="p">,</span> <span class="n">topology</span><span class="p">,</span>
                           <span class="n">time</span><span class="o">=</span><span class="n">time</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">traj</span> <span class="o">=</span> <span class="n">mdj</span><span class="o">.</span><span class="n">Trajectory</span><span class="p">(</span><span class="n">positions</span><span class="p">,</span> <span class="n">topology</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">traj</span></div>

<div class="viewcode-block" id="WepyHDF5.trace_to_mdtraj"><a class="viewcode-back" href="../../api/wepy.html#wepy.hdf5.WepyHDF5.trace_to_mdtraj">[docs]</a>    <span class="k">def</span> <span class="nf">trace_to_mdtraj</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trace</span><span class="p">,</span> <span class="n">alt_rep</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="c1"># the default for alt_rep is the main rep</span>
        <span class="k">if</span> <span class="n">alt_rep</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">rep_key</span> <span class="o">=</span> <span class="n">POSITIONS</span>
            <span class="n">rep_path</span> <span class="o">=</span> <span class="n">rep_key</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">rep_key</span> <span class="o">=</span> <span class="n">alt_rep</span>
            <span class="n">rep_path</span> <span class="o">=</span> <span class="s1">&#39;alt_reps/</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">alt_rep</span><span class="p">)</span>

        <span class="n">topology</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_mdtraj_topology</span><span class="p">(</span><span class="n">alt_rep</span><span class="o">=</span><span class="n">rep_key</span><span class="p">)</span>

        <span class="n">trace_fields</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_trace_fields</span><span class="p">(</span><span class="n">trace</span><span class="p">,</span> <span class="p">[</span><span class="n">rep_path</span><span class="p">,</span> <span class="n">BOX_VECTORS</span><span class="p">])</span>

        <span class="n">unitcell_lengths</span><span class="p">,</span> <span class="n">unitcell_angles</span> <span class="o">=</span> <span class="n">traj_box_vectors_to_lengths_angles</span><span class="p">(</span>
                                               <span class="n">trace_fields</span><span class="p">[</span><span class="n">BOX_VECTORS</span><span class="p">])</span>

        <span class="n">cycles</span> <span class="o">=</span> <span class="p">[</span><span class="n">cycle</span> <span class="k">for</span> <span class="n">run</span><span class="p">,</span> <span class="n">cycle</span><span class="p">,</span> <span class="n">walker</span> <span class="ow">in</span> <span class="n">trace</span><span class="p">]</span>
        <span class="n">traj</span> <span class="o">=</span> <span class="n">mdj</span><span class="o">.</span><span class="n">Trajectory</span><span class="p">(</span><span class="n">trace_fields</span><span class="p">[</span><span class="n">rep_key</span><span class="p">],</span> <span class="n">topology</span><span class="p">,</span>
                       <span class="n">time</span><span class="o">=</span><span class="n">cycles</span><span class="p">,</span>
                       <span class="n">unitcell_lengths</span><span class="o">=</span><span class="n">unitcell_lengths</span><span class="p">,</span> <span class="n">unitcell_angles</span><span class="o">=</span><span class="n">unitcell_angles</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">traj</span></div>

<div class="viewcode-block" id="WepyHDF5.run_trace_to_mdtraj"><a class="viewcode-back" href="../../api/wepy.html#wepy.hdf5.WepyHDF5.run_trace_to_mdtraj">[docs]</a>    <span class="k">def</span> <span class="nf">run_trace_to_mdtraj</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run_idx</span><span class="p">,</span> <span class="n">trace</span><span class="p">,</span> <span class="n">alt_rep</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="c1"># the default for alt_rep is the main rep</span>
        <span class="k">if</span> <span class="n">alt_rep</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">rep_key</span> <span class="o">=</span> <span class="n">POSITIONS</span>
            <span class="n">rep_path</span> <span class="o">=</span> <span class="n">rep_key</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">rep_key</span> <span class="o">=</span> <span class="n">alt_rep</span>
            <span class="n">rep_path</span> <span class="o">=</span> <span class="s1">&#39;alt_reps/</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">alt_rep</span><span class="p">)</span>

        <span class="n">topology</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_mdtraj_topology</span><span class="p">(</span><span class="n">alt_rep</span><span class="o">=</span><span class="n">rep_key</span><span class="p">)</span>

        <span class="n">trace_fields</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_run_trace_fields</span><span class="p">(</span><span class="n">run_idx</span><span class="p">,</span> <span class="n">trace</span><span class="p">,</span> <span class="p">[</span><span class="n">rep_path</span><span class="p">,</span> <span class="n">BOX_VECTORS</span><span class="p">])</span>

        <span class="n">unitcell_lengths</span><span class="p">,</span> <span class="n">unitcell_angles</span> <span class="o">=</span> <span class="n">traj_box_vectors_to_lengths_angles</span><span class="p">(</span>
                                               <span class="n">trace_fields</span><span class="p">[</span><span class="n">BOX_VECTORS</span><span class="p">])</span>

        <span class="n">cycles</span> <span class="o">=</span> <span class="p">[</span><span class="n">cycle</span> <span class="k">for</span> <span class="n">cycle</span><span class="p">,</span> <span class="n">walker</span> <span class="ow">in</span> <span class="n">trace</span><span class="p">]</span>
        <span class="n">traj</span> <span class="o">=</span> <span class="n">mdj</span><span class="o">.</span><span class="n">Trajectory</span><span class="p">(</span><span class="n">trace_fields</span><span class="p">[</span><span class="n">rep_key</span><span class="p">],</span> <span class="n">topology</span><span class="p">,</span>
                       <span class="n">time</span><span class="o">=</span><span class="n">cycles</span><span class="p">,</span>
                       <span class="n">unitcell_lengths</span><span class="o">=</span><span class="n">unitcell_lengths</span><span class="p">,</span> <span class="n">unitcell_angles</span><span class="o">=</span><span class="n">unitcell_angles</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">traj</span></div></div>



<span class="k">def</span> <span class="nf">_check_data_compliance</span><span class="p">(</span><span class="n">traj_data</span><span class="p">,</span> <span class="n">compliance_requirements</span><span class="o">=</span><span class="n">COMPLIANCE_REQUIREMENTS</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Given a dictionary of trajectory data it returns the</span>
<span class="sd">       COMPLIANCE_TAGS that the data satisfies. &quot;&quot;&quot;</span>

    <span class="c1"># cast the nested tuples to a dictionary if necessary</span>
    <span class="n">compliance_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">compliance_requirements</span><span class="p">)</span>

    <span class="n">fields</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">field</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">traj_data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>

        <span class="c1"># don&#39;t check observables</span>
        <span class="k">if</span> <span class="n">field</span> <span class="ow">in</span> <span class="p">[</span><span class="n">OBSERVABLES</span><span class="p">]:</span>
            <span class="k">continue</span>

        <span class="c1"># check to make sure the value actually has something in it</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">fields</span><span class="o">.</span><span class="n">update</span><span class="p">([</span><span class="n">field</span><span class="p">])</span>

    <span class="n">compliances</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">compliance_tag</span><span class="p">,</span> <span class="n">compliance_fields</span> <span class="ow">in</span> <span class="n">compliance_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">compliance_fields</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">compliance_fields</span><span class="p">)</span>
        <span class="c1"># if the fields are a superset of the compliance fields for</span>
        <span class="c1"># this compliance type then it satisfies it</span>
        <span class="k">if</span> <span class="n">fields</span><span class="o">.</span><span class="n">issuperset</span><span class="p">(</span><span class="n">compliance_fields</span><span class="p">):</span>
            <span class="n">compliances</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">compliance_tag</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">compliances</span>

<div class="viewcode-block" id="iter_field_paths"><a class="viewcode-back" href="../../api/wepy.html#wepy.hdf5.iter_field_paths">[docs]</a><span class="k">def</span> <span class="nf">iter_field_paths</span><span class="p">(</span><span class="n">grp</span><span class="p">):</span>
    <span class="n">field_paths</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">field_name</span> <span class="ow">in</span> <span class="n">grp</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">grp</span><span class="p">[</span><span class="n">field_name</span><span class="p">],</span> <span class="n">h5py</span><span class="o">.</span><span class="n">Group</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">subfield</span> <span class="ow">in</span> <span class="n">grp</span><span class="p">[</span><span class="n">field_name</span><span class="p">]:</span>
                <span class="n">field_paths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">field_name</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">subfield</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">field_paths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">field_name</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">field_paths</span></div>

<div class="viewcode-block" id="RunCycleSlice"><a class="viewcode-back" href="../../api/wepy.html#wepy.hdf5.RunCycleSlice">[docs]</a><span class="k">class</span> <span class="nc">RunCycleSlice</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run_idx</span><span class="p">,</span> <span class="n">cycles</span><span class="p">,</span> <span class="n">wepy_hdf5_file</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_h5</span> <span class="o">=</span> <span class="n">wepy_hdf5_file</span><span class="o">.</span><span class="n">_h5</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">run_idx</span> <span class="o">=</span> <span class="n">run_idx</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cycles</span> <span class="o">=</span> <span class="n">cycles</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">wepy_hdf5_file</span><span class="o">.</span><span class="n">mode</span>

<div class="viewcode-block" id="RunCycleSlice.traj"><a class="viewcode-back" href="../../api/wepy.html#wepy.hdf5.RunCycleSlice.traj">[docs]</a>    <span class="k">def</span> <span class="nf">traj</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run_idx</span><span class="p">,</span> <span class="n">traj_idx</span><span class="p">):</span>
                 <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_h5</span><span class="p">[</span><span class="s1">&#39;runs/</span><span class="si">{}</span><span class="s1">/trajectories/</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">run_idx</span><span class="p">,</span> <span class="n">traj_idx</span><span class="p">)]</span></div>
<div class="viewcode-block" id="RunCycleSlice.run_trajs"><a class="viewcode-back" href="../../api/wepy.html#wepy.hdf5.RunCycleSlice.run_trajs">[docs]</a>    <span class="k">def</span> <span class="nf">run_trajs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run_idx</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_h5</span><span class="p">[</span><span class="s1">&#39;runs/</span><span class="si">{}</span><span class="s1">/trajectories&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">run_idx</span><span class="p">)]</span></div>

<div class="viewcode-block" id="RunCycleSlice.n_run_trajs"><a class="viewcode-back" href="../../api/wepy.html#wepy.hdf5.RunCycleSlice.n_run_trajs">[docs]</a>    <span class="k">def</span> <span class="nf">n_run_trajs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run_idx</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_h5</span><span class="p">[</span><span class="s1">&#39;runs/</span><span class="si">{}</span><span class="s1">/trajectories&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">run_idx</span><span class="p">)])</span></div>

<div class="viewcode-block" id="RunCycleSlice.run_traj_idxs"><a class="viewcode-back" href="../../api/wepy.html#wepy.hdf5.RunCycleSlice.run_traj_idxs">[docs]</a>    <span class="k">def</span> <span class="nf">run_traj_idxs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run_idx</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_h5</span><span class="p">[</span><span class="s1">&#39;runs/</span><span class="si">{}</span><span class="s1">/trajectories&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">run_idx</span><span class="p">)]))</span></div>

<div class="viewcode-block" id="RunCycleSlice.run_traj_idx_tuples"><a class="viewcode-back" href="../../api/wepy.html#wepy.hdf5.RunCycleSlice.run_traj_idx_tuples">[docs]</a>    <span class="k">def</span> <span class="nf">run_traj_idx_tuples</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">tups</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">traj_idx</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_traj_idxs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">run_idx</span><span class="p">):</span>
            <span class="n">tups</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">run_idx</span><span class="p">,</span> <span class="n">traj_idx</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">tups</span></div>
<div class="viewcode-block" id="RunCycleSlice.run_cycle_idx_tuples"><a class="viewcode-back" href="../../api/wepy.html#wepy.hdf5.RunCycleSlice.run_cycle_idx_tuples">[docs]</a>    <span class="k">def</span> <span class="nf">run_cycle_idx_tuples</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">tups</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">cycle_idx</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cycles</span><span class="p">:</span>
             <span class="n">tups</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">run_idx</span><span class="p">,</span> <span class="n">cycle_idx</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">tups</span></div>


<div class="viewcode-block" id="RunCycleSlice.iter_trajs"><a class="viewcode-back" href="../../api/wepy.html#wepy.hdf5.RunCycleSlice.iter_trajs">[docs]</a>    <span class="k">def</span> <span class="nf">iter_trajs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idxs</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">traj_sel</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Generator for all of the trajectories in the dataset across all</span>
<span class="sd">        runs. If idxs=True will return a tuple of (run_idx, traj_idx).</span>

<span class="sd">        run_sel : if True will iterate over a subset of</span>
<span class="sd">        trajectories. Possible values are an iterable of `(run_idx,</span>
<span class="sd">        traj_idx)` tuples.</span>

<span class="sd">        &quot;&quot;&quot;</span>


        <span class="c1"># set the selection of trajectories to iterate over</span>
        <span class="k">if</span> <span class="n">traj_sel</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">idx_tups</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_traj_idx_tuples</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">idx_tups</span> <span class="o">=</span> <span class="n">traj_sel</span>

        <span class="c1"># get each traj for each idx_tup and yield them for the generator</span>
        <span class="k">for</span> <span class="n">run_idx</span><span class="p">,</span> <span class="n">traj_idx</span> <span class="ow">in</span> <span class="n">idx_tups</span><span class="p">:</span>
            <span class="n">traj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">traj</span><span class="p">(</span><span class="n">run_idx</span><span class="p">,</span> <span class="n">traj_idx</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">idxs</span><span class="p">:</span>
                <span class="k">yield</span> <span class="p">(</span><span class="n">run_idx</span><span class="p">,</span> <span class="n">traj_idx</span><span class="p">),</span> <span class="n">traj</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">traj</span></div>

<div class="viewcode-block" id="RunCycleSlice.iter_cycle_fields"><a class="viewcode-back" href="../../api/wepy.html#wepy.hdf5.RunCycleSlice.iter_cycle_fields">[docs]</a>    <span class="k">def</span> <span class="nf">iter_cycle_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">cycle_idx</span><span class="p">,</span> <span class="n">idxs</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">traj_sel</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Generator for all of the specified non-compound fields</span>
<span class="sd">        h5py.Datasets for all trajectories in the dataset across all</span>
<span class="sd">        runs. Fields is a list of valid relative paths to datasets in</span>
<span class="sd">        the trajectory groups.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">:</span>
            <span class="n">dsets</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">fields_data</span> <span class="o">=</span> <span class="p">()</span>
            <span class="k">for</span> <span class="n">idx_tup</span><span class="p">,</span> <span class="n">traj</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">iter_trajs</span><span class="p">(</span><span class="n">idxs</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">traj_sel</span><span class="o">=</span><span class="n">traj_sel</span><span class="p">):</span>
                <span class="n">run_idx</span><span class="p">,</span> <span class="n">traj_idx</span> <span class="o">=</span> <span class="n">idx_tup</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">dset</span> <span class="o">=</span> <span class="n">traj</span><span class="p">[</span><span class="n">field</span><span class="p">][</span><span class="n">cycle_idx</span><span class="p">]</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dset</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
                        <span class="n">dset</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">dset</span><span class="p">])</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dset</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                        <span class="n">fields_data</span> <span class="o">+=</span> <span class="p">(</span><span class="n">dset</span><span class="p">,)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">fields_data</span> <span class="o">+=</span> <span class="p">([</span><span class="n">dset</span><span class="p">],)</span>
                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                    <span class="n">warn</span><span class="p">(</span><span class="s2">&quot;field </span><span class="se">\&quot;</span><span class="si">{}</span><span class="se">\&quot;</span><span class="s2"> not found in </span><span class="se">\&quot;</span><span class="si">{}</span><span class="se">\&quot;</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">traj</span><span class="o">.</span><span class="n">name</span><span class="p">),</span> <span class="ne">RuntimeWarning</span><span class="p">)</span>
                    <span class="n">dset</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="n">dsets</span> <span class="o">=</span>  <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">fields_data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">idxs</span><span class="p">:</span>
                <span class="k">yield</span> <span class="p">(</span><span class="n">run_idx</span><span class="p">,</span> <span class="n">traj_idx</span><span class="p">,</span> <span class="n">field</span><span class="p">),</span> <span class="n">dsets</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">field</span><span class="p">,</span> <span class="n">dsets</span></div>


<div class="viewcode-block" id="RunCycleSlice.iter_cycles_fields"><a class="viewcode-back" href="../../api/wepy.html#wepy.hdf5.RunCycleSlice.iter_cycles_fields">[docs]</a>    <span class="k">def</span> <span class="nf">iter_cycles_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">idxs</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">traj_sel</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="k">for</span> <span class="n">cycle_idx</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cycles</span><span class="p">:</span>
            <span class="n">dsets</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">field</span><span class="p">,</span> <span class="n">dset</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">iter_cycle_fields</span><span class="p">(</span><span class="n">fields</span><span class="p">,</span> <span class="n">cycle_idx</span><span class="p">,</span> <span class="n">traj_sel</span><span class="o">=</span><span class="n">traj_sel</span><span class="p">):</span>
                <span class="n">dsets</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="n">dset</span>
            <span class="k">if</span> <span class="n">idxs</span><span class="p">:</span>
                <span class="k">yield</span> <span class="p">(</span><span class="n">cycle_idx</span><span class="p">,</span>  <span class="n">dsets</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">dsets</span></div>


<div class="viewcode-block" id="RunCycleSlice.traj_cycles_map"><a class="viewcode-back" href="../../api/wepy.html#wepy.hdf5.RunCycleSlice.traj_cycles_map">[docs]</a>    <span class="k">def</span> <span class="nf">traj_cycles_map</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">map_func</span><span class="o">=</span><span class="nb">map</span><span class="p">,</span> <span class="n">idxs</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">traj_sel</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Function for mapping work onto field of trajectories in the</span>
<span class="sd">        WepyHDF5 file object. Similar to traj_map, except `h5py.Group`</span>
<span class="sd">        objects cannot be pickled for message passing. So we select</span>
<span class="sd">        the fields to serialize instead and pass the `numpy.ndarray`s</span>
<span class="sd">        to have the work mapped to them.</span>

<span class="sd">        func : the function that will be mapped to trajectory groups</span>

<span class="sd">        fields : list of fields that will be serialized into a dictionary</span>
<span class="sd">                 and passed to the map function. These must be valid</span>
<span class="sd">                 `h5py` path strings relative to the trajectory</span>
<span class="sd">                 group. These include the standard fields like</span>
<span class="sd">                 &#39;positions&#39; and &#39;weights&#39;, as well as compound paths</span>
<span class="sd">                 e.g. &#39;observables/sasa&#39;.</span>

<span class="sd">        map_func : the function that maps the function. This is where</span>
<span class="sd">                        parallelization occurs if desired.  Defaults to</span>
<span class="sd">                        the serial python map function.</span>

<span class="sd">        traj_sel : a trajectory selection. This is a valid `traj_sel`</span>
<span class="sd">        argument for the `iter_trajs` function.</span>

<span class="sd">        *args : additional arguments to the function. If this is an</span>
<span class="sd">                 iterable it will be assumed that it is the appropriate</span>
<span class="sd">                 length for the number of trajectories, WARNING: this will</span>
<span class="sd">                 not be checked and could result in a run time</span>
<span class="sd">                 error. Otherwise single values will be automatically</span>
<span class="sd">                 mapped to all trajectories.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># check the args and kwargs to see if they need expanded for</span>
        <span class="c1"># mapping inputs</span>
        <span class="n">mapped_args</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
            <span class="c1"># if it is a sequence or generator we keep just pass it to the mapper</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cycles</span><span class="p">),</span> <span class="s2">&quot;Sequence has fewer&quot;</span>
                <span class="n">mapped_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
            <span class="c1"># if it is not a sequence or generator we make a generator out</span>
            <span class="c1"># of it to map as inputs</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">mapped_arg</span> <span class="o">=</span> <span class="p">(</span><span class="n">arg</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cycles</span><span class="p">)))</span>
                <span class="n">mapped_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mapped_arg</span><span class="p">)</span>



        <span class="n">results</span> <span class="o">=</span> <span class="n">map_func</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">iter_cycles_fields</span><span class="p">(</span><span class="n">fields</span><span class="p">,</span> <span class="n">traj_sel</span><span class="o">=</span><span class="n">traj_sel</span><span class="p">,</span> <span class="n">idxs</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
                           <span class="o">*</span><span class="n">mapped_args</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">idxs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">traj_sel</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">traj_sel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_cycle_idx_tuples</span><span class="p">()</span>
            <span class="k">return</span> <span class="nb">zip</span><span class="p">(</span><span class="n">traj_sel</span><span class="p">,</span> <span class="n">results</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">results</span></div>


<div class="viewcode-block" id="RunCycleSlice.compute_observable"><a class="viewcode-back" href="../../api/wepy.html#wepy.hdf5.RunCycleSlice.compute_observable">[docs]</a>    <span class="k">def</span> <span class="nf">compute_observable</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span>
                           <span class="n">map_func</span><span class="o">=</span><span class="nb">map</span><span class="p">,</span>
                           <span class="n">traj_sel</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                           <span class="n">save_to_hdf5</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">idxs</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">return_results</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Compute an observable on the trajectory data according to a</span>
<span class="sd">        function. Optionally save that data in the observables data group for</span>
<span class="sd">        the trajectory.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">save_to_hdf5</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="s1">&#39;w-&#39;</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;r+&#39;</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="s1">&#39;c-&#39;</span><span class="p">],</span>\
                <span class="s2">&quot;File must be in a write mode&quot;</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">save_to_hdf5</span><span class="p">,</span> <span class="nb">str</span><span class="p">),</span>\
                <span class="s2">&quot;`save_to_hdf5` should be the field name to save the data in the `observables` group in each trajectory&quot;</span>
            <span class="n">field_name</span><span class="o">=</span><span class="n">save_to_hdf5</span>

            <span class="c1">#DEBUG enforce this until sparse trajectories are implemented</span>
            <span class="k">assert</span> <span class="n">traj_sel</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;no selections until sparse trajectory data is implemented&quot;</span>

        <span class="n">idx</span> <span class="o">=</span><span class="mi">0</span>

        <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">traj_cycles_map</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span>
                                       <span class="n">map_func</span><span class="o">=</span><span class="n">map_func</span><span class="p">,</span> <span class="n">traj_sel</span><span class="o">=</span><span class="n">traj_sel</span><span class="p">,</span> <span class="n">idxs</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
            <span class="n">idx_tup</span><span class="p">,</span> <span class="n">obs_value</span> <span class="o">=</span> <span class="n">result</span>
            <span class="n">run_idx</span><span class="p">,</span> <span class="n">traj_idx</span> <span class="o">=</span> <span class="n">idx_tup</span>

            <span class="c1"># if we are saving this to the trajectories observables add it as a dataset</span>
            <span class="k">if</span> <span class="n">save_to_hdf5</span><span class="p">:</span>

                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Saving run </span><span class="si">{}</span><span class="s2"> traj </span><span class="si">{}</span><span class="s2"> observables/</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">run_idx</span><span class="p">,</span> <span class="n">traj_idx</span><span class="p">,</span> <span class="n">field_name</span><span class="p">))</span>

                <span class="c1"># try to get the observables group or make it if it doesn&#39;t exist</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">obs_grp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">traj</span><span class="p">(</span><span class="n">run_idx</span><span class="p">,</span> <span class="n">traj_idx</span><span class="p">)[</span><span class="n">OBSERVABLES</span><span class="p">]</span>
                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>

                    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Group uninitialized. Initializing.&quot;</span><span class="p">)</span>

                    <span class="n">obs_grp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">traj</span><span class="p">(</span><span class="n">run_idx</span><span class="p">,</span> <span class="n">traj_idx</span><span class="p">)</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="n">OBSERVABLES</span><span class="p">)</span>

                <span class="c1"># try to create the dataset</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">obs_grp</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="n">field_name</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">obs_value</span><span class="p">)</span>
                <span class="c1"># if it fails we either overwrite or raise an error</span>
                <span class="k">except</span> <span class="ne">RuntimeError</span><span class="p">:</span>
                    <span class="c1"># if we are in a permissive write mode we delete the</span>
                    <span class="c1"># old dataset and add the new one, overwriting old data</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="s1">&#39;w-&#39;</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;r+&#39;</span><span class="p">]:</span>

                        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Dataset already present. Overwriting.&quot;</span><span class="p">)</span>

                        <span class="k">del</span> <span class="n">obs_grp</span><span class="p">[</span><span class="n">field_name</span><span class="p">]</span>
                        <span class="n">obs_grp</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="n">field_name</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">obs_value</span><span class="p">)</span>
                    <span class="c1"># this will happen in &#39;c&#39; and &#39;c-&#39; modes</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                            <span class="s2">&quot;Dataset already exists and file is in concatenate mode (&#39;c&#39; or &#39;c-&#39;)&quot;</span><span class="p">)</span>

            <span class="c1"># also return it if requested</span>
            <span class="k">if</span> <span class="n">return_results</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">idxs</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="n">idx_tup</span><span class="p">,</span> <span class="n">obs_value</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="n">obs_value</span></div></div>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">wepy</a></h1>








<h3>Navigation</h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../source/explanation.html">Explanation of Wepy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../source/glossary.html">Glossary</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/index.html">Module Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tutorials/index.html">Tutorials</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2018, Samuel D. Lotz.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.8.2</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>