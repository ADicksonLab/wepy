
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>wepy.analysis.parents &#8212; wepy v0.10 documentation</title>
    <link rel="stylesheet" href="../../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for wepy.analysis.parents</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">copy</span> <span class="k">import</span> <span class="n">copy</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">networkx</span> <span class="k">as</span> <span class="nn">nx</span>

<span class="n">DISCONTINUITY_VALUE</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

<div class="viewcode-block" id="resampling_panel"><a class="viewcode-back" href="../../../api/wepy.analysis.html#wepy.analysis.parents.resampling_panel">[docs]</a><span class="k">def</span> <span class="nf">resampling_panel</span><span class="p">(</span><span class="n">resampling_records</span><span class="p">,</span> <span class="n">is_sorted</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Converts a simple collection of resampling records into a list of</span>
<span class="sd">    elements corresponding to cycles. It is like doing a pivot on</span>
<span class="sd">    the step indices into an extra dimension. Hence it can be</span>
<span class="sd">    thought of as a list of tables indexed by the cycle, hence the</span>
<span class="sd">    name panel.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">res_panel</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># if the records are not sorted this must be done:</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">is_sorted</span><span class="p">:</span>
        <span class="n">resampling_records</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>

    <span class="c1"># iterate through the resampling records</span>
    <span class="n">rec_it</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">resampling_records</span><span class="p">)</span>
    <span class="n">last_cycle_idx</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">cycle_recs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">stop</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">while</span> <span class="ow">not</span> <span class="n">stop</span><span class="p">:</span>

        <span class="c1"># iterate through records until either there is none left or</span>
        <span class="c1"># until you get to the next cycle</span>
        <span class="n">cycle_stop</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="n">cycle_stop</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">rec</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">rec_it</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
                <span class="c1"># this is the last record of all the records</span>
                <span class="n">stop</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="c1"># this is the last record for the last cycle as well</span>
                <span class="n">cycle_stop</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="c1"># alias for the current cycle</span>
                <span class="n">curr_cycle_recs</span> <span class="o">=</span> <span class="n">cycle_recs</span>
            <span class="k">else</span><span class="p">:</span>

                <span class="c1"># the cycles in the records may not start at 0, but</span>
                <span class="c1"># they are in order so we initialize the last</span>
                <span class="c1"># cycle_idx so we know when in the records we have</span>
                <span class="c1"># gotten to the next cycle of records</span>
                <span class="k">if</span> <span class="n">last_cycle_idx</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">last_cycle_idx</span> <span class="o">=</span> <span class="n">rec</span><span class="o">.</span><span class="n">cycle_idx</span>

                <span class="c1"># if the resampling record retrieved is from the next</span>
                <span class="c1"># cycle we finish the last cycle</span>
                <span class="k">if</span> <span class="n">rec</span><span class="o">.</span><span class="n">cycle_idx</span> <span class="o">&gt;</span> <span class="n">last_cycle_idx</span><span class="p">:</span>
                    <span class="n">cycle_stop</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="c1"># save the current cycle as a special</span>
                    <span class="c1"># list which we will iterate through</span>
                    <span class="c1"># to reduce down to the bare</span>
                    <span class="c1"># resampling record</span>
                    <span class="n">curr_cycle_recs</span> <span class="o">=</span> <span class="n">cycle_recs</span>

                    <span class="c1"># start a new cycle_recs for the record</span>
                    <span class="c1"># we just got</span>
                    <span class="n">cycle_recs</span> <span class="o">=</span> <span class="p">[</span><span class="n">rec</span><span class="p">]</span>
                    <span class="n">last_cycle_idx</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">cycle_stop</span><span class="p">:</span>
                <span class="n">cycle_recs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rec</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>

                <span class="c1"># we need to break up the records in the cycle into steps</span>
                <span class="n">cycle_table</span> <span class="o">=</span> <span class="p">[]</span>

                <span class="c1"># temporary container for the step we are working on</span>
                <span class="n">step_recs</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">step_idx</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">step_stop</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">cycle_it</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">curr_cycle_recs</span><span class="p">)</span>
                <span class="k">while</span> <span class="ow">not</span> <span class="n">step_stop</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">cycle_rec</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">cycle_it</span><span class="p">)</span>
                    <span class="c1"># stop the step if this is the last record for the cycle</span>
                    <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
                        <span class="n">step_stop</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="c1"># alias for the current step</span>
                        <span class="n">curr_step_recs</span> <span class="o">=</span> <span class="n">step_recs</span>

                    <span class="c1"># or if the next stop index has been obtained</span>
                    <span class="k">else</span><span class="p">:</span>

                        <span class="k">if</span> <span class="n">cycle_rec</span><span class="o">.</span><span class="n">step_idx</span> <span class="o">&gt;</span> <span class="n">step_idx</span><span class="p">:</span>
                            <span class="n">step_stop</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="c1"># save the current step as a special</span>
                            <span class="c1"># list which we will iterate through</span>
                            <span class="c1"># to reduce down to the bare</span>
                            <span class="c1"># resampling record</span>
                            <span class="n">curr_step_recs</span> <span class="o">=</span> <span class="n">step_recs</span>

                            <span class="c1"># start a new step_recs for the record</span>
                            <span class="c1"># we just got</span>
                            <span class="n">step_recs</span> <span class="o">=</span> <span class="p">[</span><span class="n">cycle_rec</span><span class="p">]</span>
                            <span class="n">step_idx</span> <span class="o">+=</span> <span class="mi">1</span>


                    <span class="k">if</span> <span class="ow">not</span> <span class="n">step_stop</span><span class="p">:</span>
                        <span class="n">step_recs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cycle_rec</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># go through the walkers for this step since it is completed</span>
                        <span class="n">step_row</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">curr_step_recs</span><span class="p">))]</span>
                        <span class="k">for</span> <span class="n">walker_rec</span> <span class="ow">in</span> <span class="n">curr_step_recs</span><span class="p">:</span>

                            <span class="c1"># collect data from the record</span>
                            <span class="n">walker_idx</span> <span class="o">=</span> <span class="n">walker_rec</span><span class="o">.</span><span class="n">walker_idx</span>
                            <span class="n">decision_id</span> <span class="o">=</span> <span class="n">walker_rec</span><span class="o">.</span><span class="n">decision_id</span>
                            <span class="n">instruction</span> <span class="o">=</span> <span class="n">walker_rec</span><span class="o">.</span><span class="n">target_idxs</span>

                            <span class="c1"># set the resampling record for the walker in the step records</span>
                            <span class="n">step_row</span><span class="p">[</span><span class="n">walker_idx</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">decision_id</span><span class="p">,</span> <span class="n">instruction</span><span class="p">)</span>


                        <span class="c1"># add the records for this step to the cycle table</span>
                        <span class="n">cycle_table</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">step_row</span><span class="p">)</span>

        <span class="c1"># add the table for this cycles records to the parent panel</span>
        <span class="n">res_panel</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cycle_table</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">res_panel</span></div>


<div class="viewcode-block" id="parent_panel"><a class="viewcode-back" href="../../../api/wepy.analysis.html#wepy.analysis.parents.parent_panel">[docs]</a><span class="k">def</span> <span class="nf">parent_panel</span><span class="p">(</span><span class="n">decision_class</span><span class="p">,</span> <span class="n">resampling_panel</span><span class="p">):</span>

    <span class="n">parent_panel_in</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">cycle</span> <span class="ow">in</span> <span class="n">resampling_panel</span><span class="p">:</span>

        <span class="c1"># each stage in the resampling for that cycle</span>
        <span class="c1"># make a stage parent table</span>
        <span class="n">parent_table</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># now iterate through the rest of the stages</span>
        <span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="n">cycle</span><span class="p">:</span>

            <span class="c1"># get the parents idxs for the children of this step</span>
            <span class="n">step_parents</span> <span class="o">=</span> <span class="n">decision_class</span><span class="o">.</span><span class="n">parents</span><span class="p">(</span><span class="n">step</span><span class="p">)</span>

            <span class="c1"># for the full stage table save all the intermediate parents</span>
            <span class="n">parent_table</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">step_parents</span><span class="p">)</span>

        <span class="c1"># for the full parent panel</span>
        <span class="n">parent_panel_in</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">parent_table</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">parent_panel_in</span></div>

<div class="viewcode-block" id="net_parent_table"><a class="viewcode-back" href="../../../api/wepy.analysis.html#wepy.analysis.parents.net_parent_table">[docs]</a><span class="k">def</span> <span class="nf">net_parent_table</span><span class="p">(</span><span class="n">parent_panel</span><span class="p">):</span>

    <span class="n">net_parent_table_in</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># each cycle</span>
    <span class="k">for</span> <span class="n">cycle_idx</span><span class="p">,</span> <span class="n">step_parent_table</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">parent_panel</span><span class="p">):</span>
        <span class="c1"># for the net table we only want the end results,</span>
        <span class="c1"># we start at the last cycle and look at its parent</span>
        <span class="n">step_net_parents</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">n_steps</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">step_parent_table</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">walker_idx</span><span class="p">,</span> <span class="n">parent_idx</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">step_parent_table</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
            <span class="c1"># initialize the root_parent_idx which will be updated</span>
            <span class="n">root_parent_idx</span> <span class="o">=</span> <span class="n">parent_idx</span>

            <span class="c1"># if no resampling skip the loop and just return the idx</span>
            <span class="k">if</span> <span class="n">n_steps</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># go back through the steps getting the parent at each step</span>
                <span class="k">for</span> <span class="n">prev_step_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_steps</span><span class="p">):</span>
                    <span class="n">prev_step_parents</span> <span class="o">=</span> <span class="n">step_parent_table</span><span class="p">[</span><span class="o">-</span><span class="p">(</span><span class="n">prev_step_idx</span><span class="o">+</span><span class="mi">1</span><span class="p">)]</span>
                    <span class="n">root_parent_idx</span> <span class="o">=</span> <span class="n">prev_step_parents</span><span class="p">[</span><span class="n">root_parent_idx</span><span class="p">]</span>

            <span class="c1"># when this is done we should have the index of the root parent,</span>
            <span class="c1"># save this as the net parent index</span>
            <span class="n">step_net_parents</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">root_parent_idx</span><span class="p">)</span>

        <span class="c1"># for this step save the net parents</span>
        <span class="n">net_parent_table_in</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">step_net_parents</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">net_parent_table_in</span></div>

<div class="viewcode-block" id="parent_table_discontinuities"><a class="viewcode-back" href="../../../api/wepy.analysis.html#wepy.analysis.parents.parent_table_discontinuities">[docs]</a><span class="k">def</span> <span class="nf">parent_table_discontinuities</span><span class="p">(</span><span class="n">boundary_condition_class</span><span class="p">,</span> <span class="n">parent_table</span><span class="p">,</span> <span class="n">warping_records</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Given a parent table and warping records returns a new parent table</span>
<span class="sd">    with the discontinuous warping events for parents set to -1&quot;&quot;&quot;</span>

    <span class="c1"># Make a copy of the parent table</span>
    <span class="n">new_parent_table</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">parent_table</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">warp_record</span> <span class="ow">in</span> <span class="n">warping_records</span><span class="p">:</span>

        <span class="n">cycle_idx</span> <span class="o">=</span> <span class="n">warp_record</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">parent_idx</span> <span class="o">=</span> <span class="n">warp_record</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="n">n_walkers</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">parent_table</span><span class="p">[</span><span class="n">cycle_idx</span><span class="p">])</span>


        <span class="c1"># Check to see if any walkers in the current step</span>
        <span class="c1"># originated from this warped walker</span>
        <span class="k">for</span> <span class="n">walker_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_walkers</span><span class="p">):</span>

            <span class="c1"># if it&#39;s parent is the walker in this warping event</span>
            <span class="c1"># we also need to check to see if that warping event</span>
            <span class="c1"># was a discontinuous warping event</span>
            <span class="k">if</span> <span class="n">parent_table</span><span class="p">[</span><span class="n">cycle_idx</span><span class="p">][</span><span class="n">walker_idx</span><span class="p">]</span> <span class="o">==</span> <span class="n">parent_idx</span><span class="p">:</span>

                <span class="c1"># just check by using the method from the boundary</span>
                <span class="c1"># condition class used</span>
                <span class="k">if</span> <span class="n">boundary_condition_class</span><span class="o">.</span><span class="n">warping_discontinuity</span><span class="p">(</span><span class="n">warp_record</span><span class="p">):</span>

                    <span class="c1"># set the element in the parent table to the</span>
                    <span class="c1"># discontinuity value if it is</span>
                    <span class="n">new_parent_table</span><span class="p">[</span><span class="n">cycle_idx</span><span class="p">][</span><span class="n">walker_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">DISCONTINUITY_VALUE</span>

    <span class="k">return</span> <span class="n">new_parent_table</span></div>

<div class="viewcode-block" id="ancestors"><a class="viewcode-back" href="../../../api/wepy.analysis.html#wepy.analysis.parents.ancestors">[docs]</a><span class="k">def</span> <span class="nf">ancestors</span><span class="p">(</span><span class="n">parent_table</span><span class="p">,</span> <span class="n">cycle_idx</span><span class="p">,</span> <span class="n">walker_idx</span><span class="p">,</span> <span class="n">ancestor_cycle</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Given a parent table, step_idx, and walker idx returns the</span>
<span class="sd">    ancestor at a given cycle of the walker.</span>

<span class="sd">    Input:</span>

<span class="sd">    parent: table (n_cycles x n_walkers numpy array): It describes</span>
<span class="sd">    how the walkers merged and cloned during the WExplore simulation .</span>

<span class="sd">    cycle_idx:</span>

<span class="sd">    walker_idx:</span>

<span class="sd">    ancestor_cycle:</span>


<span class="sd">    Output:</span>

<span class="sd">    ancestors: A list of 2x1 tuples indicating the</span>
<span class="sd">                   walker and cycle parents</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">lineage</span> <span class="o">=</span> <span class="p">[(</span><span class="n">walker_idx</span><span class="p">,</span> <span class="n">cycle_idx</span><span class="p">)]</span>

    <span class="n">previous_walker</span> <span class="o">=</span> <span class="n">walker_idx</span>

    <span class="k">for</span> <span class="n">curr_cycle_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">cycle_idx</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">ancestor_cycle</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">previous_walker</span> <span class="o">=</span> <span class="n">parent_table</span><span class="p">[</span><span class="n">curr_cycle_idx</span><span class="p">][</span><span class="n">previous_walker</span><span class="p">]</span>

            <span class="c1"># check for discontinuities, e.g. warping events</span>
            <span class="k">if</span> <span class="n">previous_walker</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="c1"># there are no more continuous ancestors for this</span>
                <span class="c1"># walker so we cannot return ancestors back to the</span>
                <span class="c1"># requested cycle just return the ancestors to this</span>
                <span class="c1"># point</span>
                <span class="k">break</span>

            <span class="n">previous_point</span> <span class="o">=</span> <span class="p">(</span><span class="n">previous_walker</span><span class="p">,</span> <span class="n">curr_cycle_idx</span><span class="p">)</span>
            <span class="n">lineage</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">previous_point</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">lineage</span></div>

<div class="viewcode-block" id="sliding_window"><a class="viewcode-back" href="../../../api/wepy.analysis.html#wepy.analysis.parents.sliding_window">[docs]</a><span class="k">def</span> <span class="nf">sliding_window</span><span class="p">(</span><span class="n">parent_table</span><span class="p">,</span> <span class="n">window_length</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns traces (lists of frames across a run) on a sliding window</span>
<span class="sd">    on the branching structure of a run of a WepyHDF5 file. There is</span>
<span class="sd">    no particular order guaranteed.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># assert parent_table.dtype == np.int, \</span>
    <span class="c1">#     &quot;parent table values must be integers, not {}&quot;.format(parent_table.dtype)</span>

    <span class="k">assert</span> <span class="n">window_length</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;window length must be greater than one&quot;</span>

    <span class="n">windows</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># we make a range iterator which goes from the last cycle to the</span>
    <span class="c1"># cycle which would be the end of the first possible sliding window</span>
    <span class="k">for</span> <span class="n">cycle_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">parent_table</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">window_length</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="c1"># then iterate for each walker at this cycle</span>
        <span class="k">for</span> <span class="n">walker_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">parent_table</span><span class="p">[</span><span class="mi">0</span><span class="p">])):</span>

            <span class="c1"># then get the ancestors according to the sliding window</span>
            <span class="n">window</span> <span class="o">=</span> <span class="n">ancestors</span><span class="p">(</span><span class="n">parent_table</span><span class="p">,</span> <span class="n">cycle_idx</span><span class="p">,</span> <span class="n">walker_idx</span><span class="p">,</span>
                               <span class="n">ancestor_cycle</span><span class="o">=</span><span class="n">cycle_idx</span><span class="o">-</span><span class="p">(</span><span class="n">window_length</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>

            <span class="c1"># if the window is too short because the lineage has a</span>
            <span class="c1"># discontinuity in it skip to the next window</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">window</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">window_length</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">windows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">window</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">windows</span></div>


<div class="viewcode-block" id="ParentForest"><a class="viewcode-back" href="../../../api/wepy.analysis.html#wepy.analysis.parents.ParentForest">[docs]</a><span class="k">class</span> <span class="nc">ParentForest</span><span class="p">():</span>

    <span class="n">WEIGHT</span> <span class="o">=</span> <span class="s1">&#39;weight&#39;</span>
    <span class="n">FREE_ENERGY</span> <span class="o">=</span> <span class="s1">&#39;free_energy&#39;</span>

    <span class="n">ROOT_CYCLE_IDX</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="n">DISCONTINUITY_VALUE</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">contig</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">parent_table</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">contig</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">parent_table</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Pass in either a contig or a parent table but not both&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">contig</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">parent_table</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Must provide either a contig or a parent table&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_contig</span> <span class="o">=</span> <span class="n">contig</span>

        <span class="c1"># if the contig was given, generate a parent table</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">contig</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

            <span class="c1"># from that contig make a parent table</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_parent_table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">contig</span><span class="o">.</span><span class="n">parent_table</span><span class="p">()</span>

        <span class="c1"># otherwise use the one given</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_parent_table</span> <span class="o">=</span> <span class="n">parent_table</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_graph</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">DiGraph</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_n_steps</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent_table</span><span class="p">)</span>

        <span class="c1"># TODO this should be somehow removed so that we can</span>
        <span class="c1"># generalize to a variable number of walkers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_n_walkers</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent_table</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="c1"># make the roots of each tree in the parent graph, because</span>
        <span class="c1"># this is outside the indexing of the steps we use a special</span>
        <span class="c1"># index</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_roots</span> <span class="o">=</span> <span class="p">[(</span><span class="bp">self</span><span class="o">.</span><span class="n">ROOT_CYCLE_IDX</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_walkers</span><span class="p">)]</span>

        <span class="c1"># set these as nodes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">add_nodes_from</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">roots</span><span class="p">)</span>

        <span class="c1"># go through the parent matrix and make edges from the parents</span>
        <span class="c1"># to children nodes</span>
        <span class="k">for</span> <span class="n">step_idx</span><span class="p">,</span> <span class="n">parent_idxs</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent_table</span><span class="p">):</span>

            <span class="c1"># make edge between each walker of this step to the previous step</span>
            <span class="n">edges</span><span class="p">,</span> <span class="n">edges_attrs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_child_parent_edges</span><span class="p">(</span><span class="n">step_idx</span><span class="p">,</span> <span class="n">parent_idxs</span><span class="p">)</span>

            <span class="c1"># then put them into this graph</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">edge</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">edges</span><span class="p">):</span>

                <span class="k">if</span> <span class="n">edge</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

                    <span class="c1"># if there is a discontinuity in the edge we only</span>
                    <span class="c1"># add the node</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">DISCONTINUITY_VALUE</span> <span class="o">==</span> <span class="n">edge</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">edge</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="o">*</span><span class="n">edge</span><span class="p">,</span> <span class="o">**</span><span class="n">edges_attrs</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">_make_child_parent_edges</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">step_idx</span><span class="p">,</span> <span class="n">parent_idxs</span><span class="p">):</span>

        <span class="n">edges</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">edges_attrs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">curr_walker_idx</span><span class="p">,</span> <span class="n">parent_idx</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">parent_idxs</span><span class="p">):</span>

            <span class="c1"># if the parent is the discontinuity value we set the</span>
            <span class="c1"># parent node in the edge as the discontinuity value</span>
            <span class="k">if</span> <span class="n">parent_idx</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">DISCONTINUITY_VALUE</span><span class="p">:</span>
                <span class="n">parent_node</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">DISCONTINUITY_VALUE</span>
                <span class="n">child_node</span> <span class="o">=</span> <span class="p">(</span><span class="n">step_idx</span><span class="p">,</span> <span class="n">curr_walker_idx</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># otherwise we make the edge with the parent and child as</span>
                <span class="c1"># normal</span>
                <span class="n">parent_node</span> <span class="o">=</span> <span class="p">(</span><span class="n">step_idx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">parent_idx</span><span class="p">)</span>
                <span class="n">child_node</span> <span class="o">=</span> <span class="p">(</span><span class="n">step_idx</span><span class="p">,</span> <span class="n">curr_walker_idx</span><span class="p">)</span>

            <span class="c1"># make an edge between the parent of this walker and this walker</span>
            <span class="n">edge</span> <span class="o">=</span> <span class="p">(</span><span class="n">parent_node</span><span class="p">,</span> <span class="n">child_node</span><span class="p">)</span>

            <span class="n">edges</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">edge</span><span class="p">)</span>

            <span class="c1"># nothing to do but I already wrote it this way and may be</span>
            <span class="c1"># useful later</span>
            <span class="n">edge_attrs</span> <span class="o">=</span> <span class="p">{}</span>

            <span class="n">edges_attrs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">edge_attrs</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">edges</span><span class="p">,</span> <span class="n">edges_attrs</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">contig</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_contig</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">parent_table</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parent_table</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">graph</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_graph</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">roots</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_roots</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">trees</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">trees_by_size</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">subgraph</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">nx</span><span class="o">.</span><span class="n">weakly_connected_components</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="p">)]</span>
        <span class="n">trees</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">root</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">roots</span><span class="p">:</span>
            <span class="n">root_tree</span> <span class="o">=</span> <span class="p">[</span><span class="n">tree</span> <span class="k">for</span> <span class="n">tree</span> <span class="ow">in</span> <span class="n">trees_by_size</span> <span class="k">if</span> <span class="n">root</span> <span class="ow">in</span> <span class="n">tree</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">trees</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">root_tree</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">trees</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">n_steps</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_steps</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">n_walkers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_walkers</span>

<div class="viewcode-block" id="ParentForest.step"><a class="viewcode-back" href="../../../api/wepy.analysis.html#wepy.analysis.parents.ParentForest.step">[docs]</a>    <span class="k">def</span> <span class="nf">step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">step_idx</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Get the nodes at the step (level of the tree).&quot;&quot;&quot;</span>

        <span class="n">step_nodes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">node</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">step_idx</span><span class="p">:</span>
                <span class="n">step_nodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>

        <span class="n">step_nodes</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">step_nodes</span></div>

<div class="viewcode-block" id="ParentForest.steps"><a class="viewcode-back" href="../../../api/wepy.analysis.html#wepy.analysis.parents.ParentForest.steps">[docs]</a>    <span class="k">def</span> <span class="nf">steps</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">node_steps</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">step_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_steps</span><span class="p">):</span>
            <span class="n">node_steps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">step_idx</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">node_steps</span></div>

<div class="viewcode-block" id="ParentForest.walker"><a class="viewcode-back" href="../../../api/wepy.analysis.html#wepy.analysis.parents.ParentForest.walker">[docs]</a>    <span class="k">def</span> <span class="nf">walker</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">walker_idx</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Get the nodes for this walker.&quot;&quot;&quot;</span>

        <span class="n">walker_nodes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">node</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">walker_idx</span><span class="p">:</span>
                <span class="n">walker_nodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>

        <span class="n">walker_nodes</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">walker_nodes</span></div>

<div class="viewcode-block" id="ParentForest.walkers"><a class="viewcode-back" href="../../../api/wepy.analysis.html#wepy.analysis.parents.ParentForest.walkers">[docs]</a>    <span class="k">def</span> <span class="nf">walkers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">node_walkers</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">walker_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_walkers</span><span class="p">):</span>
            <span class="n">node_walkers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">walker</span><span class="p">(</span><span class="n">walker_idx</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">node_walkers</span></div>

<div class="viewcode-block" id="ParentForest.set_node_attributes"><a class="viewcode-back" href="../../../api/wepy.analysis.html#wepy.analysis.parents.ParentForest.set_node_attributes">[docs]</a>    <span class="k">def</span> <span class="nf">set_node_attributes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attribute_key</span><span class="p">,</span> <span class="n">node_attribute_dict</span><span class="p">):</span>

        <span class="k">for</span> <span class="n">node_id</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">node_attribute_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">node_id</span><span class="p">][</span><span class="n">attribute_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span></div>

<div class="viewcode-block" id="ParentForest.set_attrs_by_array"><a class="viewcode-back" href="../../../api/wepy.analysis.html#wepy.analysis.parents.ParentForest.set_attrs_by_array">[docs]</a>    <span class="k">def</span> <span class="nf">set_attrs_by_array</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">values</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Set attributes on a stepwise basis, i.e. expects a array/list that</span>
<span class="sd">        is n_steps long and has the appropriate number of values for</span>
<span class="sd">        the number of walkers at each step</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">steps</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">step</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="n">node</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="n">node</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
                <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                    <span class="kn">import</span> <span class="nn">ipdb</span><span class="p">;</span> <span class="n">ipdb</span><span class="o">.</span><span class="n">set_trace</span><span class="p">()</span></div></div>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../index.html">wepy</a></h1>








<h3>Navigation</h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../source/explanation.html">Explanation of Wepy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/index.html">Module Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorials/index.html">Tutorials</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../index.html">Documentation overview</a><ul>
  <li><a href="../../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2018, Samuel D. Lotz.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.8.2</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>