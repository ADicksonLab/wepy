
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>wepy.analysis.contig_tree &#8212; wepy v0.10 documentation</title>
    <link rel="stylesheet" href="../../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for wepy.analysis.contig_tree</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">itertools</span> <span class="k">as</span> <span class="nn">it</span>
<span class="kn">from</span> <span class="nn">copy</span> <span class="k">import</span> <span class="n">copy</span>

<span class="kn">import</span> <span class="nn">networkx</span> <span class="k">as</span> <span class="nn">nx</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">from</span> <span class="nn">wepy.analysis.parents</span> <span class="k">import</span> <span class="n">DISCONTINUITY_VALUE</span><span class="p">,</span> \
                                  <span class="n">parent_panel</span><span class="p">,</span> <span class="n">net_parent_table</span><span class="p">,</span>\
                                  <span class="n">ancestors</span><span class="p">,</span> <span class="n">sliding_window</span>

<span class="c1"># optional dependencies</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="k">except</span> <span class="n">ModuleNotFoundError</span><span class="p">:</span>
    <span class="n">warn</span><span class="p">(</span><span class="s2">&quot;pandas is not installed and that functionality will not work&quot;</span><span class="p">,</span> <span class="ne">RuntimeWarning</span><span class="p">)</span>


<span class="c1"># the groups of run records</span>
<span class="n">RESAMPLING</span> <span class="o">=</span> <span class="s1">&#39;resampling&#39;</span>
<span class="n">RESAMPLER</span> <span class="o">=</span> <span class="s1">&#39;resampler&#39;</span>
<span class="n">WARPING</span> <span class="o">=</span> <span class="s1">&#39;warping&#39;</span>
<span class="n">PROGRESS</span> <span class="o">=</span> <span class="s1">&#39;progress&#39;</span>
<span class="n">BC</span> <span class="o">=</span> <span class="s1">&#39;boundary_conditions&#39;</span>

<div class="viewcode-block" id="ContigTree"><a class="viewcode-back" href="../../../api/wepy.analysis.html#wepy.analysis.contig_tree.ContigTree">[docs]</a><span class="k">class</span> <span class="nc">ContigTree</span><span class="p">():</span>

    <span class="n">RESAMPLING_PANEL_KEY</span> <span class="o">=</span> <span class="s1">&#39;resampling_steps&#39;</span>
    <span class="n">PARENTS_KEY</span> <span class="o">=</span> <span class="s1">&#39;parent_idxs&#39;</span>
    <span class="n">DISCONTINUITY_KEY</span> <span class="o">=</span> <span class="s1">&#39;discontinuities&#39;</span>


    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">wepy_h5</span><span class="p">,</span>
                 <span class="n">continuations</span><span class="o">=</span><span class="bp">Ellipsis</span><span class="p">,</span>
                 <span class="n">runs</span><span class="o">=</span><span class="bp">Ellipsis</span><span class="p">,</span>
                 <span class="n">boundary_condition_class</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">decision_class</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_graph</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">DiGraph</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_wepy_h5</span> <span class="o">=</span> <span class="n">wepy_h5</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_boundary_condition_class</span><span class="o">=</span><span class="n">boundary_condition_class</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_decision_class</span> <span class="o">=</span> <span class="n">decision_class</span>

        <span class="c1"># we can optionally specify which continuations to use when</span>
        <span class="c1"># creating the contig tree instead of defaulting to the whole file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_continuations</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_run_idxs</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

        <span class="c1"># if specific runs were specified we add them right away, they</span>
        <span class="c1"># should be unique</span>
        <span class="k">if</span> <span class="n">runs</span> <span class="ow">is</span> <span class="bp">Ellipsis</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_run_idxs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wepy_h5</span><span class="o">.</span><span class="n">run_idxs</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">runs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_run_idxs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">runs</span><span class="p">)</span>

        <span class="c1"># the continuations also give extra runs to incorporate into</span>
        <span class="c1"># this contig tree</span>

        <span class="c1"># if it is Ellipsis (...) then we include all runs and all the continuations</span>
        <span class="k">if</span> <span class="n">continuations</span> <span class="ow">is</span> <span class="bp">Ellipsis</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_run_idxs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wepy_h5</span><span class="o">.</span><span class="n">run_idxs</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_continuations</span><span class="o">.</span><span class="n">update</span><span class="p">([(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">wepy_h5</span><span class="o">.</span><span class="n">continuations</span><span class="p">])</span>

        <span class="c1"># otherwise we make the tree based on the runs in the</span>
        <span class="c1"># continuations</span>
        <span class="k">elif</span> <span class="n">continuations</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># the unique run_idxs</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_run_idxs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">it</span><span class="o">.</span><span class="n">chain</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_continuations</span><span class="p">))</span>

            <span class="c1"># the continuations themselves</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_continuations</span><span class="o">.</span><span class="n">update</span><span class="p">([(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">continuations</span><span class="p">])</span>


        <span class="c1"># using the wepy_h5 create a tree of the cycles</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_create_tree</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_set_resampling_panels</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_decision_class</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_parents</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_decision_class</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_boundary_condition_class</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_set_discontinuities</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_boundary_condition_class</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">graph</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_graph</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">decision_class</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_decision_class</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">boundary_condition_class</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_boundary_condition_class</span>

    <span class="k">def</span> <span class="nf">_create_tree</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="c1"># first go through each run without continuations</span>
        <span class="k">for</span> <span class="n">run_idx</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_idxs</span><span class="p">:</span>
            <span class="n">n_cycles</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wepy_h5</span><span class="o">.</span><span class="n">run_n_cycles</span><span class="p">(</span><span class="n">run_idx</span><span class="p">)</span>

            <span class="c1"># make all the nodes for this run</span>
            <span class="n">nodes</span> <span class="o">=</span> <span class="p">[(</span><span class="n">run_idx</span><span class="p">,</span> <span class="n">step_idx</span><span class="p">)</span> <span class="k">for</span> <span class="n">step_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_cycles</span><span class="p">)]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">add_nodes_from</span><span class="p">(</span><span class="n">nodes</span><span class="p">)</span>

            <span class="c1"># the same for the edges</span>
            <span class="n">edge_node_idxs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_cycles</span><span class="p">),</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_cycles</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)))</span>

            <span class="n">edges</span> <span class="o">=</span> <span class="p">[(</span><span class="n">nodes</span><span class="p">[</span><span class="n">a</span><span class="p">],</span> <span class="n">nodes</span><span class="p">[</span><span class="n">b</span><span class="p">])</span> <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">edge_node_idxs</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">add_edges_from</span><span class="p">(</span><span class="n">edges</span><span class="p">)</span>

        <span class="c1"># after we have added all the nodes and edges for the run</span>
        <span class="c1"># subgraphs we need to connect them together with the</span>
        <span class="c1"># information in the contig tree.</span>
        <span class="k">for</span> <span class="n">edge_source</span><span class="p">,</span> <span class="n">edge_target</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_continuations</span><span class="p">:</span>

            <span class="c1"># for the source node (the restart run) we use the run_idx</span>
            <span class="c1"># from the edge source node and the index of the first</span>
            <span class="c1"># cycle</span>
            <span class="n">source_node</span> <span class="o">=</span> <span class="p">(</span><span class="n">edge_source</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

            <span class="c1"># for the target node (the run being continued) we use the</span>
            <span class="c1"># run_idx from the edge_target and the last cycle index in</span>
            <span class="c1"># the run</span>
            <span class="n">target_node</span> <span class="o">=</span> <span class="p">(</span><span class="n">edge_target</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">wepy_h5</span><span class="o">.</span><span class="n">run_n_cycles</span><span class="p">(</span><span class="n">edge_target</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

            <span class="c1"># make the edge</span>
            <span class="n">edge</span> <span class="o">=</span> <span class="p">(</span><span class="n">source_node</span><span class="p">,</span> <span class="n">target_node</span><span class="p">)</span>

            <span class="c1"># add this connector edge to the network</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="o">*</span><span class="n">edge</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_set_resampling_panels</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="c1"># then get the resampling tables for each cycle and put them</span>
        <span class="c1"># as attributes to the appropriate nodes</span>
        <span class="k">for</span> <span class="n">run_idx</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_idxs</span><span class="p">:</span>

            <span class="n">run_resampling_panel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wepy_h5</span><span class="o">.</span><span class="n">run_resampling_panel</span><span class="p">(</span><span class="n">run_idx</span><span class="p">)</span>

            <span class="c1"># add each cycle of this panel to the network by adding</span>
            <span class="c1"># them in as nodes with the resampling steps first</span>
            <span class="k">for</span> <span class="n">step_idx</span><span class="p">,</span> <span class="n">step</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">run_resampling_panel</span><span class="p">):</span>
                <span class="n">node</span> <span class="o">=</span> <span class="p">(</span><span class="n">run_idx</span><span class="p">,</span> <span class="n">step_idx</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">RESAMPLING_PANEL_KEY</span><span class="p">]</span> <span class="o">=</span> <span class="n">step</span>

    <span class="k">def</span> <span class="nf">_set_discontinuities</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">boundary_conditions_class</span><span class="p">):</span>

        <span class="c1"># initialize the attributes for discontinuities to 0s for no</span>
        <span class="c1"># discontinuities</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">:</span>
            <span class="n">n_walkers</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">node</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">PARENTS_KEY</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">node</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">DISCONTINUITY_KEY</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_walkers</span><span class="p">)]</span>

        <span class="c1">#</span>
        <span class="k">for</span> <span class="n">run_idx</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_idxs</span><span class="p">:</span>

            <span class="c1"># get the warping records for this run</span>
            <span class="n">warping_records</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wepy_h5</span><span class="o">.</span><span class="n">warping_records</span><span class="p">([</span><span class="n">run_idx</span><span class="p">])</span>

            <span class="c1"># just the indices for checking stuff later</span>
            <span class="n">warp_cycle_idxs</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="n">rec</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">rec</span> <span class="ow">in</span> <span class="n">warping_records</span><span class="p">])</span>

            <span class="c1"># go through the nodes</span>
            <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">:</span>
                <span class="n">node_run_idx</span> <span class="o">=</span> <span class="n">node</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">node_cycle_idx</span> <span class="o">=</span> <span class="n">node</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

                <span class="c1"># for a node which is in this run and has warp records</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">node_run_idx</span> <span class="o">==</span> <span class="n">run_idx</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">node_cycle_idx</span> <span class="ow">in</span> <span class="n">warp_cycle_idxs</span><span class="p">):</span>

                    <span class="c1"># if there is then we want to apply the</span>
                    <span class="c1"># warping records for this cycle to the</span>
                    <span class="c1"># discontinuities for this cycle</span>
                    <span class="n">cycle_warp_records</span> <span class="o">=</span> <span class="p">[</span><span class="n">rec</span> <span class="k">for</span> <span class="n">rec</span> <span class="ow">in</span> <span class="n">warping_records</span>
                                          <span class="k">if</span> <span class="p">(</span><span class="n">rec</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">node_cycle_idx</span><span class="p">)]</span>

                    <span class="c1"># go through each record and test if it is a</span>
                    <span class="c1"># discontinuous warp</span>
                    <span class="k">for</span> <span class="n">rec</span> <span class="ow">in</span> <span class="n">cycle_warp_records</span><span class="p">:</span>

                        <span class="c1"># index of the trajectory this warp effected</span>
                        <span class="n">rec_traj_idx</span> <span class="o">=</span> <span class="n">rec</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

                        <span class="c1"># if it is discontinuous we need to mark that,</span>
                        <span class="c1"># otherwise do nothing</span>
                        <span class="k">if</span> <span class="n">boundary_conditions_class</span><span class="o">.</span><span class="n">warping_discontinuity</span><span class="p">(</span><span class="n">rec</span><span class="p">):</span>

                            <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">node</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">DISCONTINUITY_KEY</span><span class="p">][</span><span class="n">rec_traj_idx</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

    <span class="k">def</span> <span class="nf">_set_parents</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">decision_class</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Determines the net parents for each cycle and sets them in-place to</span>
<span class="sd">        the cycle tree given.&quot;&quot;&quot;</span>

        <span class="c1"># just go through each node individually in the tree</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">:</span>
            <span class="c1"># get the records for each step in this node</span>
            <span class="n">node_recs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">node</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">RESAMPLING_PANEL_KEY</span><span class="p">]</span>

            <span class="c1"># get the node parent table by using the parent panel method</span>
            <span class="c1"># on the node records</span>
            <span class="n">node_parent_panel</span> <span class="o">=</span> <span class="n">parent_panel</span><span class="p">(</span><span class="n">decision_class</span><span class="p">,</span> <span class="p">[</span><span class="n">node_recs</span><span class="p">])</span>
            <span class="c1"># then get the net parents from this parent panel, and slice</span>
            <span class="c1"># out the only entry from it</span>
            <span class="n">node_parents</span> <span class="o">=</span> <span class="n">net_parent_table</span><span class="p">(</span><span class="n">node_parent_panel</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

            <span class="c1"># put this back into the self</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">PARENTS_KEY</span><span class="p">]</span> <span class="o">=</span> <span class="n">node_parents</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">run_idxs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_idxs</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">continuations</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_continuations</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">wepy_h5</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wepy_h5</span>

<div class="viewcode-block" id="ContigTree.contig_trace_to_run_trace"><a class="viewcode-back" href="../../../api/wepy.analysis.html#wepy.analysis.contig_tree.ContigTree.contig_trace_to_run_trace">[docs]</a>    <span class="k">def</span> <span class="nf">contig_trace_to_run_trace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">contig_trace</span><span class="p">,</span> <span class="n">contig_walker_trace</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Given a trace of a contig with elements (run_idx, cycle_idx) and</span>
<span class="sd">        walker based trace of elements (traj_idx, cycle_idx) over that</span>
<span class="sd">        contig get the trace of elements (run_idx, traj_idx, cycle_idx)</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">frame_idx</span><span class="p">,</span> <span class="n">contig_el</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">contig_trace</span><span class="p">):</span>

            <span class="n">run_idx</span><span class="p">,</span> <span class="n">cycle_idx</span> <span class="o">=</span> <span class="n">contig_el</span>
            <span class="n">traj_idx</span> <span class="o">=</span> <span class="n">contig_walker_trace</span><span class="p">[</span><span class="n">frame_idx</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">frame</span> <span class="o">=</span> <span class="p">(</span><span class="n">run_idx</span><span class="p">,</span> <span class="n">traj_idx</span><span class="p">,</span> <span class="n">cycle_idx</span><span class="p">)</span>
            <span class="n">trace</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">trace</span></div>


<div class="viewcode-block" id="ContigTree.contig_to_run_trace"><a class="viewcode-back" href="../../../api/wepy.analysis.html#wepy.analysis.contig_tree.ContigTree.contig_to_run_trace">[docs]</a>    <span class="k">def</span> <span class="nf">contig_to_run_trace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">contig</span><span class="p">,</span> <span class="n">contig_trace</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Convert a trace of elements (traj_idx, cycle_idx) over the contig</span>
<span class="sd">        trace given over this contig tree and return a trace over the</span>
<span class="sd">        runs with elements (run_idx, traj_idx, cycle_idx).</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># go through the contig and get the lengths of the runs that</span>
        <span class="c1"># are its components, and slice that many trace elements and</span>
        <span class="c1"># build up the new trace</span>
        <span class="n">runs_trace</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">cum_n_frames</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">run_idx</span> <span class="ow">in</span> <span class="n">contig</span><span class="p">:</span>

            <span class="c1"># number of frames in this run</span>
            <span class="n">n_frames</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wepy_h5</span><span class="o">.</span><span class="n">run_n_frames</span><span class="p">(</span><span class="n">run_idx</span><span class="p">)</span>

            <span class="c1"># get the contig trace elements for this run</span>
            <span class="n">contig_trace_elements</span> <span class="o">=</span> <span class="n">contig_trace</span><span class="p">[</span><span class="n">cum_n_frames</span> <span class="p">:</span> <span class="n">n_frames</span> <span class="o">+</span> <span class="n">cum_n_frames</span><span class="p">]</span>

            <span class="c1"># convert the cycle_idxs to the run indexing and add a run_idx to each</span>
            <span class="n">run_trace_elements</span> <span class="o">=</span> <span class="p">[(</span><span class="n">run_idx</span><span class="p">,</span> <span class="n">traj_idx</span><span class="p">,</span> <span class="n">contig_cycle_idx</span> <span class="o">-</span> <span class="n">cum_n_frames</span><span class="p">)</span>
                                  <span class="k">for</span> <span class="n">traj_idx</span><span class="p">,</span> <span class="n">contig_cycle_idx</span> <span class="ow">in</span> <span class="n">contig_trace_elements</span><span class="p">]</span>

            <span class="c1"># add these to the trace</span>
            <span class="n">runs_trace</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">run_trace_elements</span><span class="p">)</span>

            <span class="c1"># then increase the cumulative n_frames for the next run</span>
            <span class="n">cum_n_frames</span> <span class="o">+=</span> <span class="n">n_frames</span>

        <span class="k">return</span> <span class="n">run_trace_elements</span></div>

<div class="viewcode-block" id="ContigTree.contig_cycle_idx"><a class="viewcode-back" href="../../../api/wepy.analysis.html#wepy.analysis.contig_tree.ContigTree.contig_cycle_idx">[docs]</a>    <span class="k">def</span> <span class="nf">contig_cycle_idx</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run_idx</span><span class="p">,</span> <span class="n">cycle_idx</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Get the contig cycle idx for a (run_idx, cycle_idx) pair.&quot;&quot;&quot;</span>

        <span class="c1"># make the contig trace</span>
        <span class="n">contig_trace</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_branch_trace</span><span class="p">(</span><span class="n">run_idx</span><span class="p">,</span> <span class="n">cycle_idx</span><span class="p">)</span>

        <span class="c1"># get the length and subtract one for the index</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">contig_trace</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span></div>


<div class="viewcode-block" id="ContigTree.get_branch_trace"><a class="viewcode-back" href="../../../api/wepy.analysis.html#wepy.analysis.contig_tree.ContigTree.get_branch_trace">[docs]</a>    <span class="k">def</span> <span class="nf">get_branch_trace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run_idx</span><span class="p">,</span> <span class="n">cycle_idx</span><span class="p">,</span> <span class="n">start_contig_idx</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Given an identifier of (run_idx, cycle_idx) from the contig tree</span>
<span class="sd">        and a starting contig index generate a contig trace of</span>
<span class="sd">        (run_idx, cycle_idx) indices for that contig. Which is a</span>
<span class="sd">        branch of the tree hence the name.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">assert</span> <span class="n">start_contig_idx</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;start_contig_idx must be a valid index&quot;</span>

        <span class="c1"># initialize the current node</span>
        <span class="n">curr_node</span> <span class="o">=</span> <span class="p">(</span><span class="n">run_idx</span><span class="p">,</span> <span class="n">cycle_idx</span><span class="p">)</span>

        <span class="c1"># make a trace of this contig</span>
        <span class="n">contig_trace</span> <span class="o">=</span> <span class="p">[</span><span class="n">curr_node</span><span class="p">]</span>

        <span class="c1"># stop the loop when we reach the root of the cycle tree</span>
        <span class="n">at_root</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="n">at_root</span><span class="p">:</span>

            <span class="c1"># first we get the cycle node previous to this one because it</span>
            <span class="c1"># has the parents for the current node</span>
            <span class="n">parent_nodes</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">adj</span><span class="p">[</span><span class="n">curr_node</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

            <span class="c1"># if there is no parent then this is the root of the</span>
            <span class="c1"># cycle_tree and we should stop after this step of the loop</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parent_nodes</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">at_root</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="c1"># or else we put the node into the contig trace</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">parent_node</span> <span class="o">=</span> <span class="n">parent_nodes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">contig_trace</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">parent_node</span><span class="p">)</span>

                <span class="c1"># if there are any parents there should only be one, since it is a tree</span>
                <span class="n">prev_node</span> <span class="o">=</span> <span class="n">parent_nodes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

                <span class="c1"># then update the current node to the previous one</span>
                <span class="n">curr_node</span> <span class="o">=</span> <span class="n">prev_node</span>

        <span class="k">return</span> <span class="n">contig_trace</span></div>

<div class="viewcode-block" id="ContigTree.trace_parent_table"><a class="viewcode-back" href="../../../api/wepy.analysis.html#wepy.analysis.contig_tree.ContigTree.trace_parent_table">[docs]</a>    <span class="k">def</span> <span class="nf">trace_parent_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">contig_trace</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Given a contig trace returns a parent table for that contig.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">parent_table</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">run_idx</span><span class="p">,</span> <span class="n">cycle_idx</span> <span class="ow">in</span> <span class="n">contig_trace</span><span class="p">:</span>
            <span class="n">parent_idxs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">node</span><span class="p">[(</span><span class="n">run_idx</span><span class="p">,</span> <span class="n">cycle_idx</span><span class="p">)][</span><span class="bp">self</span><span class="o">.</span><span class="n">PARENTS_KEY</span><span class="p">]</span>
            <span class="n">parent_table</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">parent_idxs</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">parent_table</span></div>


    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_tree_leaves</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">root</span><span class="p">,</span> <span class="n">tree</span><span class="p">):</span>

        <span class="c1"># traverse the tree away from the root node until a branch point</span>
        <span class="c1"># is found then iterate over the subtrees from there and</span>
        <span class="c1"># recursively call this function on them</span>
        <span class="n">branch_child_nodes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">curr_node</span> <span class="o">=</span> <span class="n">root</span>
        <span class="n">leaves</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">leaf_found</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">while</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">branch_child_nodes</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">leaf_found</span><span class="p">):</span>

            <span class="c1"># get the child nodes</span>
            <span class="n">child_nodes</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">tree</span><span class="o">.</span><span class="n">adj</span><span class="p">[</span><span class="n">curr_node</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

            <span class="c1"># if there is more than one child node, the current node is a</span>
            <span class="c1"># branch node</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">child_nodes</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>

                <span class="c1"># we will use the branch child nodes as the roots of the</span>
                <span class="c1"># next recursion level</span>
                <span class="n">branch_child_nodes</span> <span class="o">=</span> <span class="n">child_nodes</span>

            <span class="c1"># if there are no children then this is a leaf node</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">child_nodes</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># set the current node as the only leaf</span>
                <span class="n">leaves</span> <span class="o">=</span> <span class="p">[</span><span class="n">curr_node</span><span class="p">]</span>

                <span class="c1"># and break out of the loop</span>
                <span class="n">leaf_found</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="c1"># otherwise reset the current node</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># there will only be one child node</span>
                <span class="n">curr_node</span> <span class="o">=</span> <span class="n">child_nodes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># this will run if any child nodes were found to find more leaves,</span>
        <span class="c1"># which won&#39;t happen when the loop ended upon finding a leaf node</span>
        <span class="k">for</span> <span class="n">branch_child_node</span> <span class="ow">in</span> <span class="n">branch_child_nodes</span><span class="p">:</span>
            <span class="n">branch_leaves</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_tree_leaves</span><span class="p">(</span><span class="n">branch_child_node</span><span class="p">,</span> <span class="n">tree</span><span class="p">)</span>
            <span class="n">leaves</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">branch_leaves</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">leaves</span>

    <span class="k">def</span> <span class="nf">_subtree_leaves</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">root</span><span class="p">):</span>

        <span class="c1"># get the subtree given the root</span>
        <span class="n">subtree</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_subtree</span><span class="p">(</span><span class="n">root</span><span class="p">)</span>

        <span class="c1"># get the reversed directions of the cycle tree as a view, we</span>
        <span class="c1"># don&#39;t need a copy</span>
        <span class="n">rev_tree</span> <span class="o">=</span> <span class="n">subtree</span><span class="o">.</span><span class="n">reverse</span><span class="p">(</span><span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># then we use the adjacencies to find the last node in the network</span>
        <span class="c1"># using a recursive algorithm</span>
        <span class="n">leaves</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tree_leaves</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">rev_tree</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">leaves</span>

<div class="viewcode-block" id="ContigTree.leaves"><a class="viewcode-back" href="../../../api/wepy.analysis.html#wepy.analysis.contig_tree.ContigTree.leaves">[docs]</a>    <span class="k">def</span> <span class="nf">leaves</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;All of the leaves of the contig forest&quot;&quot;&quot;</span>
        <span class="n">leaves</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">root</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">roots</span><span class="p">():</span>
            <span class="n">subtree_leaves</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_subtree_leaves</span><span class="p">(</span><span class="n">root</span><span class="p">)</span>
            <span class="n">leaves</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">subtree_leaves</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">leaves</span></div>

    <span class="k">def</span> <span class="nf">_subtree_root</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Given a node find the root of the tree it is on&quot;&quot;&quot;</span>

        <span class="n">curr_node</span> <span class="o">=</span> <span class="n">node</span>

        <span class="c1"># we also get the adjacent nodes for this node</span>
        <span class="n">adj_nodes</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">adj</span><span class="p">[</span><span class="n">curr_node</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

        <span class="c1"># there should only be one node in the dict</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">adj_nodes</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;There should be at most 1 edge&quot;</span>

        <span class="c1"># then we use this node as the starting point to move back to the</span>
        <span class="c1"># root, we end when there is no adjacent node</span>
        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">adj_nodes</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>

            <span class="c1"># we take another step backwards, and choose the node in the</span>
            <span class="c1"># adjacency</span>
            <span class="n">adj_nodes</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">adj</span><span class="p">[</span><span class="n">curr_node</span><span class="p">])</span>

            <span class="c1"># there should only be 1 or none nodes</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">adj_nodes</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;There should be at most 1 edge&quot;</span>

            <span class="c1"># and reset the current node</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">curr_node</span> <span class="o">=</span> <span class="n">adj_nodes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                <span class="c1"># this happens when this is the last node, inelegant apologies</span>
                <span class="k">pass</span>

        <span class="k">return</span> <span class="n">curr_node</span>

<div class="viewcode-block" id="ContigTree.roots"><a class="viewcode-back" href="../../../api/wepy.analysis.html#wepy.analysis.contig_tree.ContigTree.roots">[docs]</a>    <span class="k">def</span> <span class="nf">roots</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">subtree_roots</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">subtree</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">subtrees</span><span class="p">():</span>
            <span class="c1"># use a node from the subtree to get the root</span>
            <span class="n">node</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">subtree</span><span class="o">.</span><span class="n">adjacency</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">subtree_root</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_subtree_root</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
            <span class="n">subtree_roots</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">subtree_root</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">subtree_roots</span></div>

<div class="viewcode-block" id="ContigTree.subtrees"><a class="viewcode-back" href="../../../api/wepy.analysis.html#wepy.analysis.contig_tree.ContigTree.subtrees">[docs]</a>    <span class="k">def</span> <span class="nf">subtrees</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">subtree_nxs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">component_nodes</span> <span class="ow">in</span> <span class="n">nx</span><span class="o">.</span><span class="n">weakly_connected_components</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="p">):</span>

            <span class="c1"># actually get the subtree from the main tree</span>
            <span class="n">subtree</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">subgraph</span><span class="p">(</span><span class="n">component_nodes</span><span class="p">)</span>

            <span class="n">subtree_nxs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">subtree</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">subtree_nxs</span></div>

<div class="viewcode-block" id="ContigTree.get_subtree"><a class="viewcode-back" href="../../../api/wepy.analysis.html#wepy.analysis.contig_tree.ContigTree.get_subtree">[docs]</a>    <span class="k">def</span> <span class="nf">get_subtree</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>

        <span class="c1"># get all the subtrees</span>
        <span class="n">subtrees</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subtrees</span><span class="p">()</span>

        <span class="c1"># see which tree the node is in</span>
        <span class="k">for</span> <span class="n">subtree</span> <span class="ow">in</span> <span class="n">subtrees</span><span class="p">:</span>

            <span class="c1"># if the node is in it this is the subtree it is in so</span>
            <span class="c1"># just return it</span>
            <span class="k">if</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">subtree</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">subtree</span></div>

<div class="viewcode-block" id="ContigTree.contig_sliding_windows"><a class="viewcode-back" href="../../../api/wepy.analysis.html#wepy.analysis.contig_tree.ContigTree.contig_sliding_windows">[docs]</a>    <span class="k">def</span> <span class="nf">contig_sliding_windows</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">contig_trace</span><span class="p">,</span> <span class="n">window_length</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Given a contig trace (run_idx, cycle_idx) get the sliding windows</span>
<span class="sd">        over it (traj_idx, cycle_idx).&quot;&quot;&quot;</span>

        <span class="c1"># make a parent table for the contig trace</span>
        <span class="n">parent_table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trace_parent_table</span><span class="p">(</span><span class="n">contig_trace</span><span class="p">)</span>

        <span class="c1"># this gives you windows of trace elements (traj_idx, cycle_idx)</span>
        <span class="n">windows</span> <span class="o">=</span> <span class="n">sliding_window</span><span class="p">(</span><span class="n">parent_table</span><span class="p">,</span> <span class="n">window_length</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">windows</span></div>

<div class="viewcode-block" id="ContigTree.sliding_contig_windows"><a class="viewcode-back" href="../../../api/wepy.analysis.html#wepy.analysis.contig_tree.ContigTree.sliding_contig_windows">[docs]</a>    <span class="k">def</span> <span class="nf">sliding_contig_windows</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">window_length</span><span class="p">):</span>

        <span class="k">assert</span> <span class="n">window_length</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;window length must be greater than one&quot;</span>

        <span class="c1"># we can deal with each tree in this forest of trees separately,</span>
        <span class="c1"># that is runs that are not connected</span>
        <span class="n">contig_windows</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">root</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">roots</span><span class="p">():</span>

            <span class="c1"># get the contig windows for the individual tree</span>
            <span class="n">subtree_contig_windows</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_subtree_sliding_contig_windows</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">window_length</span><span class="p">)</span>

            <span class="n">contig_windows</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">subtree_contig_windows</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">contig_windows</span></div>

    <span class="k">def</span> <span class="nf">_subtree_sliding_contig_windows</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subtree_root</span><span class="p">,</span> <span class="n">window_length</span><span class="p">):</span>

        <span class="c1"># to generate all the sliding windows over a connected cycle tree</span>
        <span class="c1"># it is useful to think of it as a braid, since within this tree</span>
        <span class="c1"># there is a forest of trees which are the lineages of the</span>
        <span class="c1"># walkers. To simplify things we can first generate window traces</span>
        <span class="c1"># over the cycle tree (ignoring the fine structure of the walkers),</span>
        <span class="c1"># which is a very similar process as to the original process of</span>
        <span class="c1"># the sliding windows over trees, and then treat each window trace</span>
        <span class="c1"># as it&#39;s own parent table, which can then be treated using the</span>
        <span class="c1"># original sliding window algorithm. As long as the correct contig</span>
        <span class="c1"># traces are generated this will be no problem, and all that is</span>
        <span class="c1"># left is to translate the cycle idxs properly such that the</span>
        <span class="c1"># windows generated are inter-run traces i.e. lists of tuples of</span>
        <span class="c1"># the form (run_idx, traj_idx, cycle_idx) where traj_idx and</span>
        <span class="c1"># cycle_idx are internal to the run specified by run_idx.</span>

        <span class="c1"># so we want to construct a list of contig windows, which are</span>
        <span class="c1"># traces with components (run_idx, cycle_idx)</span>
        <span class="n">contig_windows</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># to do this we start at the leaves of the cycle tree, but first</span>
        <span class="c1"># we have to find them. The cycle tree should be directed with</span>
        <span class="c1"># edges pointing towards parents. Since we are working with a</span>
        <span class="c1"># single tree, we have a single root and we can just reverse the</span>
        <span class="c1"># directions of the edges and recursively walk the tree until we</span>
        <span class="c1"># find nodes with no adjacent edges</span>

        <span class="c1"># first we need to find the leaves for this subtree</span>
        <span class="n">leaves</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_subtree_leaves</span><span class="p">(</span><span class="n">subtree_root</span><span class="p">)</span>

        <span class="c1"># now we use these leaves to move backwards in the tree with the</span>
        <span class="c1"># window length to get contiguous segments</span>
        <span class="n">contig_windows</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># starting with the leaf nodes we generate contig trace windows</span>
        <span class="c1"># until the last nodes are the same as other windows from other</span>
        <span class="c1"># leaves, i.e. until a branch point has been arrived at between 2</span>
        <span class="c1"># or more leaf branches. To do this we start at the leaf of the</span>
        <span class="c1"># longest spanning contig and make windows until the endpoint is</span>
        <span class="c1"># no longer the largest contig cycle index. Then we alternate</span>
        <span class="c1"># between them until we find they have converged</span>

        <span class="c1"># initialize the list of active branches all going back to the</span>
        <span class="c1"># root</span>
        <span class="n">branch_contigs</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">get_branch_trace</span><span class="p">(</span><span class="o">*</span><span class="n">leaf</span><span class="p">)</span> <span class="k">for</span> <span class="n">leaf</span> <span class="ow">in</span> <span class="n">leaves</span><span class="p">]</span>

        <span class="n">done</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="n">done</span><span class="p">:</span>

            <span class="c1"># make a window for the largest endpoint, no need to break</span>
            <span class="c1"># ties since the next iteration will get it</span>
            <span class="n">contig_lengths</span> <span class="o">=</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">contig</span><span class="p">)</span> <span class="k">for</span> <span class="n">contig</span> <span class="ow">in</span> <span class="n">branch_contigs</span><span class="p">]</span>
            <span class="n">longest_branch_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">contig_lengths</span><span class="p">)</span>

            <span class="c1"># if the branch is not long enough for the window we end this</span>
            <span class="c1"># process</span>
            <span class="k">if</span> <span class="n">window_length</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">branch_contigs</span><span class="p">[</span><span class="n">longest_branch_idx</span><span class="p">]):</span>
                <span class="n">done</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="c1"># otherwise we get the next window and do the other processing</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># get the next window for this branch</span>
                <span class="n">window</span> <span class="o">=</span> <span class="n">branch_contigs</span><span class="p">[</span><span class="n">longest_branch_idx</span><span class="p">][</span><span class="o">-</span><span class="n">window_length</span><span class="p">:]</span>

                <span class="n">contig_windows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">window</span><span class="p">)</span>

                <span class="c1"># pop the last element off of this branch contig</span>
                <span class="n">last_node</span> <span class="o">=</span> <span class="n">branch_contigs</span><span class="p">[</span><span class="n">longest_branch_idx</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>

                <span class="c1"># if there are any other branches of the same length that have</span>
                <span class="c1"># this as their last node then we have reached a branch point</span>
                <span class="c1"># and that other branch must be eliminated</span>
                <span class="k">for</span> <span class="n">branch_idx</span><span class="p">,</span> <span class="n">branch_contig</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">branch_contigs</span><span class="p">):</span>

                    <span class="c1"># compare the last node in contig and if it is the same as</span>
                    <span class="c1"># the node that was just used as a window end</span>
                    <span class="k">if</span> <span class="n">branch_contig</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">last_node</span><span class="p">:</span>
                        <span class="c1"># this branch is the same so we just get rid of it</span>
                        <span class="n">_</span> <span class="o">=</span> <span class="n">branch_contigs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">branch_idx</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">contig_windows</span>

<div class="viewcode-block" id="ContigTree.sliding_windows"><a class="viewcode-back" href="../../../api/wepy.analysis.html#wepy.analysis.contig_tree.ContigTree.sliding_windows">[docs]</a>    <span class="k">def</span> <span class="nf">sliding_windows</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">window_length</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;All the sliding windows (run_idx, traj_idx, cycle_idx) for all</span>
<span class="sd">        contig windows in the contig tree&quot;&quot;&quot;</span>

        <span class="c1"># get all of the contig traces for these trees</span>
        <span class="n">contig_traces</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sliding_contig_windows</span><span class="p">(</span><span class="n">window_length</span><span class="p">)</span>

        <span class="c1"># for each of these we generate all of the actual frame sliding windows</span>
        <span class="n">windows</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">contig_trace</span> <span class="ow">in</span> <span class="n">contig_traces</span><span class="p">:</span>

            <span class="c1"># these are windows of trace element (traj_idx, cycle_idx)</span>
            <span class="c1"># all over this contig</span>
            <span class="n">contig_windows</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">contig_sliding_windows</span><span class="p">(</span><span class="n">contig_trace</span><span class="p">,</span> <span class="n">window_length</span><span class="p">)</span>

            <span class="c1"># convert those traces to the corresponding (run_idx, traj_idx, cycle_idx)</span>
            <span class="c1"># trace</span>
            <span class="k">for</span> <span class="n">contig_window</span> <span class="ow">in</span> <span class="n">contig_windows</span><span class="p">:</span>
                <span class="n">run_trace_window</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">contig_trace_to_run_trace</span><span class="p">(</span><span class="n">contig_trace</span><span class="p">,</span> <span class="n">contig_window</span><span class="p">)</span>
                <span class="n">windows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">run_trace_window</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">windows</span></div>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_spanning_paths</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">edges</span><span class="p">,</span> <span class="n">root</span><span class="p">):</span>

        <span class="c1"># nodes targetting this root</span>
        <span class="n">root_sources</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># go through all the edges and find those with this</span>
        <span class="c1"># node as their target</span>
        <span class="k">for</span> <span class="n">edge_source</span><span class="p">,</span> <span class="n">edge_target</span> <span class="ow">in</span> <span class="n">edges</span><span class="p">:</span>

            <span class="c1"># check if the target_node we are looking for matches</span>
            <span class="c1"># the edge target node</span>
            <span class="k">if</span> <span class="n">root</span> <span class="o">==</span> <span class="n">edge_target</span><span class="p">:</span>

                <span class="c1"># if this root is a target of the source add it to the</span>
                <span class="c1"># list of edges targetting this root</span>
                <span class="n">root_sources</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">edge_source</span><span class="p">)</span>

        <span class="c1"># from the list of source nodes targetting this root we choose</span>
        <span class="c1"># the lowest index one, so we sort them and iterate through</span>
        <span class="c1"># finding the paths starting from it recursively</span>
        <span class="n">root_paths</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">root_sources</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">new_root</span> <span class="ow">in</span> <span class="n">root_sources</span><span class="p">:</span>

            <span class="c1"># add these paths for this new root to the paths for the</span>
            <span class="c1"># current root</span>
            <span class="n">root_paths</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">_spanning_paths</span><span class="p">(</span><span class="n">edges</span><span class="p">,</span> <span class="n">new_root</span><span class="p">))</span>

        <span class="c1"># if there are no more sources to this root it is a leaf node and</span>
        <span class="c1"># we terminate recursion, by not entering the loop above, however</span>
        <span class="c1"># we manually generate an empty list for a path so that we return</span>
        <span class="c1"># this &quot;root&quot; node as a leaf, for default.</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">root_paths</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">root_paths</span> <span class="o">=</span> <span class="p">[[]]</span>

        <span class="n">final_root_paths</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">root_path</span> <span class="ow">in</span> <span class="n">root_paths</span><span class="p">:</span>
            <span class="n">final_root_paths</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">root</span><span class="p">]</span> <span class="o">+</span> <span class="n">root_path</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">final_root_paths</span>

<div class="viewcode-block" id="ContigTree.spanning_contig_traces"><a class="viewcode-back" href="../../../api/wepy.analysis.html#wepy.analysis.contig_tree.ContigTree.spanning_contig_traces">[docs]</a>    <span class="k">def</span> <span class="nf">spanning_contig_traces</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns a list of all possible spanning contigs given the</span>
<span class="sd">        continuations present in this file. Contigs are a list of runs</span>
<span class="sd">        in the order that makes a continuous set of data. Spanning</span>
<span class="sd">        contigs are always as long as possible, thus all must start</span>
<span class="sd">        from a root and end at a leaf node.</span>

<span class="sd">        This algorithm always returns them in a canonical order (as</span>
<span class="sd">        long as the runs are not rearranged after being added). This</span>
<span class="sd">        means that the indices here are the indices of the contigs.</span>

<span class="sd">        Contigs can in general are any such path drawn from what we</span>
<span class="sd">        call the &quot;contig tree&quot; which is the tree (or forest of trees)</span>
<span class="sd">        generated by the directed edges of the &#39;continuations&#39;. They</span>
<span class="sd">        needn&#39;t be spanning from root to leaf.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">spanning_contig_traces</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># roots should be sorted already, so we just iterate over them</span>
        <span class="k">for</span> <span class="n">root</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">roots</span><span class="p">():</span>

            <span class="c1"># get the spanning paths by passing the continuation edges</span>
            <span class="c1"># and this root to this recursive static method</span>
            <span class="n">root_spanning_contigs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_spanning_paths</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">edges</span><span class="p">,</span> <span class="n">root</span><span class="p">)</span>

            <span class="n">spanning_contig_traces</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">root_spanning_contigs</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">spanning_contig_traces</span></div>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_contig_trace_to_contig_runs</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">contig_trace</span><span class="p">):</span>

        <span class="n">contig_runs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">run_idx</span><span class="p">,</span> <span class="n">cycle_idx</span> <span class="ow">in</span> <span class="n">contig_trace</span><span class="p">:</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">run_idx</span> <span class="ow">in</span> <span class="n">contig_runs</span><span class="p">:</span>
                <span class="n">contig_runs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">run_idx</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">pass</span>

        <span class="k">return</span> <span class="n">contig_runs</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_contig_runs_to_continuations</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">contig_runs</span><span class="p">):</span>

        <span class="n">continuations</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">contig_runs</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">continuations</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">contig_runs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">contig_runs</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]])</span>

        <span class="k">return</span> <span class="n">continuations</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_continuations_to_contig_runs</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">continuations</span><span class="p">):</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">continuations</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>

        <span class="n">continuations</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">copy</span><span class="p">(</span><span class="n">continuations</span><span class="p">))</span>
        <span class="n">continuations</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>

        <span class="n">contig_runs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">next_run</span><span class="p">,</span> <span class="n">continued_run</span> <span class="ow">in</span> <span class="n">continuations</span><span class="p">:</span>
            <span class="n">contig_runs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">continued_run</span><span class="p">)</span>

        <span class="n">contig_runs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">continuations</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>


        <span class="c1"># since this is only valid if the continuations don&#39;t form a</span>
        <span class="c1"># tree check that we didn&#39;t put the same number in twice,</span>
        <span class="c1"># which this would indicate, fail if true</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">contig_runs</span><span class="p">))</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">contig_runs</span><span class="p">),</span> \
            <span class="s2">&quot;this is not a single contig&quot;</span>

        <span class="k">return</span> <span class="n">contig_runs</span>

<div class="viewcode-block" id="ContigTree.make_contig"><a class="viewcode-back" href="../../../api/wepy.analysis.html#wepy.analysis.contig_tree.ContigTree.make_contig">[docs]</a>    <span class="k">def</span> <span class="nf">make_contig</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">contig_trace</span><span class="p">):</span>

        <span class="c1"># get the runs and continuations for just this contig</span>

        <span class="c1"># get the contig as the sequence of run idxs</span>
        <span class="n">contig_runs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_contig_trace_to_contig_runs</span><span class="p">(</span><span class="n">contig_trace</span><span class="p">)</span>

        <span class="c1"># then convert to continuations</span>
        <span class="n">continuations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_contig_runs_to_continuations</span><span class="p">(</span><span class="n">contig_runs</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">Contig</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wepy_h5</span><span class="p">,</span>
                      <span class="n">runs</span><span class="o">=</span><span class="n">contig_runs</span><span class="p">,</span>
                      <span class="n">continuations</span><span class="o">=</span><span class="n">continuations</span><span class="p">,</span>
                      <span class="n">boundary_condition_class</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">boundary_condition_class</span><span class="p">,</span>
                      <span class="n">decision_class</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">decision_class</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="Contig"><a class="viewcode-back" href="../../../api/wepy.analysis.html#wepy.analysis.contig_tree.Contig">[docs]</a><span class="k">class</span> <span class="nc">Contig</span><span class="p">(</span><span class="n">ContigTree</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">wepy_h5</span><span class="p">,</span>
                 <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

        <span class="c1"># use the superclass initialization</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">wepy_h5</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># check that the result is a single contig</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spanning_contig_traces</span><span class="p">())</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> \
            <span class="s2">&quot;continuations given do not form a single contig&quot;</span>

        <span class="c1"># if so we add some useful attributes valid for only a</span>
        <span class="c1"># standalone contig</span>

        <span class="c1"># the contig_trace</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_contig_trace</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spanning_contig_traces</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># TODO this should not be part of the API in the future since</span>
        <span class="c1"># we don&#39;t want to have the run_idxs alone be how contigs are</span>
        <span class="c1"># defined (since we want contigs to be able to go to different</span>
        <span class="c1"># runs from the middle of other runs), in any case that is how</span>
        <span class="c1"># it is implemented now and there is no reason to change it</span>
        <span class="c1"># now, so we keep it hidden</span>

        <span class="c1"># the run idxs of the contig</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">contig_trace</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_contig_run_idxs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_continuations_to_contig_runs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">continuations</span><span class="p">)</span>
        <span class="c1"># if there is only 1 run we set it like this</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_contig_run_idxs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">run_idxs</span><span class="p">)</span>


    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">contig_trace</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_contig_trace</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">n_cycles</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">contig_trace</span><span class="p">)</span>


<div class="viewcode-block" id="Contig.contig_fields"><a class="viewcode-back" href="../../../api/wepy.analysis.html#wepy.analysis.contig_tree.Contig.contig_fields">[docs]</a>    <span class="k">def</span> <span class="nf">contig_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fields</span><span class="p">):</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">wepy_h5</span><span class="o">.</span><span class="n">get_contig_trace_fields</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">contig_trace</span><span class="p">,</span> <span class="n">fields</span><span class="p">)</span></div>

<div class="viewcode-block" id="Contig.records"><a class="viewcode-back" href="../../../api/wepy.analysis.html#wepy.analysis.contig_tree.Contig.records">[docs]</a>    <span class="k">def</span> <span class="nf">records</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">record_key</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">wepy_h5</span><span class="o">.</span><span class="n">contig_records</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_contig_run_idxs</span><span class="p">,</span> <span class="n">record_key</span><span class="p">)</span></div>

<div class="viewcode-block" id="Contig.records_dataframe"><a class="viewcode-back" href="../../../api/wepy.analysis.html#wepy.analysis.contig_tree.Contig.records_dataframe">[docs]</a>    <span class="k">def</span> <span class="nf">records_dataframe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">record_key</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">wepy_h5</span><span class="o">.</span><span class="n">contig_records_dataframe</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_contig_run_idxs</span><span class="p">,</span> <span class="n">record_key</span><span class="p">)</span></div>

    <span class="c1"># resampling</span>
<div class="viewcode-block" id="Contig.resampling_records"><a class="viewcode-back" href="../../../api/wepy.analysis.html#wepy.analysis.contig_tree.Contig.resampling_records">[docs]</a>    <span class="k">def</span> <span class="nf">resampling_records</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">records</span><span class="p">(</span><span class="n">RESAMPLING</span><span class="p">)</span></div>

<div class="viewcode-block" id="Contig.resampling_records_dataframe"><a class="viewcode-back" href="../../../api/wepy.analysis.html#wepy.analysis.contig_tree.Contig.resampling_records_dataframe">[docs]</a>    <span class="k">def</span> <span class="nf">resampling_records_dataframe</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">resampling_records</span><span class="p">())</span></div>

    <span class="c1"># resampler records</span>
<div class="viewcode-block" id="Contig.resampler_records"><a class="viewcode-back" href="../../../api/wepy.analysis.html#wepy.analysis.contig_tree.Contig.resampler_records">[docs]</a>    <span class="k">def</span> <span class="nf">resampler_records</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">records</span><span class="p">(</span><span class="n">RESAMPLER</span><span class="p">)</span></div>

<div class="viewcode-block" id="Contig.resampler_records_dataframe"><a class="viewcode-back" href="../../../api/wepy.analysis.html#wepy.analysis.contig_tree.Contig.resampler_records_dataframe">[docs]</a>    <span class="k">def</span> <span class="nf">resampler_records_dataframe</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">resampler_records</span><span class="p">())</span></div>

    <span class="c1"># warping</span>
<div class="viewcode-block" id="Contig.warping_records"><a class="viewcode-back" href="../../../api/wepy.analysis.html#wepy.analysis.contig_tree.Contig.warping_records">[docs]</a>    <span class="k">def</span> <span class="nf">warping_records</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">records</span><span class="p">(</span><span class="n">WARPING</span><span class="p">)</span></div>

<div class="viewcode-block" id="Contig.warping_records_dataframe"><a class="viewcode-back" href="../../../api/wepy.analysis.html#wepy.analysis.contig_tree.Contig.warping_records_dataframe">[docs]</a>    <span class="k">def</span> <span class="nf">warping_records_dataframe</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">warping_records</span><span class="p">())</span></div>

    <span class="c1"># boundary conditions</span>
<div class="viewcode-block" id="Contig.bc_records"><a class="viewcode-back" href="../../../api/wepy.analysis.html#wepy.analysis.contig_tree.Contig.bc_records">[docs]</a>    <span class="k">def</span> <span class="nf">bc_records</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">records</span><span class="p">(</span><span class="n">BC</span><span class="p">)</span></div>

<div class="viewcode-block" id="Contig.bc_records_dataframe"><a class="viewcode-back" href="../../../api/wepy.analysis.html#wepy.analysis.contig_tree.Contig.bc_records_dataframe">[docs]</a>    <span class="k">def</span> <span class="nf">bc_records_dataframe</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bc_records</span><span class="p">())</span></div>

    <span class="c1"># progress</span>
<div class="viewcode-block" id="Contig.progress_records"><a class="viewcode-back" href="../../../api/wepy.analysis.html#wepy.analysis.contig_tree.Contig.progress_records">[docs]</a>    <span class="k">def</span> <span class="nf">progress_records</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">records</span><span class="p">(</span><span class="n">PROGRESS</span><span class="p">)</span></div>

<div class="viewcode-block" id="Contig.progress_records_dataframe"><a class="viewcode-back" href="../../../api/wepy.analysis.html#wepy.analysis.contig_tree.Contig.progress_records_dataframe">[docs]</a>    <span class="k">def</span> <span class="nf">progress_records_dataframe</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">progress_records</span><span class="p">())</span></div>


    <span class="c1"># resampling panel</span>
<div class="viewcode-block" id="Contig.resampling_panel"><a class="viewcode-back" href="../../../api/wepy.analysis.html#wepy.analysis.contig_tree.Contig.resampling_panel">[docs]</a>    <span class="k">def</span> <span class="nf">resampling_panel</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">wepy_h5</span><span class="o">.</span><span class="n">contig_resampling_panel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_contig_run_idxs</span><span class="p">)</span></div>


<div class="viewcode-block" id="Contig.parent_table"><a class="viewcode-back" href="../../../api/wepy.analysis.html#wepy.analysis.contig_tree.Contig.parent_table">[docs]</a>    <span class="k">def</span> <span class="nf">parent_table</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">trace_parent_table</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">contig_trace</span><span class="p">)</span></div></div>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../index.html">wepy</a></h1>








<h3>Navigation</h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../source/explanation.html">Explanation of Wepy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../source/glossary.html">Glossary</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/index.html">Module Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorials/index.html">Tutorials</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../index.html">Documentation overview</a><ul>
  <li><a href="../../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2018, Samuel D. Lotz.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.8.2</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>