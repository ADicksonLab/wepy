
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
  
  <!-- Licensed under the Apache 2.0 License -->
  <link rel="stylesheet" type="text/css" href="../_static/fonts/open-sans/stylesheet.css" />
  <!-- Licensed under the SIL Open Font License -->
  <link rel="stylesheet" type="text/css" href="../_static/fonts/source-serif-pro/source-serif-pro.css" />
  <link rel="stylesheet" type="text/css" href="../_static/css/bootstrap.min.css" />
  <link rel="stylesheet" type="text/css" href="../_static/css/bootstrap-theme.min.css" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
    <title>Development Setup &#8212; wepy  documentation</title>
    <link rel="stylesheet" href="../_static/guzzle.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="../_static/language_data.js"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true, "ignoreClass": "document", "processClass": "math|output_area"}})</script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Glossary" href="glossary.html" />
    <link rel="prev" title="Common Troubleshooting" href="troubleshooting.html" />
  
   

  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="glossary.html" title="Glossary"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="troubleshooting.html" title="Common Troubleshooting"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">wepy  documentation</a> &#187;</li> 
      </ul>
    </div>
    <div class="container-wrapper">

      <div id="mobile-toggle">
        <a href="#"><span class="glyphicon glyphicon-align-justify" aria-hidden="true"></span></a>
      </div>
  <div id="left-column">
    <div class="sphinxsidebar">
<div class="sidebar-block">
  <div class="sidebar-wrapper">
    <h2>Contents</h2>
    <div class="sidebar-localtoc">
      <ul>
<li><a class="reference internal" href="#">Development Setup</a><ul>
<li><a class="reference internal" href="#releasing-package">Releasing Package</a><ul>
<li><a class="reference internal" href="#test-the-installation-process">Test the installation process</a></li>
<li><a class="reference internal" href="#update-versions">Update versions</a></li>
<li><a class="reference internal" href="#deploying">Deploying</a></li>
</ul>
</li>
<li><a class="reference internal" href="#building-docs">Building Docs</a></li>
<li><a class="reference internal" href="#deploying-docs">Deploying Docs</a></li>
<li><a class="reference internal" href="#testing">Testing</a><ul>
<li><a class="reference internal" href="#getting-the-wepy-tests-submodule">Getting the wepy-tests submodule</a></li>
<li><a class="reference internal" href="#test-suite">Test Suite</a></li>
<li><a class="reference internal" href="#code-quality">Code Quality</a></li>
<li><a class="reference internal" href="#profiling">Profiling</a></li>
<li><a class="reference internal" href="#testing-examples-and-tutorials">Testing examples and tutorials</a></li>
<li><a class="reference internal" href="#writing-tests">Writing Tests</a></li>
</ul>
</li>
<li><a class="reference internal" href="#contributing">Contributing</a></li>
</ul>
</li>
<li><a class="reference internal" href="#architecture">Architecture</a><ul>
<li><a class="reference internal" href="#record-groups">Record Groups</a><ul>
<li><a class="reference internal" href="#specifying-record-group-fields">Specifying Record Group Fields</a></li>
<li><a class="reference internal" href="#record-fields">Record Fields</a></li>
</ul>
</li>
</ul>
</li>
</ul>

    </div>
  </div>
</div>
  <h4>Previous topic</h4>
  <p class="topless"><a href="troubleshooting.html"
                        title="previous chapter">Common Troubleshooting</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="glossary.html"
                        title="next chapter">Glossary</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/source/dev_guide.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div class="sidebar-block">
  <div class="sidebar-wrapper">
    <div id="main-search">
      <form class="form-inline" action="../search.html" method="GET" role="form">
        <div class="input-group">
          <input name="q" type="text" class="form-control" placeholder="Search...">
        </div>
        <input type="hidden" name="check_keywords" value="yes" />
        <input type="hidden" name="area" value="default" />
      </form>
    </div>
  </div>
</div>
      
    </div>
  </div>
        <div id="right-column">
          
          <div role="navigation" aria-label="breadcrumbs navigation">
            <ol class="breadcrumb">
              <li><a href="../index.html">Docs</a></li>
              
              <li>Development Setup</li>
            </ol>
          </div>
          
          <div class="document clearer body">
            
  <div class="section" id="development-setup">
<h1>Development Setup<a class="headerlink" href="#development-setup" title="Permalink to this headline">¶</a></h1>
<p>Get the source code:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>git clone https://github.com/ADicksonLab/wepy --recurse-submodules
<span class="nb">cd</span> wepy
</pre></div>
</div>
<p>Install a virtual environment for it:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>wepy_dev_env_refresh <span class="o">()</span> <span class="o">{</span>

    <span class="nv">package</span><span class="o">=</span><span class="s1">&#39;wepy&#39;</span>
    conda deactivate
    <span class="nv">dev_env</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">package</span><span class="si">}</span><span class="s2">-dev&quot;</span>
    conda env remove -y -n <span class="s2">&quot;</span><span class="nv">$dev_env</span><span class="s2">&quot;</span>
    conda create -y -n <span class="s2">&quot;</span><span class="nv">$dev_env</span><span class="s2">&quot;</span> <span class="nv">python</span><span class="o">=</span><span class="m">3</span>
    conda activate <span class="s2">&quot;</span><span class="nv">$dev_env</span><span class="s2">&quot;</span>

    <span class="c1"># we need openmm but can&#39;t get it from pip</span>
    conda install -y -c omnia openmm openmmtools

    <span class="c1"># install in editable mode, we need to avoid using pep517 which</span>
    <span class="c1"># doesn&#39;t allow editable installs</span>
    pip install -r requirements_dev.txt
    pip install --no-use-pep517 -e .<span class="o">[</span>all<span class="o">]</span>

<span class="o">}</span>
</pre></div>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>wepy_dev_env_refresh
</pre></div>
</div>
<p>Currently, for installing mdtraj we use a forked repository which
handles pip installations better that allows for seamless dependecy
resolution and doesn’t require manual intervention to install cython.</p>
<p>This is specified in the requirements.txt file which should be used for
specifying the “concrete” requirements of the project (i.e. the literal
repo or index URL that packages should be retrieved from).</p>
<p>“Abstract” requirements should also be listed in setup.py.</p>
<p>For development specific requirements, we have the separate
requirements<sub>dev</sub>.txt.</p>
<p>Because at this multiple packages are developed simultaneously we
require that geomm be installed in the same directory as wepy for using
the dev requirements.</p>
<div class="section" id="releasing-package">
<h2>Releasing Package<a class="headerlink" href="#releasing-package" title="Permalink to this headline">¶</a></h2>
<div class="section" id="test-the-installation-process">
<h3>Test the installation process<a class="headerlink" href="#test-the-installation-process" title="Permalink to this headline">¶</a></h3>
<p>Functions for doing this:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>wepy_test_build <span class="o">()</span> <span class="o">{</span>
    <span class="nv">package</span><span class="o">=</span><span class="s1">&#39;wepy&#39;</span>
    <span class="nv">build_env</span><span class="o">=</span><span class="s2">&quot;test-</span><span class="si">${</span><span class="nv">package</span><span class="si">}</span><span class="s2">-build&quot;</span>
    conda deactivate
    conda env remove -y -n <span class="s2">&quot;</span><span class="nv">$build_env</span><span class="s2">&quot;</span>
    conda create -y -n <span class="s2">&quot;</span><span class="nv">$build_env</span><span class="s2">&quot;</span> <span class="nv">python</span><span class="o">=</span><span class="m">3</span>
    conda activate <span class="s2">&quot;</span><span class="nv">$build_env</span><span class="s2">&quot;</span>
    pip install -r requirements_dev.txt
    rm -rf dist/*
    python setup.py build sdist
    conda deactivate
    conda env remove -y -n <span class="s2">&quot;</span><span class="nv">$build_env</span><span class="s2">&quot;</span>

<span class="o">}</span>

wepy_test_install <span class="o">()</span> <span class="o">{</span>

    <span class="nv">package</span><span class="o">=</span><span class="s1">&#39;wepy&#39;</span>
    conda deactivate
    <span class="nv">install_env</span><span class="o">=</span><span class="s2">&quot;test-</span><span class="si">${</span><span class="nv">package</span><span class="si">}</span><span class="s2">-install&quot;</span>
    conda env remove -y -n <span class="s2">&quot;</span><span class="nv">$install_env</span><span class="s2">&quot;</span>
    conda create -y -n <span class="s2">&quot;</span><span class="nv">$install_env</span><span class="s2">&quot;</span> <span class="nv">python</span><span class="o">=</span><span class="m">3</span>
    conda activate <span class="s2">&quot;</span><span class="nv">$install_env</span><span class="s2">&quot;</span>
    pip install dist/<span class="s2">&quot;</span><span class="nv">$package</span><span class="s2">&quot;</span>-*.tar.gz
    conda deactivate
    conda env remove -y -n <span class="s2">&quot;</span><span class="nv">$install_env</span><span class="s2">&quot;</span>

<span class="o">}</span>
</pre></div>
</div>
</div>
<div class="section" id="update-versions">
<h3>Update versions<a class="headerlink" href="#update-versions" title="Permalink to this headline">¶</a></h3>
<p>Before we build the package we need to bump the version in all those
places it is written down at, which is achieved with the bumpversion
tool:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>bumpversion patch <span class="c1"># possible: major / minor / patch</span>
</pre></div>
</div>
<p>Make sure to tag in git (I typically use magit in emacs but the command
is):</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>git tag -a vX.Y.Z -m <span class="s2">&quot;release message&quot;</span>
git push gitlab vX.Y.Z
</pre></div>
</div>
</div>
<div class="section" id="deploying">
<h3>Deploying<a class="headerlink" href="#deploying" title="Permalink to this headline">¶</a></h3>
<p>To deploy to PyPI (if you have access)</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>conda activate wepy-dev
rm -rf dist/*
python setup.py sdist
twine upload dist/*
</pre></div>
</div>
</div>
</div>
<div class="section" id="building-docs">
<h2>Building Docs<a class="headerlink" href="#building-docs" title="Permalink to this headline">¶</a></h2>
<p>Install pandoc for converting org-mode files to rst.</p>
<p>You can follow the instructions on the site or just use anaconda:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>conda install pandoc
</pre></div>
</div>
<p>Then run the build script. This uses the make file and additionally runs
api-doc, and converts org-mode source files to rst using pandoc.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">pushd</span> sphinx
chmod u+x build.sh
./build.sh
<span class="nb">popd</span>
</pre></div>
</div>
<p>This will build the HTML files in the <code class="docutils literal notranslate"><span class="pre">sphinx/_build/html</span></code> directory
and if you point your web browser there you can view them.</p>
</div>
<div class="section" id="deploying-docs">
<h2>Deploying Docs<a class="headerlink" href="#deploying-docs" title="Permalink to this headline">¶</a></h2>
<p>To run the current deployments of the docs run the deploy script:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">pushd</span> sphinx
chmod u+x deploy.sh
./deploy.sh
<span class="nb">popd</span>
</pre></div>
</div>
<p>Currently we are using github pages, and to avoid putting the build
artifacts of the website into the master development branch we are using
the gh-pages branch.</p>
<p>To make this work you need to pull the gh-pages branch:</p>
</div>
<div class="section" id="testing">
<h2>Testing<a class="headerlink" href="#testing" title="Permalink to this headline">¶</a></h2>
<div class="section" id="getting-the-wepy-tests-submodule">
<h3>Getting the wepy-tests submodule<a class="headerlink" href="#getting-the-wepy-tests-submodule" title="Permalink to this headline">¶</a></h3>
<p>The tests for wepy are included as a submodule because some of the
associated data is large and we want to make the install base for the
program smaller than that. Development of this is tracked in
<a class="reference external" href="https://gitlab.com/salotz/wepy-tests">https://gitlab.com/salotz/wepy-tests</a>.</p>
<p>If you cloned without the recurse-submodules flag you can always pull
them in later like this:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>git submodule update --init --recursive
</pre></div>
</div>
<p>WARNING: before you start editing the <code class="docutils literal notranslate"><span class="pre">wepy-tests</span></code> submodule you need
to check out master.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>git checkout master
</pre></div>
</div>
<p>How many times I have edited it before I checked out master…</p>
<p>If you do edit and commit try to get the hash of the commit and then
merge with master. If you don’t then you need to figure out which commit
that was.</p>
</div>
<div class="section" id="test-suite">
<h3>Test Suite<a class="headerlink" href="#test-suite" title="Permalink to this headline">¶</a></h3>
<p>We are using pytest so just run that from the main directory:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>pytest
</pre></div>
</div>
<p>We use a special marker for interacting with test fixtures. We find this
more useful in many cases where you just want to spin up a test fixture
with the newest changes and inspect it, perhaps to help in writing real
tests. We incorporate this with the testing suite so we only have to
implement the boilerplate code of setting up test fixtures once, and we
gain that it is now version controlled.</p>
<p>To select just the interactive tests (which just have a fixture and a
breakpoint) run:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>pytest -m interactive
</pre></div>
</div>
<p>To run automated tests:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>pytest -m <span class="s1">&#39;not interactive&#39;</span>
</pre></div>
</div>
<p>TODO: we will probably add more categories in the future for selecting
particular fixtures.</p>
<p>We are also using tox to test against different python versions. To test
against all of the versions they must be installed on the machine in a
directory here called `PREFIX`. To let tox see them they must be on
your path so run tox with a modified environment so we don’t have to
dingle with the path in an interactive shell and confuse ourselves:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>env <span class="nv">PATH</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$PREFIX</span><span class="s2">/bin:</span><span class="nv">$PATH</span><span class="s2">&quot;</span> tox
</pre></div>
</div>
<p>To install these different pythons download, unpack and build the python
configuring it to be installed to the prefix:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>wget <span class="s2">&quot;https://www.python.org/ftp/python/3.7.3/Python-3.7.3.tgz&quot;</span>
tar --extract -f Python-3.7.3
<span class="nb">cd</span> Python-3.7.3
./configure --prefix<span class="o">=</span><span class="nv">$PREFIX</span>
make -j <span class="m">8</span>
make install
</pre></div>
</div>
<p>To run tox for a specific environment check which environment names are
possible by looking in the `tox.ini` file:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>env <span class="nv">PATH</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$PREFIX</span><span class="s2">/bin:</span><span class="nv">$PATH</span><span class="s2">&quot;</span> tox -r -e py37
</pre></div>
</div>
<p>Where the `-r` option recreates it from scratch.</p>
</div>
<div class="section" id="code-quality">
<h3>Code Quality<a class="headerlink" href="#code-quality" title="Permalink to this headline">¶</a></h3>
<p>You can also lint the code with flake8:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>flake8 src/wepy wepy-tests
</pre></div>
</div>
<p>And get reports on the complexity of our code:</p>
<p>TODO</p>
</div>
<div class="section" id="profiling">
<h3>Profiling<a class="headerlink" href="#profiling" title="Permalink to this headline">¶</a></h3>
<p>We also have tests for profiling the performance sensitive parts of our
code.</p>
<p>You will need to install graphviz for this to get nice SVGs of the call
graphs. On ubuntu and debian:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sudo apt install -y graphviz
</pre></div>
</div>
</div>
<div class="section" id="testing-examples-and-tutorials">
<h3>Testing examples and tutorials<a class="headerlink" href="#testing-examples-and-tutorials" title="Permalink to this headline">¶</a></h3>
<p>We also want to make sure that the tutorials and examples work.</p>
<p>For this we want to emulate the experience of somebody installing it
from scratch and running the examples.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>wepy_test_user_install <span class="o">()</span> <span class="o">{</span>

    <span class="nv">package</span><span class="o">=</span><span class="s1">&#39;wepy&#39;</span>
    conda deactivate
    <span class="nv">install_env</span><span class="o">=</span><span class="s2">&quot;test-</span><span class="si">${</span><span class="nv">package</span><span class="si">}</span><span class="s2">-user-install&quot;</span>
    conda env remove -y -n <span class="s2">&quot;</span><span class="nv">$install_env</span><span class="s2">&quot;</span>
    conda create -y -n <span class="s2">&quot;</span><span class="nv">$install_env</span><span class="s2">&quot;</span> <span class="nv">python</span><span class="o">=</span><span class="m">3</span>
    conda activate <span class="s2">&quot;</span><span class="nv">$install_env</span><span class="s2">&quot;</span>
    conda install -y -c omnia openmm openmmtools
    pip install wepy<span class="o">[</span>all<span class="o">]==</span><span class="m">1</span>.0.0rc0
<span class="o">}</span>

wepy_test_user_master_install <span class="o">()</span> <span class="o">{</span>

    <span class="nv">package</span><span class="o">=</span><span class="s1">&#39;wepy_master&#39;</span>
    conda deactivate
    <span class="nv">install_env</span><span class="o">=</span><span class="s2">&quot;test-</span><span class="si">${</span><span class="nv">package</span><span class="si">}</span><span class="s2">-user-install&quot;</span>
    conda env remove -y -n <span class="s2">&quot;</span><span class="nv">$install_env</span><span class="s2">&quot;</span>
    conda create -y -n <span class="s2">&quot;</span><span class="nv">$install_env</span><span class="s2">&quot;</span> <span class="nv">python</span><span class="o">=</span><span class="m">3</span>
    conda activate <span class="s2">&quot;</span><span class="nv">$install_env</span><span class="s2">&quot;</span>
    conda install -y -c omnia openmm openmmtools
    pip install mdtraj
    pip install git+https://github.com/ADicksonLab/wepy.git
<span class="o">}</span>
</pre></div>
</div>
<ol class="arabic simple">
<li><p>Examples</p></li>
</ol>
</div>
<div class="section" id="writing-tests">
<h3>Writing Tests<a class="headerlink" href="#writing-tests" title="Permalink to this headline">¶</a></h3>
<p>If you add a feature ideally you should add some sort of test to make
sure it works.</p>
<p>We currently don’t do extensive tests at fine grained levels like unit
tests. Largely, I think these are a waste of time for a project like
wepy without a full time developer. These are welcome contributions
however, if anyone finds the time to write them.</p>
<p>Our tests do however try to do some basic integration tests where we
just try to build up and run simulations and perhaps run some analysis
routines just to make sure that your changes or new component can be run
without errors somewhere down the line.</p>
<p>Aside from the automated tests which get run by pytest there are a
number of other useful pieces of code that tend to be useful during the
development or perhaps maintenance cycle. This is a little different
from other repos I have seen, and perhaps adds a little bit of messiness
to the whole thing. It should add however, some value to dealing with
difficult and slippery problems that at least I have encountered in the
day to day of developing a project. Our goal is to have clear boundaries
for quarantining our messiness so that it doesn’t inevitably bleed into
the perfectly crystalline purity of the main code base. A complete lack
of messiness (IMO) is either a sign of immense maturity (unlikely) or
premature optimization. So we aim to start treating it as a first class
citizen.</p>
<p>These categories and the related folders are:</p>
<dl class="simple">
<dt>tests</dt><dd><p>Proper tests that would get run by pytest and your CI/CD pipeline</p>
</dd>
<dt>examples and mocks (harnesses)</dt><dd><p>Well-behaved “context” scripts for prototyping, bugfixing, and
showcasing how to accomplish very specific tasks.</p>
</dd>
<dt>troubleshooting</dt><dd><p>Misbehaved “context” scripts for broad domain problem solving. This
is more oriented towards improving the operation of the repo
tooling, how installations are failing, how builds are failing etc.</p>
</dd>
<dt>scrapyard</dt><dd><p>If you feel too much apprehension in burninating your lovely
prototype or script park it here to rust in peace.</p>
</dd>
</dl>
<p>The harnesses, troubleshooting, and scrapyard folders should be flat.
That means don’t nest directories for categorization, instead put it in
the file name. If you can use an org-mode file to contain explanations,
instructions, or multiple code blocks, please do so. It helps immensely
to have all of the necessary context in one artifact if possible. If you
absolutely must have more than one file (if you have config files small
inputs that must be read from the program to operate etc.) for the unit
go ahead and make a directory.</p>
<p>For data that should be stored in git LFS (large file storage) please
put them in either:</p>
<dl class="simple">
<dt>lfs-data</dt><dd><p>for the automatic ‘tests’ data. These are relied on being available
to run the tests and should be kept organized and clean.</p>
</dd>
<dt>lfs-misc</dt><dd><p>for all the files that are used by the harnesses, troubleshooting,
and scrapyard. Although try not to store large data at all for these
things, or when it is no longer need it remove them from the repo
and untrack with LFS.</p>
</dd>
</dl>
<ol class="arabic">
<li><p>Tests</p>
<p>This is the thing that most developers think of. Basically we run
pytests and you can write tests like you would for that, so go read
that documentation.</p>
<p>I do offer some insights into our focus however. Because we do not
have unit testing we focus more on building up a collection of useful
fixtures, which build on each other. This is to approximate some
integration testing where all the components must work to even get
the end product.</p>
<p>The favorite test system is the Lennard-Jones (lj) pair, for which we
can build a system with no input files, along with a dependency on
openmmtools.</p>
<p>The integration tests for this basically amount to just importing the
fixtures. If the fixture generation part works, then we just pass the
test.</p>
<p>We also have a series of special test cases which are tagged as
‘interactive’ (which also appears in the test name).</p>
</li>
<li><p>Harnesses</p>
<p>These are scripts and code blocks that build up a mock system or
“harness” to allow interactive prototyping. These should share code
through copy-paste. be independent, and never assumed to work how you
think. Usually you will use one of these for developing the feature
or component. These should not have a module structure and should be
copy-pastable into an IPython session or notebook and run using the
dev virtual environment. If you have explanations or other
instructions please put them into an org-mode document along with the
the script in a code block which can be copy-pasted or tangled.</p>
<p>Because, wepy doesn’t have config files and other such things you
should be able to put everything into a single python code block.
This is kind of the litmus test for whether it belongs in the
harnesses or not. If you have to set new virtual envs or do
reinstallations etc. your problem is in troubleshooting. The only
exception is if you are prototyping something that brings in a new
library, which should be rare for core wepy. If this is the case,
consider that you should be doing this in a separate repo. The idea
is that these code blocks should be runnable version to version and
the only thing that might break is the API calls.</p>
</li>
<li><p>Troubleshooting</p>
<p>Scripts and code block/prose for specific contexts that used for
problem solving. Ideally, once a troubleshooting problem is fixed
there should be no need for the file, so go ahead and remove it,
unless you suspect the problem will rear its ugly head again. These
contexts, typically are for pathological cases and as such may
involve tweaking environmental knobs like virtual envs, package
versions, OS env variables, etc. So you probably should be writing an
org mode file (or I guess markdown; whatever floats your boat) that
is very detailed in the process providing copy-pasted outputs from
your terminal etc. Try to include a date or commit that you are
working from so future devs know what to clean out based on how old
it is. If that is you don’t clean up your own mess.</p>
</li>
<li><p>Scrapyard</p>
<p>Really this is just a dumping ground for half-baked, forgotten, or
dead end things that never went anywhere. They can be prototypes,
deprecated modules, harnesses, troubleshooting scripts, anything. We
make no effort to organize anything in here at all. The idea is that
if you have this nagging feeling in the back of your mind that you
really shouldn’t completely delete that thing and lose it forever. Of
course if it is in the git history it is safe (sort of), but no one
goes digging in git history for parts and pieces, its more useful for
merging branches and recovering when things go horribly wrong.</p>
<p>That said don’t be offended if your old scrap pieces get deleted.
There are no naming conentions and there never should be here. If you
have “picked parts” they probably should go in harnesses.</p>
</li>
</ol>
</div>
</div>
<div class="section" id="contributing">
<h2>Contributing<a class="headerlink" href="#contributing" title="Permalink to this headline">¶</a></h2>
<p>TBD</p>
</div>
</div>
<div class="section" id="architecture">
<h1>Architecture<a class="headerlink" href="#architecture" title="Permalink to this headline">¶</a></h1>
<div class="section" id="record-groups">
<h2>Record Groups<a class="headerlink" href="#record-groups" title="Permalink to this headline">¶</a></h2>
<p>The protocol by which non-trajectory data is given by the resampler and
boundary conditions (BC) is unified that makes it simpler to save in
formats like HDF5.</p>
<p>The resampler and BC both have multiple record groups:</p>
<ul class="simple">
<li><p>resampler</p>
<ul>
<li><p>resampling</p></li>
<li><p>resampler</p></li>
</ul>
</li>
<li><p>BC</p>
<ul>
<li><p>warping</p></li>
<li><p>progress</p></li>
<li><p>boundary conditions</p></li>
</ul>
</li>
</ul>
<p>A record group can be thought of as a single table in a relational
database. Each record group corresponds to a class of events that occur
and each record in a record group corresponds to one event.</p>
<p>Record groups can be <strong>continual</strong> or <strong>sporadic</strong>.</p>
<p>A continual record is recorded once per cycle. A continual record
reports on the event of a cycle.</p>
<p>A sporadic record can be reported 0 or many times per cycle and responds
to the event determined by the record group.</p>
<ul class="simple">
<li><p>continual</p>
<ul>
<li><p>progress</p></li>
</ul>
</li>
<li><p>sporadic</p>
<ul>
<li><p>resampler</p></li>
<li><p>resampling</p></li>
<li><p>warping</p></li>
<li><p>boundary conditions</p></li>
</ul>
</li>
</ul>
<p>As you can see currently most records are sporadic. This distinction is
really only used internally within the <code class="docutils literal notranslate"><span class="pre">WepyHDF5</span></code> class to distinguish
how it stores them, but this distinction is useful in data analysis as
well.</p>
<p>Resampling Records</p>
<p>The =’resampling’= records are probably the most important records for
<code class="docutils literal notranslate"><span class="pre">wepy</span></code> because they are what records the cloning and merging of
walkers.</p>
<p>Without the =’resampling’= your <code class="docutils literal notranslate"><span class="pre">wepy</span></code> simulation would have been
wasted since you no longer will know the history of any given frame. You
will just have a bag full of unconnected pictures.</p>
<p>Records for =’resampling’= happen for each “assignment” event of a
walker during resampling, this minimally should contain two fields:
=’decision<sub>id</sub>’= and =’target<sub>idxs</sub>’=.</p>
<p>The =’decision<sub>id</sub>’= is an integer corresponding to an
enumeration of the possible decisions that can be made as to the fate of
the walker during resampling. While technically these decisions are also
modular it is likely that 99.9% of all users will use the
<code class="docutils literal notranslate"><span class="pre">CloneMergeDecision</span></code>.</p>
<p>Detailed knowledge of this formalism is not usually needed in the
practice of writing resamplers that behave well, which is another topic,
and the next few paragraphs can be safely skipped.</p>
<p>The enumerated decisions in this are:</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 78%" />
<col style="width: 22%" />
</colgroup>
<tbody>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">NOTHING</span></code></p></td>
<td><p>1</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">CLONE</span></code></p></td>
<td><p>2</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">SQUASH</span></code></p></td>
<td><p>3</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">KEEP_MERGE</span></code></p></td>
<td><p>4</p></td>
</tr>
</tbody>
</table>
<p>The <code class="docutils literal notranslate"><span class="pre">NOTHING</span></code> decision means don’t clone or merge this walker.</p>
<p><code class="docutils literal notranslate"><span class="pre">CLONE</span></code> means clone this walker.</p>
<p><code class="docutils literal notranslate"><span class="pre">SQUASH</span></code> and <code class="docutils literal notranslate"><span class="pre">KEEP_MERGE</span></code> are related in that both involve merging.</p>
<p>A single merge includes a set of walkers that will be merged together,
there must be at least 2 such walkers in this “merge group”.</p>
<p>From the merge group only a single <em>state</em> will be preserved in the
single resulting walker, while the weight of the final walker will be
the sum of all those walkers.</p>
<p>The state of the final walker will be drawn from the set of walkers in
the merge group based on the behavior of the resampler (usually a choice
weighted by their weights), but will always be identical to one of the
walkers. The walker with the chosen state is the <code class="docutils literal notranslate"><span class="pre">KEEP_MERGE</span></code> walker.
The rest are the <code class="docutils literal notranslate"><span class="pre">SQUASH</span></code> walkers.</p>
<p>The second field, =’target<sub>idxs</sub>’=, actually determines which
walkers will be merged with what other walkers, and is a tuple of
integers indicating the location, or slot.</p>
<p>A ‘slot’ is simply an available position in the lineup of walkers that
will be simulated in a single cycle of WE. The number of slots is the
number of walkers that will be simulated in the next cycle.</p>
<p>As an aside: In general the number of walkers used in a WE simulation is
not specified (other than there needs to be more than 1). You can have a
constant number of walkers, or a dynamic one with the number fluctuating
during the simulation.</p>
<p>If you have too small a number of walkers then you will have a
relatively sparse coverage of the sample space.</p>
<p>If you have too many the cycle throughput will be very slow.</p>
<p>Additionally, simulations run with GPUs will want to have a number of
walkers each cycle that is a multiple of the number of GPUs or a number
of the GPUs will be lying idle when the task queue of running walker
runner segments is depleted.</p>
<p>So typically there is some constraint on the the number of slots
available in the next WE cycle. The constraint is decided on and
enforced by the resampler. So if there is a mismatch in the resampling
records and the walkers produced the <code class="docutils literal notranslate"><span class="pre">wepy</span></code> simulation manager will
not complain.</p>
<p>WARNING: Currently the <code class="docutils literal notranslate"><span class="pre">WepyHDF5</span></code> storage backend and reporter do not
support dynamic numbers of simulations. While technically the none of
the other code has any problem with this.</p>
<p>The =’target<sub>idxs</sub>’= value for <code class="docutils literal notranslate"><span class="pre">NOTHING</span></code> and <code class="docutils literal notranslate"><span class="pre">KEEP_MERGE</span></code> is
a 1-tuple of the integer index of slot where the resultant walker will
be placed.</p>
<p>The =’target<sub>idxs</sub>’= for <code class="docutils literal notranslate"><span class="pre">CLONE</span></code> is an n-tuple of integer
indices of slots where n is the number of children of the clone and n
must be at least 2 (or it would’ve been a <code class="docutils literal notranslate"><span class="pre">NOTHING</span></code>).</p>
<p>The =’target<sub>idxs</sub>’= of <code class="docutils literal notranslate"><span class="pre">SQUASH</span></code> is also a 1-tuple like
<code class="docutils literal notranslate"><span class="pre">NOTHING</span></code> except since a <code class="docutils literal notranslate"><span class="pre">SQUASH</span></code> has no child it indicates the
<code class="docutils literal notranslate"><span class="pre">KEEP_MERGE</span></code> walker that it’s weight is added to. Note that this slot
index is the slot index that the <code class="docutils literal notranslate"><span class="pre">KEEP_MERGE</span></code> record itself specifies
and not the slot the <code class="docutils literal notranslate"><span class="pre">KEEP_MERGE</span></code> walker previously occupied (as that
index is of no consequence to the current collection of walkers).</p>
<p>Thus a <code class="docutils literal notranslate"><span class="pre">KEEP_MERGE</span></code> walker defines a single merge group, and the
members of that merge group are given by which <code class="docutils literal notranslate"><span class="pre">SQUASH</span></code> targets.</p>
<p>Critically, the =’step<sub>idx</sub>’= and =’walker<sub>idx</sub>’= (slot
index of walker in last cycle) fields should also be supplied so that
the lineage histories can be generated.</p>
<p>In addition to the Decision class record fields any other amount of data
can be attached to these records to report on a resampling event.</p>
<p>For example in the WExplore resampler the region the walker was assigned
to is also given.</p>
<p>Warping Records</p>
<p>The next most important record is the warping records.</p>
<p>These are of course only relevant if you are using boundary conditions,
but among the three BC these are the principal object.</p>
<p>Warping records determine the action that was taken on a walker after it
met the criteria for a boundary condition event.</p>
<p>Minimally it should specify the =’walker<sub>idx</sub>’= that was acted
on, and if any warping event can be discontinuous the ‘weight’ of it so
this can be accounted for in analysis.</p>
<p>The rest of the specification for boundary conditions does not have a
protocol similar to the one for cloning and merging records and is left
up to the developer of the class to decide.</p>
<p>For simple boundary conditions where there is only one result an
additional field is not even necesary.</p>
<p>The colored trajectories examples provides a possible example. In this
case you could have a field called =’color’= which is the new “color” of
the walker which indicates the last boundary it crossed and could be a
string or an integer enumeration.</p>
<p>Boundary Condition Records</p>
<p>This and all the other record groups are really optional.</p>
<p>A single boundary condition record reports on the event of a change in
the state of the boundary condition object.</p>
<p>For example if the cutoff value for a ligand unbinding boundary
condition changes during a simulation.</p>
<p>Resampler Records</p>
<p>These records report on events changing of the state of the resampler.</p>
<p>For example in WExplore a single record is generated every time a new
region/image is defined giving details on the values that triggered this
event as well as the image that was created.</p>
<p>This interpretation is semantically useful but in practice this reporter
could also report on collective attributes of the walkers, such as
all-to-all distances or histograms of the current batch of walkers.</p>
<p>Its up to the writer of the resampler to decide.</p>
<p>Progress Records</p>
<p>Progress records are provided mainly as a convenience to get on-line
data analysis of walkers during a simulation.</p>
<p>For instance in ligand unbinding the progress may be the distance to the
cutoff, or RMSD to the original state.</p>
<p>While the active observer may note that these calculations may also have
been implemented in a reporter as well.</p>
<p>There are a few tradeoffs for that approach though.</p>
<p>One, the value may have already been calculated in the process of
evaluating walkers for warping and double calculation is potentially
unacceptably wasteful (although one might imagine complex systems where
reporters perform their actions asynchronously to the flow of the
simulation manager moving onto new cycles).</p>
<p>Second, the flow of data will be forked. For example when using the
<code class="docutils literal notranslate"><span class="pre">WepyHDF5Reporter</span></code> all the data it will report on is assumed to be
contained in records returned by the runner, resampler, and boundary
conditions and can’t know of another reporter. Nor is it easy nor wise
to have two reporters acting on the same database.</p>
<p>Perhaps such analysis could be implemented as analysis submodules in the
<code class="docutils literal notranslate"><span class="pre">WepyHDF5Reporter</span></code> to keep a single stream of data, if you think that
way go ahead and make a pull request.</p>
<div class="section" id="specifying-record-group-fields">
<h3>Specifying Record Group Fields<a class="headerlink" href="#specifying-record-group-fields" title="Permalink to this headline">¶</a></h3>
<p>Each record group should have three class constants defined for it.</p>
<p>This is strictly not necessary from the perspective of either the
simulation manager or the primary consumer of these records, the
<code class="docutils literal notranslate"><span class="pre">WepyHDF5Reporter</span></code>, but is a very good practice as it will help catch
bugs and will clarify the results your BC or resampler will produce for
those inspecting them.</p>
<p>The three definitions are:</p>
<ul class="simple">
<li><p>field names</p></li>
<li><p>shapes</p></li>
<li><p>dtypes</p></li>
</ul>
<p>Each should be defined as a class constant prefixed by the name of the
record group followed by the definition type, for example the resampling
record group of WExplore looks like this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">DECISION</span> <span class="o">=</span> <span class="n">MultiCloneMergeDecision</span>
<span class="n">RESAMPLING_FIELDS</span> <span class="o">=</span> <span class="n">DECISION</span><span class="o">.</span><span class="n">FIELDS</span> <span class="o">+</span> <span class="p">(</span><span class="s1">&#39;step_idx&#39;</span><span class="p">,</span> <span class="s1">&#39;walker_idx&#39;</span><span class="p">,</span> <span class="s1">&#39;region_assignment&#39;</span><span class="p">,)</span>
<span class="n">RESAMPLING_SHAPES</span> <span class="o">=</span> <span class="n">DECISION</span><span class="o">.</span><span class="n">SHAPES</span> <span class="o">+</span> <span class="p">((</span><span class="mi">1</span><span class="p">,),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,),</span> <span class="bp">Ellipsis</span><span class="p">,)</span>
<span class="n">RESAMPLING_DTYPES</span> <span class="o">=</span> <span class="n">DECISION</span><span class="o">.</span><span class="n">DTYPES</span> <span class="o">+</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">,)</span>
</pre></div>
</div>
<p>For the “fields” this is the name of the field and should be a string.
In the example we are using fields defined from the
<code class="docutils literal notranslate"><span class="pre">MultiCloneMergeDecision</span></code> class.</p>
<p>The shapes are the expected shapes of a single element of the field.
Three types of values are accepted here:</p>
<ol class="upperalpha simple">
<li><p>A tuple of ints that specify the shape of the field element array.</p></li>
</ol>
<p>B. Ellipsis, indicating that the field is variable length and limited to
being a rank one array (e.g. <code class="docutils literal notranslate"><span class="pre">(3,)</span></code> or <code class="docutils literal notranslate"><span class="pre">(1,)</span></code>).</p>
<p>C. None, indicating that the first instance of this field will not be
known until runtime. Any field that is returned by a record producing
method will automatically interpreted as None if not specified here.</p>
<p>Note that the shapes must be tuple and not simple integers for rank-1
arrays.</p>
<p>It is suggested that if possible use option A. Option B will use a
special datatype in HDF5 for variable length datasets that can only be 1
dimensional, in addition to being much less efficient to store.</p>
<p>Option C is not advisable but is there because I know people will be
lazy and not want to define all these things. By defining things ahead
of time you will reduce errors by catching differences in what you
expect a field to look like and what you actually receive at runtime.</p>
<p>If you are actually saving the wrong thing and don’t specify the shape
and dtype then you may run weeks of simulations and never realize you
never saved the right thing there.</p>
<p>The dtypes have similar options but there is no Ellipsis option.</p>
<p>Each non-None dtype should be a numpy dtype object. This is necessary
for serializing the datatype to the HDF5 (using the
<code class="docutils literal notranslate"><span class="pre">numpy.dtype.descr</span></code> attribute).</p>
</div>
<div class="section" id="record-fields">
<h3>Record Fields<a class="headerlink" href="#record-fields" title="Permalink to this headline">¶</a></h3>
<p>One additional class constant can be defined to make analysis in the
future easier.</p>
<p>When accessing records from a <code class="docutils literal notranslate"><span class="pre">WepyHDF5</span></code> object you can automatically
generate <code class="docutils literal notranslate"><span class="pre">pandas.DataFrames</span></code> from the records, which will select from
a subset of the fields for a record group. This is because large arrays
don’t fit well into tables!</p>
<p>So you can define a subset of fields to be used as a nice “table” report
that could be serialized to CSV. For instance in WExplore’s resampler
record group we leave out the multidimensional =’image’= field:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">RESAMPLER_FIELDS</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;branching_level&#39;</span><span class="p">,</span> <span class="s1">&#39;distance&#39;</span><span class="p">,</span> <span class="s1">&#39;new_leaf_id&#39;</span><span class="p">,</span> <span class="s1">&#39;image&#39;</span><span class="p">)</span>
<span class="n">RESAMPLER_SHAPES</span> <span class="o">=</span> <span class="p">((</span><span class="mi">1</span><span class="p">,),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,),</span> <span class="bp">Ellipsis</span><span class="p">,</span> <span class="bp">Ellipsis</span><span class="p">)</span>
<span class="n">RESAMPLER_DTYPES</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

<span class="c1"># fields that can be used for a table like representation</span>
<span class="n">RESAMPLER_RECORD_FIELDS</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;branching_level&#39;</span><span class="p">,</span> <span class="s1">&#39;distance&#39;</span><span class="p">,</span> <span class="s1">&#39;new_leaf_id&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Again, its not necessary, but its there to use.</p>
</div>
</div>
</div>


          </div>
            
  <div class="footer-relations">
    
      <div class="pull-left">
        <a class="btn btn-default" href="troubleshooting.html" title="previous chapter (use the left arrow)">Common Troubleshooting</a>
      </div>
    
      <div class="pull-right">
        <a class="btn btn-default" href="glossary.html" title="next chapter (use the right arrow)">Glossary</a>
      </div>
    </div>
    <div class="clearer"></div>
  
        </div>
        <div class="clearfix"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="glossary.html" title="Glossary"
             >next</a> |</li>
        <li class="right" >
          <a href="troubleshooting.html" title="Common Troubleshooting"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">wepy  documentation</a> &#187;</li> 
      </ul>
    </div>
<script type="text/javascript">
  $("#mobile-toggle a").click(function () {
    $("#left-column").toggle();
  });
</script>
<script type="text/javascript" src="../_static/js/bootstrap.js"></script>
  <div class="footer">
    &copy; Copyright 2018, Samuel D. Lotz. Created using <a href="http://sphinx.pocoo.org/">Sphinx</a>.
  </div>
  </body>
</html>